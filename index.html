<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Á∫ØÁ∫ØÂÜô‰Ωú ¬∑ Â∞èËØ¥Âàõ‰ΩúÂ∑•‰ΩúÂè∞</title>
    <style>
        :root {
            --sidebar-width: 300px;
            --primary-color: #4a86e8;
            --text-color: #222;
            --muted-text: #666;
            --bg-color: #f7f8fa;
            --panel-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 2px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 6px 18px rgba(0,0,0,0.08);
            --accent: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --link: #2563eb;
            --editor-width: 780px;
            --tree-indent: 18px;
            --hover-bg: rgba(127,127,127,0.06);
            --active-bg: rgba(74,134,232,0.12);
            --mobile-bar-height: 56px;
        }

        [data-theme="dark"] {
            --primary-color: #6ea8fe;
            --text-color: #e5e7eb;
            --muted-text: #9ca3af;
            --bg-color: #0f1116;
            --panel-bg: #161a23;
            --border-color: #262a36;
            --shadow-sm: 0 2px 6px rgba(0,0,0,0.35);
            --shadow-md: 0 6px 18px rgba(0,0,0,0.35);
            --accent: #34d399;
            --danger: #f87171;
            --warning: #f59e0b;
            --link: #93c5fd;
            --hover-bg: rgba(255,255,255,0.05);
            --active-bg: rgba(110,168,254,0.15);
        }

        [data-theme="sepia"] {
            --primary-color: #8b5e34;
            --text-color: #3e2c1c;
            --muted-text: #7b6a58;
            --bg-color: #f3ead7;
            --panel-bg: #faf3e3;
            --border-color: #e1d7c6;
            --accent: #9c6f3d;
            --warning: #c48f3c;
            --link: #7a4e2b;
            --hover-bg: rgba(139,94,52,0.07);
            --active-bg: rgba(139,94,52,0.12);
        }

        [data-theme="solar"] {
            --primary-color: #1f6feb;
            --text-color: #24292f;
            --muted-text: #57606a;
            --bg-color: #f6f8fa;
            --panel-bg: #ffffff;
            --border-color: #d0d7de;
            --accent: #2da44e;
            --warning: #bf8700;
            --link: #0969da;
            --hover-bg: rgba(31,111,235,0.06);
            --active-bg: rgba(31,111,235,0.12);
        }

        [data-theme="night"] {
            --primary-color: #7aa2f7;
            --text-color: #c0caf5;
            --muted-text: #a9b1d6;
            --bg-color: #0b1020;
            --panel-bg: #101425;
            --border-color: #1f2540;
            --accent: #2ac3de;
            --warning: #ffc777;
            --link: #7dcfff;
            --hover-bg: rgba(255,255,255,0.04);
            --active-bg: rgba(122,162,247,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        }

        html, body { height: 100%; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.28s ease;
            z-index: 40;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo { width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, var(--primary-color), #7cc5ff); box-shadow: var(--shadow-sm); }
        .sidebar-title { font-size: 1.05rem; font-weight: 700; letter-spacing: 0.4px; color: var(--primary-color); }

        .sidebar-actions { margin-left: auto; display: flex; gap: 8px; }
        .icon-btn { background: none; border: 1px solid transparent; color: var(--muted-text); cursor: pointer; border-radius: 8px; padding: 6px 8px; transition: all 0.15s ease; }
        .icon-btn:hover { background-color: var(--hover-bg); border-color: var(--border-color); }

        .sidebar-search { padding: 10px 12px; border-bottom: 1px solid var(--border-color); display: flex; gap: 8px; }
        .search-input { flex: 1; border: 1px solid var(--border-color); background: transparent; border-radius: 8px; padding: 8px 10px; color: var(--text-color); }
        .search-input:focus { outline: 2px solid rgba(74,134,232,0.25); }

        .sidebar-menu { padding: 6px 0 8px 0; overflow: hidden auto; flex: 1; }
        .menu-section-title { font-size: 12px; color: var(--muted-text); padding: 8px 16px; text-transform: uppercase; letter-spacing: 1.2px; }

        /* Tree */
        .tree { padding: 6px 6px 16px 6px; }
        .tree-root-drop { margin: 0 10px 8px 10px; padding: 6px 8px; border-radius: 6px; color: var(--muted-text); border: 1px dashed var(--border-color); font-size: 12px; }
        .tree-root-drop.dragover { background: var(--active-bg); }

        .folder-node, .doc-node { position: relative; display: flex; align-items: center; gap: 8px; padding: 8px 8px 8px 10px; border-radius: 8px; margin: 2px 6px; }
        .folder-node:hover, .doc-node:hover { background: var(--hover-bg); }
        .doc-node.active { background: var(--active-bg); }
        .indent { width: var(--tree-indent); flex: 0 0 var(--tree-indent); height: 1px; }
        .caret { width: 16px; text-align: center; cursor: pointer; color: var(--muted-text); }
        .folder-title { font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .doc-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .node-actions { display: flex; gap: 6px; }
        .node-actions .icon-btn { padding: 4px 6px; border-radius: 6px; }
        .children { margin-left: calc(var(--tree-indent) + 8px); }
        .drop-target { outline: 2px dashed var(--primary-color); }
        .drop-before::before, .drop-after::after { content: ""; position: absolute; left: 8px; right: 8px; height: 0; border-top: 2px solid var(--primary-color); }
        .drop-before::before { top: -1px; }
        .drop-after::after { bottom: -1px; }

        .sidebar-footer { border-top: 1px solid var(--border-color); padding: 10px 12px; display: flex; gap: 10px; }
        .primary-btn { background: var(--primary-color); color: #fff; border: none; padding: 8px 10px; border-radius: 8px; cursor: pointer; box-shadow: var(--shadow-sm); }
        .primary-btn:hover { filter: brightness(1.05); }

        /* Main */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; }

        .toolbar { display: grid; grid-template-columns: auto 1fr auto auto; align-items: center; gap: 10px; padding: 10px 14px; background-color: var(--panel-bg); border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 30; }
        .menu-toggle { background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 6px; color: var(--muted-text); }

        .title-input { width: 100%; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 10px; background: transparent; color: var(--text-color); font-size: 1rem; font-weight: 600; }
        .title-input:focus { outline: 2px solid rgba(74,134,232,0.25); }

        .toolbar-actions { display: flex; gap: 8px; align-items: center; }
        .toolbar-btn { background: none; border: 1px solid var(--border-color); border-radius: 8px; padding: 6px 8px; cursor: pointer; color: var(--muted-text); }
        .toolbar-btn:hover { background: var(--hover-bg); }

        #editor-wrapper { display: flex; justify-content: center; width: 100%; }
        #editor { width: min(100%, var(--editor-width)); margin: 24px 16px; padding: 18px; font-size: 1.02rem; line-height: 1.7; background-color: var(--panel-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: var(--shadow-md); min-height: 58vh; resize: vertical; }
        #editor:focus { outline: 3px solid rgba(74,134,232,0.15); border-color: rgba(74,134,232,0.4); }

        .word-count { padding: 10px 14px; background-color: var(--panel-bg); border-top: 1px solid var(--border-color); font-size: 0.92rem; color: var(--muted-text); display: flex; gap: 14px; align-items: center; }
        .goal { display: flex; align-items: center; gap: 8px; }
        .progress-bar { width: 180px; height: 8px; border-radius: 6px; background: rgba(127,127,127,0.12); overflow: hidden; border: 1px solid var(--border-color); }
        .progress { height: 100%; background: linear-gradient(90deg, var(--accent), #2dd4bf); width: 0%; }
        .save-indicator { margin-left: auto; font-size: 12px; color: var(--muted-text); }

        /* Overlays */
        #sidebar-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.35); z-index: 20; display: none; }
        #drawerOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; z-index: 60; }

        /* Focus mode */
        body.focus-mode #sidebar { display: none; }
        body.focus-mode .toolbar { opacity: 0.1; pointer-events: none; }
        body.focus-mode #editor { margin-top: 6vh; min-height: 76vh; }

        /* Settings Drawer */
        #settingsDrawer { position: fixed; top: 0; right: 0; height: 100%; width: 340px; background: var(--panel-bg); border-left: 1px solid var(--border-color); box-shadow: var(--shadow-md); transform: translateX(100%); transition: transform 0.25s ease; z-index: 70; display: flex; flex-direction: column; }
        #settingsDrawer.show { transform: translateX(0); }
        .drawer-header { padding: 14px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; font-weight: 700; }
        .drawer-body { padding: 12px 16px; overflow: auto; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 12px; color: var(--muted-text); }
        .radio-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .chip { border: 1px solid var(--border-color); padding: 6px 10px; border-radius: 999px; cursor: pointer; background: transparent; color: var(--text-color); }
        .chip.active { background: var(--active-bg); border-color: var(--primary-color); }
        .num-input { width: 120px; border: 1px solid var(--border-color); background: transparent; color: var(--text-color); padding: 6px 8px; border-radius: 8px; }

        /* Snackbar */
        #snackbar { position: fixed; left: 50%; bottom: calc(16px + env(safe-area-inset-bottom)); transform: translateX(-50%); background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 999px; padding: 10px 14px; box-shadow: var(--shadow-md); display: none; align-items: center; gap: 10px; z-index: 80; }
        #snackbar.show { display: inline-flex; animation: fadeup 180ms ease; }
        #snackbar .snack-action { color: var(--primary-color); cursor: pointer; }
        @keyframes fadeup { from { opacity: 0; transform: translate(-50%, 8px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* Move-To Sheet */
        #sheetOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; z-index: 65; }
        #moveSheet { position: fixed; left: 0; right: 0; bottom: 0; background: var(--panel-bg); border-top: 1px solid var(--border-color); border-radius: 14px 14px 0 0; box-shadow: var(--shadow-md); transform: translateY(100%); transition: transform 0.25s ease; z-index: 70; }
        #moveSheet.show { transform: translateY(0); }
        .sheet-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; font-weight: 700; }
        .sheet-body { max-height: 48vh; overflow: auto; padding: 8px 8px calc(8px + env(safe-area-inset-bottom)); }
        .sheet-row { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 8px; margin: 4px 8px; cursor: pointer; }
        .sheet-row:hover { background: var(--hover-bg); }
        .sheet-indent { width: 14px; }

        /* Mobile Toolbar */
        #mobileBar { position: fixed; left: 0; right: 0; bottom: 0; height: calc(var(--mobile-bar-height) + env(safe-area-inset-bottom)); background: var(--panel-bg); border-top: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: none; z-index: 55; padding-bottom: env(safe-area-inset-bottom); }
        #mobileBar .row { height: var(--mobile-bar-height); display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; padding: 6px; }
        #mobileBar .m-btn { border: 1px solid var(--border-color); background: transparent; color: var(--text-color); border-radius: 10px; font-size: 15px; }
        #mobileBar .m-btn:active { background: var(--hover-bg); }

        /* Responsive */
        @media (max-width: 1024px) { :root { --sidebar-width: 260px; --editor-width: 680px; } }
        @media (max-width: 768px) {
            #sidebar { position: fixed; transform: translateX(-100%); }
            #sidebar.show { transform: translateX(0); }
            #sidebar-overlay { display: block; opacity: 0; transition: opacity 0.28s ease; pointer-events: none; }
            #sidebar.show + #main-container #sidebar-overlay { opacity: 1; pointer-events: auto; }
            :root { --editor-width: 100%; }
            .toolbar { grid-template-columns: auto 1fr auto; gap: 6px; }
            #settingsDrawer { width: 92vw; }
            #mobileBar { display: block; }
            #editor { padding-bottom: calc(18px + var(--mobile-bar-height) + env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="sidebar-header">
            <div class="logo"></div>
            <div class="sidebar-title">Á∫ØÁ∫ØÂÜô‰Ωú</div>
            <div class="sidebar-actions">
                <button id="settingsBtn" class="icon-btn" title="ËÆæÁΩÆ">‚öôÔ∏è</button>
                <button id="themeToggle" class="icon-btn" title="ÂàáÊç¢ÊòéÊöó">üåó</button>
                <button id="focusToggle" class="icon-btn" title="‰∏ìÊ≥®Ê®°Âºè">üéØ</button>
            </div>
        </div>
        <div class="sidebar-search">
            <input id="searchInput" class="search-input" placeholder="ÊêúÁ¥¢ÊñáÊ°£ (‚åò/Ctrl K)">
            <button id="newDocBtn" class="primary-btn" title="Êñ∞Âª∫ÊñáÊ°£">Ôºã</button>
            <button id="newNovelBtn" class="toolbar-btn" title="Êñ∞Âª∫Â∞èËØ¥">üìö</button>
            <button id="newFolderBtn" class="toolbar-btn" title="Êñ∞Âª∫Êñá‰ª∂Â§π">üìÅÔºã</button>
        </div>
        <div class="menu-section-title">ÁõÆÂΩï</div>
        <div id="docList" class="doc-list">
            <div id="tree" class="tree"></div>
        </div>
        <div class="sidebar-footer">
            <button id="importBtn" class="toolbar-btn" title="ÂØºÂÖ• .txt">üì• ÂØºÂÖ•</button>
            <input id="importFile" type="file" accept=".txt,.md,text/plain" style="display:none">
        </div>
    </aside>

    <div id="main-container">
        <div id="sidebar-overlay"></div>
        <div class="toolbar">
            <button class="menu-toggle" id="menuToggle" title="ÊòæÁ§∫/ÈöêËóè‰æßËæπÊ†è">‚ò∞</button>
            <input type="text" id="titleInput" class="title-input" placeholder="Êó†Ê†áÈ¢òÊñáÊ°£">
            <div class="toolbar-actions">
                <div class="divider"></div>
                <div class="format-bar">
                    <button class="toolbar-btn" id="tplPerson" title="ÊèíÂÖ•‰∫∫Áâ©Âç°">üßë‚Äçüé§</button>
                    <button class="toolbar-btn" id="tplScene" title="ÊèíÂÖ•Âú∫ÊôØÂç°">üèûÔ∏è</button>
                    <button class="toolbar-btn" id="tplWorld" title="ÊèíÂÖ•‰∏ñÁïåËßÇ">üåç</button>
                </div>
                <div class="divider"></div>
                <button class="toolbar-btn" id="exportTxt" title="ÂØºÂá∫ .txt">üì§ TXT</button>
                <button class="toolbar-btn" id="exportMd" title="ÂØºÂá∫ .md">üì§ MD</button>
                <div class="save-indicator" id="saveIndicator">Â∑≤‰øùÂ≠ò</div>
            </div>
        </div>

        <div id="editor-wrapper">
            <textarea id="editor" spellcheck="false" placeholder="ÂºÄÂßãÂàõ‰Ωú‚Ä¶‚Ä¶"></textarea>
        </div>

        <div class="word-count">
            <div>Â≠óÊï∞Ôºö<span id="charCount">0</span></div>
            <div>ÊÆµËêΩÔºö<span id="paraCount">0</span></div>
            <div class="goal">
                ‰ªäÊó•ÁõÆÊ†áÔºö<span id="goalNum">1000</span>
                <div class="progress-bar"><div id="goalProgress" class="progress"></div></div>
                <span id="goalNow">0</span>
                <button id="setGoalBtn" class="toolbar-btn" title="ËÆæÁΩÆÁõÆÊ†á">‚öôÔ∏è</button>
            </div>
        </div>
    </div>

    <!-- Settings Drawer -->
    <div id="drawerOverlay"></div>
    <aside id="settingsDrawer">
        <div class="drawer-header">
            <span>ÂÖ®Â±ÄËÆæÁΩÆ</span>
            <button id="closeDrawer" class="icon-btn">‚úñ</button>
        </div>
        <div class="drawer-body">
            <div class="form-group">
                <label>‰∏ªÈ¢ò</label>
                <div class="radio-row" id="themeChips">
                    <button class="chip" data-theme="light">Êòé‰∫Æ</button>
                    <button class="chip" data-theme="dark">ÊöóÈªë</button>
                    <button class="chip" data-theme="sepia">‰ªøÂè§</button>
                    <button class="chip" data-theme="solar">Ê∏ÖÊúó</button>
                    <button class="chip" data-theme="night">Â§úËìù</button>
                </div>
            </div>
            <div class="form-group">
                <label>‰ªäÊó•ÁõÆÊ†áÂ≠óÊï∞</label>
                <input id="goalInput" class="num-input" type="number" min="0" step="100" placeholder="1000">
            </div>
            <div class="form-group">
                <label>ÁïåÈù¢ÂØÜÂ∫¶</label>
                <div class="radio-row" id="densityChips">
                    <button class="chip" data-density="comfortable">ËàíÈÄÇ</button>
                    <button class="chip" data-density="compact">Á¥ßÂáë</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Move-To Sheet -->
    <div id="sheetOverlay"></div>
    <aside id="moveSheet">
        <div class="sheet-header">
            <span>ÁßªÂä®Âà∞</span>
            <button id="closeMoveSheet" class="icon-btn">‚úñ</button>
        </div>
        <div id="moveSheetBody" class="sheet-body"></div>
    </aside>

    <!-- Snackbar -->
    <div id="snackbar"><span id="snackMsg"></span><span id="snackAction" class="snack-action"></span></div>

    <!-- Mobile Toolbar -->
    <nav id="mobileBar">
        <div class="row">
            <button class="m-btn" id="mPerson">‰∫∫Áâ©</button>
            <button class="m-btn" id="mScene">Âú∫ÊôØ</button>
            <button class="m-btn" id="mWorld">‰∏ñÁïå</button>
            <button class="m-btn" id="mNewDoc">Êñ∞Âª∫</button>
            <button class="m-btn" id="mFocus">üéØ</button>
            <button class="m-btn" id="mSettings">‚öôÔ∏è</button>
        </div>
    </nav>

    <script>
        // Utilities
        function $(sel) { return document.querySelector(sel); }
        function $all(sel) { return Array.from(document.querySelectorAll(sel)); }
        function createEl(tag, cls) { const el = document.createElement(tag); if (cls) el.className = cls; return el; }
        function debounce(fn, wait) { let t; return function(...args){ clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); }; }
        function throttleRaf(fn) { let ticking = false; return function(...args){ if (ticking) return; ticking = true; requestAnimationFrame(() => { fn.apply(this, args); ticking = false; }); }; }
        function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
        function todayKey() { const d = new Date(); return d.toISOString().slice(0,10); }

        // Storage
        const STORAGE_KEYS = {
            DOCS: 'novelDocs',
            FOLDERS: 'novelFolders',
            FOLDER_STATE: 'novelFolderState',
            CURRENT_ID: 'currentDocId',
            THEME: 'theme',
            GOAL: 'dailyGoal',
            PROGRESS: 'dailyProgress',
            DENSITY: 'uiDensity'
        };
        function loadDocs() { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.DOCS) || '[]'); } catch { return []; } }
        function saveDocs(v) { localStorage.setItem(STORAGE_KEYS.DOCS, JSON.stringify(v)); }
        function loadFolders() { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.FOLDERS) || '[]'); } catch { return []; } }
        function saveFolders(v) { localStorage.setItem(STORAGE_KEYS.FOLDERS, JSON.stringify(v)); }
        function loadFolderState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.FOLDER_STATE) || '{}'); } catch { return {}; } }
        function saveFolderState(v) { localStorage.setItem(STORAGE_KEYS.FOLDER_STATE, JSON.stringify(v)); }
        function getCurrentId() { return localStorage.getItem(STORAGE_KEYS.CURRENT_ID); }
        function setCurrentId(id) { localStorage.setItem(STORAGE_KEYS.CURRENT_ID, id); }
        function generateId(prefix='id') { return prefix + '_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
        function loadTheme() { return localStorage.getItem(STORAGE_KEYS.THEME) || 'light'; }
        function saveTheme(theme) { localStorage.setItem(STORAGE_KEYS.THEME, theme); }
        function loadGoal() { const n = parseInt(localStorage.getItem(STORAGE_KEYS.GOAL) || '1000', 10); return Number.isFinite(n) ? n : 1000; }
        function saveGoal(n) { localStorage.setItem(STORAGE_KEYS.GOAL, String(n)); }
        function loadProgressMap() { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.PROGRESS) || '{}'); } catch { return {}; } }
        function saveProgressMap(map) { localStorage.setItem(STORAGE_KEYS.PROGRESS, JSON.stringify(map)); }
        function loadDensity() { return localStorage.getItem(STORAGE_KEYS.DENSITY) || 'comfortable'; }
        function saveDensity(v) { localStorage.setItem(STORAGE_KEYS.DENSITY, v); }

        // App state
        let docs = loadDocs();
        let folders = loadFolders();
        let folderOpenState = loadFolderState();
        let currentDocId = getCurrentId();
        let isSaving = false;
        let lastCharCountForProgress = 0;
        let draggedDocId = null;
        let draggedFolderId = null;
        let lastDeleted = null; // {doc}
        let moveTargetDocId = null;

        // Ensure ordering fields (migration)
        function ensureOrdering() {
            const perParent = new Map();
            for (const f of folders) {
                const pid = f.parentId || null; if (!perParent.has(pid)) perParent.set(pid, []); perParent.get(pid).push(f);
            }
            for (const [pid, list] of perParent.entries()) {
                list.sort((a,b) => (typeof a.sort === 'number') - (typeof b.sort === 'number') || a.name.localeCompare(b.name));
                list.forEach((f, i) => { if (typeof f.sort !== 'number') f.sort = i; });
            }
            const perDocParent = new Map();
            for (const d of docs) {
                const pid = d.folderId || null; if (!perDocParent.has(pid)) perDocParent.set(pid, []); perDocParent.get(pid).push(d);
            }
            for (const [pid, list] of perDocParent.entries()) {
                list.sort((a,b) => (typeof a.sort === 'number') - (typeof b.sort === 'number') || (b.updatedAt - a.updatedAt));
                list.forEach((d, i) => { if (typeof d.sort !== 'number') d.sort = i; });
            }
            saveFolders(folders); saveDocs(docs);
        }

        // Elements
        const sidebar = $('#sidebar');
        const overlay = $('#sidebar-overlay');
        const editor = $('#editor');
        const treeEl = $('#tree');
        const titleInput = $('#titleInput');
        const charCountEl = $('#charCount');
        const paraCountEl = $('#paraCount');
        const saveIndicator = $('#saveIndicator');
        const goalNum = $('#goalNum');
        const goalNow = $('#goalNow');
        const goalProgress = $('#goalProgress');
        const drawer = $('#settingsDrawer');
        const drawerOverlay = $('#drawerOverlay');
        const goalInput = $('#goalInput');
        const sheet = $('#moveSheet');
        const sheetOverlay = $('#sheetOverlay');
        const sheetBody = $('#moveSheetBody');

        // Theme setup
        function applyTheme(theme){ document.documentElement.setAttribute('data-theme', theme); selectThemeChip(theme); }
        applyTheme(loadTheme());

        // Density setup
        function applyDensity(density) {
            document.body.dataset.density = density;
            document.documentElement.style.setProperty('--editor-width', density === 'compact' ? '720px' : '780px');
            selectDensityChip(density);
        }
        applyDensity(loadDensity());

        // Initialize folders/docs if empty
        if (!docs.length) {
            const id = generateId('doc');
            const now = Date.now();
            docs.push({ id, title: 'ÊàëÁöÑÂÜô‰ΩúÁ¨îËÆ∞', content: 'ËøôÊòØ‰∏Ä‰∏™Á∫ØÁ≤π‰∏ìÊ≥®ÁöÑÂÜô‰ΩúÁéØÂ¢É„ÄÇ\n\nÂú®ËøôÈáåÔºåÊÇ®ÂèØ‰ª•Ëá™Áî±Âú∞Âàõ‰ΩúÔºå‰∏çÂèóÂπ≤Êâ∞„ÄÇ\n\n‰ΩøÁî®Â∑¶‰æßÁöÑÁõÆÂΩïÁÆ°ÁêÜÊÇ®ÁöÑÊñáÊ°£‰∏éÊñá‰ª∂Â§π„ÄÇ', starred: false, createdAt: now, updatedAt: now, folderId: null, sort: 0 });
            saveDocs(docs);
            currentDocId = id;
            setCurrentId(id);
        }
        if (!folders.length) {
            const fid = generateId('fld');
            folders.push({ id: fid, name: 'ÊàëÁöÑ‰ΩúÂìÅ', parentId: null, sort: 0 });
            folderOpenState[fid] = true;
            saveFolders(folders);
            saveFolderState(folderOpenState);
        }
        ensureOrdering();

        // Tree helpers
        function getChildrenFolders(parentId) { return folders.filter(f => f.parentId === parentId).sort((a,b) => a.sort - b.sort || a.name.localeCompare(b.name)); }
        function getFolderDocs(folderId) { return docs.filter(d => (d.folderId || null) === (folderId || null)).sort((a,b) => a.sort - b.sort || (b.updatedAt - a.updatedAt)); }
        function isOpen(folderId) { return !!folderOpenState[folderId]; }
        function setOpen(folderId, open) { folderOpenState[folderId] = open; saveFolderState(folderOpenState); }

        function renderTree(filter = '') {
            const keyword = filter.trim().toLowerCase();
            treeEl.innerHTML = '';

            // Root drop target
            const rootDrop = createEl('div', 'tree-root-drop');
            rootDrop.textContent = 'ÊãñÂä®ÊñáÊ°£Âà∞Ê≠§Â§ÑÁßªÂä®Âà∞Ê†πÁõÆÂΩï';
            rootDrop.addEventListener('dragover', (e) => { e.preventDefault(); rootDrop.classList.add('dragover'); }, { passive: false });
            rootDrop.addEventListener('dragleave', () => rootDrop.classList.remove('dragover'));
            rootDrop.addEventListener('drop', (e) => { e.preventDefault(); rootDrop.classList.remove('dragover'); if (draggedDocId) moveDocToFolder(draggedDocId, null); });
            treeEl.appendChild(rootDrop);

            // Root docs (no folder)
            const rootDocs = getFolderDocs(null);
            for (const d of rootDocs) {
                if (keyword && !d.title.toLowerCase().includes(keyword)) continue;
                treeEl.appendChild(renderDocNode(d, 0));
            }

            // Recursive folders
            function renderFolder(folder, level) {
                const row = createEl('div', 'folder-node');
                row.dataset.folderId = folder.id;
                row.draggable = true;
                if (!isOpen(folder.id)) row.classList.add('collapsed');
                const indent = createEl('div', 'indent'); indent.style.marginLeft = (level * 14) + 'px';
                const caret = createEl('div', 'caret'); caret.textContent = isOpen(folder.id) ? '‚ñæ' : '‚ñ∏';
                caret.addEventListener('click', () => { const open = !isOpen(folder.id); setOpen(folder.id, open); caret.textContent = open ? '‚ñæ' : '‚ñ∏'; children.style.display = open ? '' : 'none'; });
                const icon = createEl('div'); icon.textContent = 'üìÅ';
                const title = createEl('div', 'folder-title'); title.textContent = folder.name;
                const actions = createEl('div', 'node-actions');
                const addBtn = createEl('button', 'icon-btn'); addBtn.title = 'Êñ∞Âª∫Â≠êÊñá‰ª∂Â§π'; addBtn.textContent = 'Ôºã'; addBtn.addEventListener('click', (e) => { e.stopPropagation(); createFolder(folder.id); });
                const renameBtn = createEl('button', 'icon-btn'); renameBtn.title = 'ÈáçÂëΩÂêç'; renameBtn.textContent = '‚úé'; renameBtn.addEventListener('click', (e) => { e.stopPropagation(); inlineRenameFolder(folder.id, title); });
                const delBtn = createEl('button', 'icon-btn'); delBtn.title = 'Âà†Èô§Êñá‰ª∂Â§π'; delBtn.textContent = 'üóëÔ∏è'; delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteFolder(folder.id); });
                actions.appendChild(addBtn); actions.appendChild(renameBtn); actions.appendChild(delBtn);

                row.appendChild(indent); row.appendChild(caret); row.appendChild(icon); row.appendChild(title); row.appendChild(actions);

                // Folder drag sorting (same parent only)
                row.addEventListener('dragstart', (e) => { draggedFolderId = folder.id; e.dataTransfer.effectAllowed = 'move'; });
                row.addEventListener('dragend', () => { draggedFolderId = null; row.classList.remove('drop-before','drop-after'); });
                row.addEventListener('dragover', (e) => {
                    if (!draggedFolderId || draggedFolderId === folder.id) return; 
                    const dragged = folders.find(f => f.id === draggedFolderId);
                    if (!dragged || (dragged.parentId || null) !== (folder.parentId || null)) return; // only same parent
                    e.preventDefault();
                    const rect = row.getBoundingClientRect();
                    const before = (e.clientY - rect.top) < rect.height / 2;
                    row.classList.toggle('drop-before', before);
                    row.classList.toggle('drop-after', !before);
                }, { passive: false });
                row.addEventListener('dragleave', () => row.classList.remove('drop-before','drop-after'));
                row.addEventListener('drop', (e) => {
                    if (!draggedFolderId || draggedFolderId === folder.id) return; 
                    const dragged = folders.find(f => f.id === draggedFolderId);
                    if (!dragged || (dragged.parentId || null) !== (folder.parentId || null)) return;
                    e.preventDefault();
                    const rect = row.getBoundingClientRect();
                    const before = (e.clientY - rect.top) < rect.height / 2;
                    reorderFolders(dragged.parentId || null, draggedFolderId, folder.id, before ? 'before' : 'after');
                    row.classList.remove('drop-before','drop-after');
                });

                const children = createEl('div', 'children');
                children.style.display = isOpen(folder.id) ? '' : 'none';

                // docs
                const docsIn = getFolderDocs(folder.id);
                for (const d of docsIn) {
                    if (keyword && !d.title.toLowerCase().includes(keyword)) continue;
                    children.appendChild(renderDocNode(d, level + 1));
                }
                // subfolders
                const sub = getChildrenFolders(folder.id);
                for (const sf of sub) children.appendChild(renderFolder(sf, level + 1));

                const container = createEl('div');
                container.appendChild(row);
                container.appendChild(children);
                return container;
            }

            const topFolders = getChildrenFolders(null);
            for (const f of topFolders) treeEl.appendChild(renderFolder(f, 0));
        }

        function renderDocNode(doc, level) {
            const row = createEl('div', 'doc-node');
            row.draggable = true;
            row.dataset.docId = doc.id;
            if (doc.id === currentDocId) row.classList.add('active');
            const indent = createEl('div', 'indent'); indent.style.marginLeft = (level * 14) + 'px';
            const icon = createEl('div'); icon.textContent = 'üìù';
            const title = createEl('div', 'doc-title'); title.textContent = doc.title || 'Êó†Ê†áÈ¢ò';
            const actions = createEl('div', 'node-actions');
            const starBtn = createEl('button', 'icon-btn'); starBtn.innerHTML = doc.starred ? '‚≠ê' : '‚òÜ'; starBtn.title = doc.starred ? 'ÂèñÊ∂àÊî∂Ëóè' : 'Êî∂Ëóè'; starBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleStar(doc.id); });
            const moveBtn = createEl('button', 'icon-btn'); moveBtn.textContent = '‚Ü™Ô∏è'; moveBtn.title = 'ÁßªÂä®Âà∞'; moveBtn.addEventListener('click', (e) => { e.stopPropagation(); openMoveSheet(doc.id); });
            const delBtn = createEl('button', 'icon-btn'); delBtn.textContent = 'üóëÔ∏è'; delBtn.title = 'Âà†Èô§ÊñáÊ°£'; delBtn.addEventListener('click', (e) => { e.stopPropagation(); softDeleteDoc(doc.id); });
            actions.appendChild(starBtn); actions.appendChild(moveBtn); actions.appendChild(delBtn);

            row.appendChild(indent); row.appendChild(icon); row.appendChild(title); row.appendChild(actions);
            row.addEventListener('click', () => selectDoc(doc.id));

            // Dragging
            row.addEventListener('dragstart', (e) => { draggedDocId = doc.id; e.dataTransfer.effectAllowed = 'move'; });
            row.addEventListener('dragend', () => { draggedDocId = null; row.classList.remove('drop-before','drop-after'); });
            row.addEventListener('dragover', (e) => {
                if (!draggedDocId || draggedDocId === doc.id) return; 
                const dragged = docs.find(d => d.id === draggedDocId);
                if (!dragged || (dragged.folderId || null) !== (doc.folderId || null)) return; // only within same parent for sort
                e.preventDefault();
                const rect = row.getBoundingClientRect();
                const before = (e.clientY - rect.top) < rect.height / 2;
                row.classList.toggle('drop-before', before);
                row.classList.toggle('drop-after', !before);
            }, { passive: false });
            row.addEventListener('dragleave', () => row.classList.remove('drop-before','drop-after'));
            row.addEventListener('drop', (e) => {
                if (!draggedDocId || draggedDocId === doc.id) return; 
                const dragged = docs.find(d => d.id === draggedDocId);
                if (!dragged || (dragged.folderId || null) !== (doc.folderId || null)) return;
                e.preventDefault();
                const rect = row.getBoundingClientRect();
                const before = (e.clientY - rect.top) < rect.height / 2;
                reorderDocs(doc.folderId || null, draggedDocId, doc.id, before ? 'before' : 'after');
                row.classList.remove('drop-before','drop-after');
            });
            return row;
        }

        function reorderDocs(parentId, draggedId, targetId, position) {
            const list = docs.filter(d => (d.folderId || null) === (parentId || null)).sort((a,b) => a.sort - b.sort);
            const orderMap = new Map(list.map((d,i)=>[d.id,i]));
            const draggedIdx = orderMap.get(draggedId);
            const targetIdx = orderMap.get(targetId);
            if (draggedIdx == null || targetIdx == null) return;
            list.splice(draggedIdx, 1);
            const newIndex = position === 'before' ? (targetIdx) : (targetIdx + 1);
            list.splice(newIndex, 0, docs.find(d=>d.id===draggedId));
            list.forEach((d,i)=>{ d.sort = i; });
            saveDocs(docs);
            renderTree($('#searchInput').value);
        }

        function reorderFolders(parentId, draggedId, targetId, position) {
            const list = folders.filter(f => (f.parentId || null) === (parentId || null)).sort((a,b) => a.sort - b.sort);
            const orderMap = new Map(list.map((f,i)=>[f.id,i]));
            const draggedIdx = orderMap.get(draggedId);
            const targetIdx = orderMap.get(targetId);
            if (draggedIdx == null || targetIdx == null) return;
            list.splice(draggedIdx, 1);
            const newIndex = position === 'before' ? (targetIdx) : (targetIdx + 1);
            list.splice(newIndex, 0, folders.find(f=>f.id===draggedId));
            list.forEach((f,i)=>{ f.sort = i; });
            saveFolders(folders);
            renderTree($('#searchInput').value);
        }

        function sortDoc(a, b) { return a.sort - b.sort || (b.updatedAt - a.updatedAt); }

        function selectDoc(id) {
            const doc = docs.find(x => x.id === id);
            if (!doc) return;
            currentDocId = id;
            setCurrentId(id);
            titleInput.value = doc.title || '';
            editor.value = doc.content || '';
            lastCharCountForProgress = measureCharCount(editor.value);
            updateWordStats();
            renderTree($('#searchInput').value);
            markSaved(true);
        }

        function createDoc(initialContent = '', folderId = null, title = 'Êó†Ê†áÈ¢òÊñáÊ°£') {
            const id = generateId('doc');
            const now = Date.now();
            const siblingCount = docs.filter(d => (d.folderId || null) === (folderId || null)).length;
            const newDoc = { id, title, content: initialContent, starred: false, createdAt: now, updatedAt: now, folderId, sort: siblingCount };
            docs.push(newDoc);
            saveDocs(docs);
            selectDoc(id);
            titleInput.focus();
        }

        function createNovel() {
            const fid = generateId('fld');
            const parentId = null;
            const siblingCount = folders.filter(f => (f.parentId || null) === (parentId || null)).length;
            const folder = { id: fid, name: 'Êñ∞Â∞èËØ¥', parentId, sort: siblingCount };
            folders.push(folder);
            folderOpenState[fid] = true;
            saveFolders(folders); saveFolderState(folderOpenState);
            // default docs: Outline + Chapter 1
            createDoc('‰π¶ÂêçÔºö\n‰∏ªÊó®Ôºö\n‰∫∫ËÆæÔºö\n‰∏ñÁïåËßÇÔºö\nÊÉÖËäÇÊèêË¶ÅÔºö\n', fid, 'Â§ßÁ∫≤');
            createDoc('Á¨¨1Á´†\n\n', fid, 'Á¨¨1Á´†');
            showSnack('Â∑≤ÂàõÂª∫Â∞èËØ¥‚ÄúÊñ∞Â∞èËØ¥‚Äù');
            renderTree($('#searchInput').value);
        }

        function moveDocToFolder(docId, folderId) {
            const doc = docs.find(d => d.id === docId);
            if (!doc) return;
            const newParent = folderId || null;
            doc.folderId = newParent;
            doc.updatedAt = Date.now();
            // set to end of new parent order
            doc.sort = docs.filter(d => (d.folderId || null) === newParent).length;
            saveDocs(docs);
            renderTree($('#searchInput').value);
            if (docId === currentDocId) showSnack('Â∑≤ÁßªÂä®Âà∞' + (folderId ? 'ÈÄâ‰∏≠Êñá‰ª∂Â§π' : 'Ê†πÁõÆÂΩï'));
        }

        function softDeleteDoc(id) {
            const idx = docs.findIndex(d => d.id === id);
            if (idx === -1) return;
            const removed = docs.splice(idx, 1)[0];
            saveDocs(docs);
            if (currentDocId === id) {
                if (docs.length) selectDoc(docs[0].id); else { createDoc(); }
            }
            renderTree($('#searchInput').value);
            lastDeleted = { doc: removed };
            showSnack('Â∑≤Âà†Èô§ÊñáÊ°£', 'Êí§ÈîÄ', () => { if (!lastDeleted) return; docs.push(lastDeleted.doc); saveDocs(docs); lastDeleted = null; renderTree($('#searchInput').value); });
        }

        function toggleStar(id) {
            const doc = docs.find(d => d.id === id);
            if (!doc) return;
            doc.starred = !doc.starred;
            doc.updatedAt = Date.now();
            saveDocs(docs);
            renderTree($('#searchInput').value);
        }

        function createFolder(parentId = null) {
            const id = generateId('fld');
            const siblingCount = folders.filter(f => (f.parentId || null) === (parentId || null)).length;
            const f = { id, name: 'Êñ∞Âª∫Êñá‰ª∂Â§π', parentId: parentId || null, sort: siblingCount };
            folders.push(f);
            folderOpenState[id] = true;
            saveFolders(folders); saveFolderState(folderOpenState);
            renderTree($('#searchInput').value);
        }

        function inlineRenameFolder(folderId, titleEl) {
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;
            const old = folder.name;
            const input = document.createElement('input');
            input.type = 'text'; input.value = old; input.style.width = '100%';
            titleEl.replaceWith(input);
            input.focus(); input.select();
            const commit = () => { folder.name = input.value.trim() || old; saveFolders(folders); renderTree($('#searchInput').value); };
            input.addEventListener('blur', commit);
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } if (e.key === 'Escape') { folder.name = old; input.blur(); } });
        }

        function deleteFolder(folderId) {
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;
            const parentId = folder.parentId || null;
            for (const d of docs) { if (d.folderId === folderId) { d.folderId = parentId; d.sort = docs.filter(x => (x.folderId || null) === parentId).length; } }
            for (const f of folders) { if (f.parentId === folderId) { f.parentId = parentId; f.sort = folders.filter(x => (x.parentId || null) === parentId).length; } }
            folders = folders.filter(f => f.id !== folderId);
            saveDocs(docs); saveFolders(folders);
            showSnack('Êñá‰ª∂Â§πÂ∑≤Âà†Èô§ÔºàÂÜÖÂÆπÂ∑≤‰∏äÁßªÔºâ');
            renderTree($('#searchInput').value);
        }

        // Move-To sheet
        function openMoveSheet(docId) {
            moveTargetDocId = docId;
            renderMoveSheet();
            sheet.classList.add('show');
            sheetOverlay.style.display = 'block';
        }
        function closeMoveSheet() {
            sheet.classList.remove('show');
            sheetOverlay.style.display = 'none';
            moveTargetDocId = null;
        }
        function renderMoveSheet() {
            sheetBody.innerHTML = '';
            const rootRow = createEl('div', 'sheet-row');
            rootRow.innerHTML = '<span>üìÑ</span><span>Ê†πÁõÆÂΩï</span>';
            rootRow.addEventListener('click', () => { if (!moveTargetDocId) return; moveDocToFolder(moveTargetDocId, null); closeMoveSheet(); });
            sheetBody.appendChild(rootRow);
            function renderFolderOption(folder, level) {
                const row = createEl('div', 'sheet-row');
                const indent = createEl('div', 'sheet-indent'); indent.style.marginLeft = (level * 14) + 'px';
                const icon = createEl('span'); icon.textContent = 'üìÅ';
                const name = createEl('span'); name.textContent = folder.name;
                row.appendChild(indent); row.appendChild(icon); row.appendChild(name);
                row.addEventListener('click', () => { if (!moveTargetDocId) return; moveDocToFolder(moveTargetDocId, folder.id); closeMoveSheet(); });
                sheetBody.appendChild(row);
                const children = getChildrenFolders(folder.id);
                for (const cf of children) renderFolderOption(cf, level + 1);
            }
            const tops = getChildrenFolders(null);
            for (const f of tops) renderFolderOption(f, 0);
        }

        // Saving
        function markSaved(saved) {
            isSaving = !saved;
            saveIndicator.textContent = saved ? 'Â∑≤‰øùÂ≠ò' : '‰øùÂ≠ò‰∏≠‚Ä¶';
            saveIndicator.style.color = saved ? 'var(--muted-text)' : 'var(--primary-color)';
        }

        const persist = debounce(function persistNow(){
            const doc = docs.find(d => d.id === currentDocId);
            if (!doc) return;
            doc.title = titleInput.value.trim() || 'Êó†Ê†áÈ¢òÊñáÊ°£';
            doc.content = editor.value;
            doc.updatedAt = Date.now();
            saveDocs(docs);
            markSaved(true);
            renderTree($('#searchInput').value);
        }, 300);

        function saveNow() { markSaved(false); persist(); }

        // Word stats
        function measureCharCount(text) { if (!text) return 0; return text.replace(/\s+/g, '').length; }
        const updateWordStats = throttleRaf(function(){
            const text = editor.value || '';
            const chars = measureCharCount(text);
            const paras = text.trim() ? text.split(/\n{2,}/).length : 0;
            charCountEl.textContent = chars;
            paraCountEl.textContent = paras;
            updateDailyProgress(chars);
        });

        // Daily goal
        function updateDailyProgress(currentChars){
            const key = todayKey();
            const map = loadProgressMap();
            const before = lastCharCountForProgress;
            const delta = Math.max(0, currentChars - before);
            if (delta > 0) {
                map[key] = (map[key] || 0) + delta;
                saveProgressMap(map);
                lastCharCountForProgress = currentChars;
            }
            const goal = loadGoal();
            goalNum.textContent = goal;
            const now = (loadProgressMap()[key] || 0);
            goalNow.textContent = now;
            const pct = goal === 0 ? 1 : clamp(now / goal, 0, 1);
            goalProgress.style.width = (pct * 100).toFixed(1) + '%';
        }

        // Plain text templates
        const TEMPLATES = {
            person: "‰∫∫Áâ©Âç°\n‚Äî‚Äî\nÂßìÂêçÔºö\nÂπ¥ÈæÑÔºö\nÂ§ñË≤åÁâπÂæÅÔºö\nÊÄßÊ†ºÊ†áÁ≠æÔºö\nËÉåÊôØÊïÖ‰∫ãÔºö\nÁõÆÊ†á/Âä®Êú∫Ôºö\n‰∫∫ÈôÖÂÖ≥Á≥ªÔºö\n",
            scene: "Âú∫ÊôØÂç°\n‚Äî‚Äî\nÂú∞ÁÇπÔºö\nÊó∂Èó¥Ôºö\nÂ§©Ê∞î/Ê∞õÂõ¥Ôºö\nÁôªÂú∫‰∫∫Áâ©Ôºö\nÂÜ≤Á™ÅÁÇπÔºö\nÁªÜËäÇÈÅìÂÖ∑Ôºö\nËäÇÂ•è/Âº†ÂäõÔºö\n",
            world: "‰∏ñÁïåËßÇ\n‚Äî‚Äî\nÊó∂‰ª£ËÉåÊôØÔºö\nÂú∞ÁêÜËÆæÂÆöÔºö\nÁ§æ‰ºöÁªìÊûÑÔºö\nÁßëÊäÄ/È≠îÊ≥ï‰ΩìÁ≥ªÔºö\nÂÆóÊïô/ÊñáÂåñÔºö\nÁ¶ÅÂøå‰∏éËßÑÂàôÔºö\nÊ†∏ÂøÉÁüõÁõæÔºö\n"
        };
        function insertAtCursor(text){
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const val = editor.value;
            editor.value = val.slice(0, start) + text + val.slice(end);
            const caret = start + text.length;
            editor.selectionStart = editor.selectionEnd = caret;
            editor.focus();
            saveNow();
            updateWordStats();
        }
        function insertTemplate(name){ insertAtCursor('\n' + TEMPLATES[name] + '\n'); }

        // Export / Import
        function download(name, content, type){ const blob = new Blob([content], { type }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click(); setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0); }

        // Snackbar
        let snackTimer = null;
        function showSnack(msg, actionText, action) {
            $('#snackMsg').textContent = msg;
            const act = $('#snackAction');
            if (actionText && action) { act.textContent = actionText; act.style.display = 'inline'; act.onclick = () => { hideSnack(); action(); }; } else { act.textContent = ''; act.style.display = 'none'; act.onclick = null; }
            const el = $('#snackbar'); el.classList.add('show');
            clearTimeout(snackTimer);
            snackTimer = setTimeout(hideSnack, 3000);
        }
        function hideSnack(){ $('#snackbar').classList.remove('show'); }

        // Settings Drawer
        function openDrawer() { drawer.classList.add('show'); drawerOverlay.style.display = 'block'; goalInput.value = loadGoal(); selectThemeChip(loadTheme()); selectDensityChip(loadDensity()); }
        function closeDrawer() { drawer.classList.remove('show'); drawerOverlay.style.display = 'none'; }
        function selectThemeChip(theme) { $all('#themeChips .chip').forEach(c => c.classList.toggle('active', c.dataset.theme === theme)); }
        function selectDensityChip(d) { $all('#densityChips .chip').forEach(c => c.classList.toggle('active', c.dataset.density === d)); }

        // Move sheet bindings
        $('#closeMoveSheet').addEventListener('click', closeMoveSheet);
        sheetOverlay.addEventListener('click', closeMoveSheet);

        // Bind toolbar
        function bindToolbar() {
            $('#tplPerson').addEventListener('click', () => insertTemplate('person'));
            $('#tplScene').addEventListener('click', () => insertTemplate('scene'));
            $('#tplWorld').addEventListener('click', () => insertTemplate('world'));

            $('#exportTxt').addEventListener('click', () => { const doc = docs.find(d => d.id === currentDocId); if (!doc) return; download((doc.title || 'ÂØºÂá∫') + '.txt', (doc.content || ''), 'text/plain;charset=utf-8'); });
            $('#exportMd').addEventListener('click', () => { const doc = docs.find(d => d.id === currentDocId); if (!doc) return; download((doc.title || 'ÂØºÂá∫') + '.md', (doc.content || ''), 'text/markdown;charset=utf-8'); });
        }

        // Global bindings
        function bindGlobal() {
            // Sidebar
            $('#menuToggle').addEventListener('click', () => sidebar.classList.toggle('show'));
            overlay.addEventListener('click', () => sidebar.classList.remove('show'));

            // Theme quick toggle (light/dark)
            $('#themeToggle').addEventListener('click', () => { const cur = loadTheme(); const next = (cur === 'dark') ? 'light' : 'dark'; saveTheme(next); applyTheme(next); showSnack('‰∏ªÈ¢òÔºö' + (next === 'dark' ? 'ÊöóÈªë' : 'Êòé‰∫Æ')); });

            // Focus mode
            $('#focusToggle').addEventListener('click', () => { document.body.classList.toggle('focus-mode'); showSnack(document.body.classList.contains('focus-mode') ? 'Â∑≤ËøõÂÖ•‰∏ìÊ≥®Ê®°Âºè' : 'Â∑≤ÈÄÄÂá∫‰∏ìÊ≥®Ê®°Âºè'); });

            // New doc/folder/novel
            $('#newDocBtn').addEventListener('click', () => createDoc());
            $('#newFolderBtn').addEventListener('click', () => createFolder(null));
            $('#newNovelBtn').addEventListener('click', createNovel);

            // Search
            $('#searchInput').addEventListener('input', debounce((e) => renderTree(e.target.value), 120));

            // Import
            $('#importBtn').addEventListener('click', () => $('#importFile').click());
            $('#importFile').addEventListener('change', async (e) => { const file = e.target.files && e.target.files[0]; if (!file) return; const text = await file.text(); createDoc(text, null, file.name.replace(/\.[^.]+$/, '')); e.target.value = ''; showSnack('Â∑≤ÂØºÂÖ•Ôºö' + file.name); });

            // Title / Editor
            titleInput.addEventListener('input', () => { markSaved(false); persist(); renderTree($('#searchInput').value); });
            editor.addEventListener('input', () => { markSaved(false); updateWordStats(); persist(); });

            // Passive listeners for smoother scrolling on mobile
            editor.addEventListener('touchstart', () => {}, { passive: true });
            editor.addEventListener('touchmove', () => {}, { passive: true });
            document.addEventListener('scroll', throttleRaf(() => {}), { passive: true, capture: true });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                const mod = e.ctrlKey || e.metaKey;
                if (mod && e.key.toLowerCase() === 's') { e.preventDefault(); saveNow(); showSnack('Â∑≤‰øùÂ≠ò'); }
                if (mod && e.key.toLowerCase() === 'k') { e.preventDefault(); $('#searchInput').focus(); }
            }, { passive: false });

            // Settings drawer
            $('#settingsBtn').addEventListener('click', openDrawer);
            $('#setGoalBtn').addEventListener('click', openDrawer);
            $('#closeDrawer').addEventListener('click', closeDrawer);
            drawerOverlay.addEventListener('click', closeDrawer);

            // Theme select in drawer
            $all('#themeChips .chip').forEach(chip => chip.addEventListener('click', () => { const theme = chip.dataset.theme; saveTheme(theme); applyTheme(theme); showSnack('‰∏ªÈ¢òÔºö' + chip.textContent); }));

            // Density select
            $all('#densityChips .chip').forEach(chip => chip.addEventListener('click', () => { const d = chip.dataset.density; saveDensity(d); applyDensity(d); showSnack('ÁïåÈù¢ÂØÜÂ∫¶Ôºö' + (d === 'compact' ? 'Á¥ßÂáë' : 'ËàíÈÄÇ')); }));

            // Goal input (live apply)
            goalInput.addEventListener('change', () => { const n = parseInt(goalInput.value || '0', 10); if (Number.isFinite(n) && n >= 0) { saveGoal(n); updateWordStats(); showSnack('Â∑≤Êõ¥Êñ∞‰ªäÊó•ÁõÆÊ†áÔºö' + n); } });

            // Mobile toolbar
            $('#mPerson').addEventListener('click', () => insertTemplate('person'));
            $('#mScene').addEventListener('click', () => insertTemplate('scene'));
            $('#mWorld').addEventListener('click', () => insertTemplate('world'));
            $('#mNewDoc').addEventListener('click', () => createDoc());
            $('#mFocus').addEventListener('click', () => { document.body.classList.toggle('focus-mode'); });
            $('#mSettings').addEventListener('click', openDrawer);
        }

        // Boot
        bindToolbar();
        bindGlobal();
        renderTree();
        selectDoc(currentDocId || docs[0].id);
        updateWordStats();
    </script>
</body>
</html>