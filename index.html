<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¯çº¯å†™ä½œ Â· å°è¯´åˆ›ä½œå·¥ä½œå°</title>
    <style>
        :root {
            --sidebar-width: 300px;
            --primary-color: #4a86e8;
            --text-color: #222;
            --muted-text: #666;
            --bg-color: #f7f8fa;
            --panel-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 2px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 6px 18px rgba(0,0,0,0.08);
            --accent: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --link: #2563eb;
            --editor-width: 780px;
            --tree-indent: 18px;
            --hover-bg: rgba(127,127,127,0.06);
            --active-bg: rgba(74,134,232,0.12);
        }

        [data-theme="dark"] {
            --primary-color: #6ea8fe;
            --text-color: #e5e7eb;
            --muted-text: #9ca3af;
            --bg-color: #0f1116;
            --panel-bg: #161a23;
            --border-color: #262a36;
            --shadow-sm: 0 2px 6px rgba(0,0,0,0.35);
            --shadow-md: 0 6px 18px rgba(0,0,0,0.35);
            --accent: #34d399;
            --danger: #f87171;
            --warning: #f59e0b;
            --link: #93c5fd;
            --hover-bg: rgba(255,255,255,0.05);
            --active-bg: rgba(110,168,254,0.15);
        }

        [data-theme="sepia"] {
            --primary-color: #8b5e34;
            --text-color: #3e2c1c;
            --muted-text: #7b6a58;
            --bg-color: #f3ead7;
            --panel-bg: #faf3e3;
            --border-color: #e1d7c6;
            --accent: #9c6f3d;
            --warning: #c48f3c;
            --link: #7a4e2b;
            --hover-bg: rgba(139,94,52,0.07);
            --active-bg: rgba(139,94,52,0.12);
        }

        [data-theme="solar"] {
            --primary-color: #1f6feb;
            --text-color: #24292f;
            --muted-text: #57606a;
            --bg-color: #f6f8fa;
            --panel-bg: #ffffff;
            --border-color: #d0d7de;
            --accent: #2da44e;
            --warning: #bf8700;
            --link: #0969da;
            --hover-bg: rgba(31,111,235,0.06);
            --active-bg: rgba(31,111,235,0.12);
        }

        [data-theme="night"] {
            --primary-color: #7aa2f7;
            --text-color: #c0caf5;
            --muted-text: #a9b1d6;
            --bg-color: #0b1020;
            --panel-bg: #101425;
            --border-color: #1f2540;
            --accent: #2ac3de;
            --warning: #ffc777;
            --link: #7dcfff;
            --hover-bg: rgba(255,255,255,0.04);
            --active-bg: rgba(122,162,247,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        }

        html, body { height: 100%; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.28s ease;
            z-index: 40;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo { width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, var(--primary-color), #7cc5ff); box-shadow: var(--shadow-sm); }
        .sidebar-title { font-size: 1.05rem; font-weight: 700; letter-spacing: 0.4px; color: var(--primary-color); }

        .sidebar-actions { margin-left: auto; display: flex; gap: 8px; }
        .icon-btn { background: none; border: 1px solid transparent; color: var(--muted-text); cursor: pointer; border-radius: 8px; padding: 6px 8px; transition: all 0.15s ease; }
        .icon-btn:hover { background-color: var(--hover-bg); border-color: var(--border-color); }

        .sidebar-search { padding: 10px 12px; border-bottom: 1px solid var(--border-color); display: flex; gap: 8px; }
        .search-input { flex: 1; border: 1px solid var(--border-color); background: transparent; border-radius: 8px; padding: 8px 10px; color: var(--text-color); }
        .search-input:focus { outline: 2px solid rgba(74,134,232,0.25); }

        .sidebar-menu { padding: 6px 0 8px 0; overflow: hidden auto; flex: 1; }
        .menu-section-title { font-size: 12px; color: var(--muted-text); padding: 8px 16px; text-transform: uppercase; letter-spacing: 1.2px; }

        /* Tree */
        .tree { padding: 6px 6px 16px 6px; }
        .tree-root-drop { margin: 0 10px 8px 10px; padding: 6px 8px; border-radius: 6px; color: var(--muted-text); border: 1px dashed var(--border-color); font-size: 12px; }
        .tree-root-drop.dragover { background: var(--active-bg); }

        .folder-node, .doc-node { display: flex; align-items: center; gap: 8px; padding: 8px 8px 8px 10px; border-radius: 8px; margin: 2px 6px; }
        .folder-node:hover, .doc-node:hover { background: var(--hover-bg); }
        .doc-node.active { background: var(--active-bg); }
        .indent { width: var(--tree-indent); flex: 0 0 var(--tree-indent); height: 1px; }
        .caret { width: 16px; text-align: center; cursor: pointer; color: var(--muted-text); }
        .folder-title { font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .doc-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .node-actions { display: flex; gap: 6px; }
        .node-actions .icon-btn { padding: 4px 6px; border-radius: 6px; }
        .children { margin-left: calc(var(--tree-indent) + 8px); }
        .drop-target { outline: 2px dashed var(--primary-color); }

        .sidebar-footer { border-top: 1px solid var(--border-color); padding: 10px 12px; display: flex; gap: 10px; }
        .primary-btn { background: var(--primary-color); color: #fff; border: none; padding: 8px 10px; border-radius: 8px; cursor: pointer; box-shadow: var(--shadow-sm); }
        .primary-btn:hover { filter: brightness(1.05); }

        /* Main */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; }

        .toolbar { display: grid; grid-template-columns: auto 1fr auto auto; align-items: center; gap: 10px; padding: 10px 14px; background-color: var(--panel-bg); border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 30; }
        .menu-toggle { background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 6px; color: var(--muted-text); }

        .title-input { width: 100%; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 10px; background: transparent; color: var(--text-color); font-size: 1rem; font-weight: 600; }
        .title-input:focus { outline: 2px solid rgba(74,134,232,0.25); }

        .toolbar-actions { display: flex; gap: 8px; align-items: center; }
        .toolbar-btn { background: none; border: 1px solid var(--border-color); border-radius: 8px; padding: 6px 8px; cursor: pointer; color: var(--muted-text); }
        .toolbar-btn:hover { background: var(--hover-bg); }

        .format-bar { display: flex; gap: 6px; align-items: center; }
        .divider { width: 1px; height: 22px; background: var(--border-color); margin: 0 6px; }
        select.format-switch { border: 1px solid var(--border-color); background: transparent; color: var(--text-color); border-radius: 8px; padding: 6px 8px; }

        #editor-wrapper { display: flex; justify-content: center; width: 100%; }
        #editor { width: min(100%, var(--editor-width)); margin: 24px 16px; padding: 28px; font-size: 1.06rem; line-height: 1.9; background-color: var(--panel-bg); outline: none; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: var(--shadow-md); min-height: 58vh; }
        #editor:focus { border-color: rgba(74,134,232,0.5); box-shadow: 0 0 0 3px rgba(74,134,232,0.15), var(--shadow-md); }
        #editor p { margin: 0 0 1em 0; }
        #editor h1, #editor h2, #editor h3 { margin: 1.2em 0 0.6em; }
        #editor blockquote { border-left: 3px solid var(--primary-color); padding-left: 10px; margin: 1em 0; color: var(--muted-text); }
        #editor ul, #editor ol { padding-left: 1.2em; }

        .word-count { padding: 10px 14px; background-color: var(--panel-bg); border-top: 1px solid var(--border-color); font-size: 0.92rem; color: var(--muted-text); display: flex; gap: 14px; align-items: center; }
        .goal { display: flex; align-items: center; gap: 8px; }
        .progress-bar { width: 180px; height: 8px; border-radius: 6px; background: rgba(127,127,127,0.12); overflow: hidden; border: 1px solid var(--border-color); }
        .progress { height: 100%; background: linear-gradient(90deg, var(--accent), #2dd4bf); width: 0%; }
        .save-indicator { margin-left: auto; font-size: 12px; color: var(--muted-text); }

        /* Overlays */
        #sidebar-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.35); z-index: 20; display: none; }
        #drawerOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; z-index: 60; }

        /* Focus mode */
        body.focus-mode #sidebar { display: none; }
        body.focus-mode .toolbar { opacity: 0.1; pointer-events: none; }
        body.focus-mode #editor { margin-top: 6vh; min-height: 76vh; }

        /* Settings Drawer */
        #settingsDrawer { position: fixed; top: 0; right: 0; height: 100%; width: 340px; background: var(--panel-bg); border-left: 1px solid var(--border-color); box-shadow: var(--shadow-md); transform: translateX(100%); transition: transform 0.25s ease; z-index: 70; display: flex; flex-direction: column; }
        #settingsDrawer.show { transform: translateX(0); }
        .drawer-header { padding: 14px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; font-weight: 700; }
        .drawer-body { padding: 12px 16px; overflow: auto; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 12px; color: var(--muted-text); }
        .radio-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .chip { border: 1px solid var(--border-color); padding: 6px 10px; border-radius: 999px; cursor: pointer; background: transparent; color: var(--text-color); }
        .chip.active { background: var(--active-bg); border-color: var(--primary-color); }
        .num-input { width: 120px; border: 1px solid var(--border-color); background: transparent; color: var(--text-color); padding: 6px 8px; border-radius: 8px; }

        /* Snackbar */
        #snackbar { position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%); background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 999px; padding: 10px 14px; box-shadow: var(--shadow-md); display: none; align-items: center; gap: 10px; z-index: 80; }
        #snackbar.show { display: inline-flex; animation: fadeup 180ms ease; }
        #snackbar .snack-action { color: var(--primary-color); cursor: pointer; }
        @keyframes fadeup { from { opacity: 0; transform: translate(-50%, 8px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* Responsive */
        @media (max-width: 1024px) { :root { --sidebar-width: 260px; --editor-width: 680px; } }
        @media (max-width: 768px) {
            #sidebar { position: fixed; transform: translateX(-100%); }
            #sidebar.show { transform: translateX(0); }
            #sidebar-overlay { display: block; opacity: 0; transition: opacity 0.28s ease; pointer-events: none; }
            #sidebar.show + #main-container #sidebar-overlay { opacity: 1; pointer-events: auto; }
            :root { --editor-width: 100%; }
            .toolbar { grid-template-columns: auto 1fr auto; gap: 6px; }
            .format-bar { display: none; }
            #settingsDrawer { width: 92vw; }
        }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="sidebar-header">
            <div class="logo"></div>
            <div class="sidebar-title">çº¯çº¯å†™ä½œ</div>
            <div class="sidebar-actions">
                <button id="settingsBtn" class="icon-btn" title="è®¾ç½®">âš™ï¸</button>
                <button id="themeToggle" class="icon-btn" title="åˆ‡æ¢æ˜æš—">ğŸŒ—</button>
                <button id="focusToggle" class="icon-btn" title="ä¸“æ³¨æ¨¡å¼">ğŸ¯</button>
            </div>
        </div>
        <div class="sidebar-search">
            <input id="searchInput" class="search-input" placeholder="æœç´¢æ–‡æ¡£ (âŒ˜/Ctrl K)">
            <button id="newDocBtn" class="primary-btn" title="æ–°å»ºæ–‡æ¡£">ï¼‹</button>
            <button id="newFolderBtn" class="toolbar-btn" title="æ–°å»ºæ–‡ä»¶å¤¹">ğŸ“ï¼‹</button>
        </div>
        <div class="menu-section-title">ç›®å½•</div>
        <div id="docList" class="doc-list">
            <div id="tree" class="tree"></div>
        </div>
        <div class="sidebar-footer">
            <button id="importBtn" class="toolbar-btn" title="å¯¼å…¥ .txt">ğŸ“¥ å¯¼å…¥</button>
            <input id="importFile" type="file" accept=".txt,.md,text/plain" style="display:none">
        </div>
    </aside>

    <div id="main-container">
        <div id="sidebar-overlay"></div>
        <div class="toolbar">
            <button class="menu-toggle" id="menuToggle" title="æ˜¾ç¤º/éšè—ä¾§è¾¹æ ">â˜°</button>
            <input type="text" id="titleInput" class="title-input" placeholder="æ— æ ‡é¢˜æ–‡æ¡£">
            <div class="toolbar-actions">
                <div class="format-bar">
                    <select id="blockFormat" class="format-switch" title="æ®µè½/æ ‡é¢˜">
                        <option value="P">æ­£æ–‡</option>
                        <option value="H1">æ ‡é¢˜ 1</option>
                        <option value="H2">æ ‡é¢˜ 2</option>
                        <option value="H3">æ ‡é¢˜ 3</option>
                    </select>
                    <button class="toolbar-btn" data-cmd="bold" title="åŠ ç²— (Ctrl+B)"><b>B</b></button>
                    <button class="toolbar-btn" data-cmd="italic" title="æ–œä½“ (Ctrl+I)"><i>I</i></button>
                    <button class="toolbar-btn" data-cmd="underline" title="ä¸‹åˆ’çº¿ (Ctrl+U)"><u>U</u></button>
                    <div class="divider"></div>
                    <button class="toolbar-btn" data-cmd="insertUnorderedList" title="æ— åºåˆ—è¡¨">â€¢â–¸</button>
                    <button class="toolbar-btn" data-cmd="insertOrderedList" title="æœ‰åºåˆ—è¡¨">1â–¸</button>
                    <button class="toolbar-btn" id="quoteBtn" title="å¼•ç”¨">â â</button>
                    <div class="divider"></div>
                    <button class="toolbar-btn" id="clearFormatBtn" title="æ¸…é™¤æ ¼å¼">ğŸ§¹</button>
                    <div class="divider"></div>
                    <button class="toolbar-btn" id="undoBtn" title="æ’¤é”€ (Ctrl+Z)">â†¶</button>
                    <button class="toolbar-btn" id="redoBtn" title="é‡åš (Ctrl+Y)">â†·</button>
                </div>
                <div class="divider"></div>
                <div class="format-bar">
                    <button class="toolbar-btn" id="tplPerson" title="æ’å…¥äººç‰©å¡">ğŸ§‘â€ğŸ¤</button>
                    <button class="toolbar-btn" id="tplScene" title="æ’å…¥åœºæ™¯å¡">ğŸï¸</button>
                    <button class="toolbar-btn" id="tplWorld" title="æ’å…¥ä¸–ç•Œè§‚">ğŸŒ</button>
                </div>
                <div class="divider"></div>
                <button class="toolbar-btn" id="exportTxt" title="å¯¼å‡º .txt">ğŸ“¤ TXT</button>
                <button class="toolbar-btn" id="exportMd" title="å¯¼å‡º .md">ğŸ“¤ MD</button>
                <div class="save-indicator" id="saveIndicator">å·²ä¿å­˜</div>
            </div>
        </div>

        <div id="editor-wrapper">
            <div id="editor" contenteditable="true"></div>
        </div>

        <div class="word-count">
            <div>å­—æ•°ï¼š<span id="charCount">0</span></div>
            <div>æ®µè½ï¼š<span id="paraCount">0</span></div>
            <div class="goal">
                ä»Šæ—¥ç›®æ ‡ï¼š<span id="goalNum">1000</span>
                <div class="progress-bar"><div id="goalProgress" class="progress"></div></div>
                <span id="goalNow">0</span>
                <button id="setGoalBtn" class="toolbar-btn" title="è®¾ç½®ç›®æ ‡">âš™ï¸</button>
            </div>
        </div>
    </div>

    <!-- Settings Drawer -->
    <div id="drawerOverlay"></div>
    <aside id="settingsDrawer">
        <div class="drawer-header">
            <span>å…¨å±€è®¾ç½®</span>
            <button id="closeDrawer" class="icon-btn">âœ–</button>
        </div>
        <div class="drawer-body">
            <div class="form-group">
                <label>ä¸»é¢˜</label>
                <div class="radio-row" id="themeChips">
                    <button class="chip" data-theme="light">æ˜äº®</button>
                    <button class="chip" data-theme="dark">æš—é»‘</button>
                    <button class="chip" data-theme="sepia">ä»¿å¤</button>
                    <button class="chip" data-theme="solar">æ¸…æœ—</button>
                    <button class="chip" data-theme="night">å¤œè“</button>
                </div>
            </div>
            <div class="form-group">
                <label>ä»Šæ—¥ç›®æ ‡å­—æ•°</label>
                <input id="goalInput" class="num-input" type="number" min="0" step="100" placeholder="1000">
            </div>
            <div class="form-group">
                <label>ç•Œé¢å¯†åº¦</label>
                <div class="radio-row" id="densityChips">
                    <button class="chip" data-density="comfortable">èˆ’é€‚</button>
                    <button class="chip" data-density="compact">ç´§å‡‘</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Snackbar -->
    <div id="snackbar"><span id="snackMsg"></span><span id="snackAction" class="snack-action"></span></div>

    <script>
        // Utilities
        function $(sel) { return document.querySelector(sel); }
        function $all(sel) { return Array.from(document.querySelectorAll(sel)); }
        function createEl(tag, cls) { const el = document.createElement(tag); if (cls) el.className = cls; return el; }
        function debounce(fn, wait) { let t; return function(...args){ clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); }; }
        function throttleRaf(fn) { let ticking = false; return function(...args){ if (ticking) return; ticking = true; requestAnimationFrame(() => { fn.apply(this, args); ticking = false; }); }; }
        function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
        function todayKey() { const d = new Date(); return d.toISOString().slice(0,10); }

        // Storage
        const STORAGE_KEYS = {
            DOCS: 'novelDocs',
            FOLDERS: 'novelFolders',
            FOLDER_STATE: 'novelFolderState',
            CURRENT_ID: 'currentDocId',
            THEME: 'theme',
            GOAL: 'dailyGoal',
            PROGRESS: 'dailyProgress',
            DENSITY: 'uiDensity'
        };
        function loadDocs() { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.DOCS) || '[]'); } catch { return []; } }
        function saveDocs(v) { localStorage.setItem(STORAGE_KEYS.DOCS, JSON.stringify(v)); }
        function loadFolders() { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.FOLDERS) || '[]'); } catch { return []; } }
        function saveFolders(v) { localStorage.setItem(STORAGE_KEYS.FOLDERS, JSON.stringify(v)); }
        function loadFolderState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.FOLDER_STATE) || '{}'); } catch { return {}; } }
        function saveFolderState(v) { localStorage.setItem(STORAGE_KEYS.FOLDER_STATE, JSON.stringify(v)); }
        function getCurrentId() { return localStorage.getItem(STORAGE_KEYS.CURRENT_ID); }
        function setCurrentId(id) { localStorage.setItem(STORAGE_KEYS.CURRENT_ID, id); }
        function generateId(prefix='id') { return prefix + '_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
        function loadTheme() { return localStorage.getItem(STORAGE_KEYS.THEME) || 'light'; }
        function saveTheme(theme) { localStorage.setItem(STORAGE_KEYS.THEME, theme); }
        function loadGoal() { const n = parseInt(localStorage.getItem(STORAGE_KEYS.GOAL) || '1000', 10); return Number.isFinite(n) ? n : 1000; }
        function saveGoal(n) { localStorage.setItem(STORAGE_KEYS.GOAL, String(n)); }
        function loadProgressMap() { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.PROGRESS) || '{}'); } catch { return {}; } }
        function saveProgressMap(map) { localStorage.setItem(STORAGE_KEYS.PROGRESS, JSON.stringify(map)); }
        function loadDensity() { return localStorage.getItem(STORAGE_KEYS.DENSITY) || 'comfortable'; }
        function saveDensity(v) { localStorage.setItem(STORAGE_KEYS.DENSITY, v); }

        // App state
        let docs = loadDocs();
        let folders = loadFolders();
        let folderOpenState = loadFolderState();
        let currentDocId = getCurrentId();
        let isSaving = false;
        let lastCharCountForProgress = 0;
        let draggedDocId = null;
        let lastDeleted = null; // {doc, prevId}

        // Elements
        const sidebar = $('#sidebar');
        const overlay = $('#sidebar-overlay');
        const editor = $('#editor');
        const treeEl = $('#tree');
        const titleInput = $('#titleInput');
        const charCountEl = $('#charCount');
        const paraCountEl = $('#paraCount');
        const saveIndicator = $('#saveIndicator');
        const goalNum = $('#goalNum');
        const goalNow = $('#goalNow');
        const goalProgress = $('#goalProgress');
        const drawer = $('#settingsDrawer');
        const drawerOverlay = $('#drawerOverlay');
        const goalInput = $('#goalInput');

        // Theme setup
        function applyTheme(theme){ document.documentElement.setAttribute('data-theme', theme); selectThemeChip(theme); }
        applyTheme(loadTheme());

        // Density setup
        function applyDensity(density) {
            document.body.dataset.density = density;
            // simple density tuning via CSS vars
            if (density === 'compact') {
                document.documentElement.style.setProperty('--editor-width', '720px');
            } else {
                document.documentElement.style.setProperty('--editor-width', '780px');
            }
            selectDensityChip(density);
        }
        applyDensity(loadDensity());

        // Initialize folders/docs if empty
        if (!docs.length) {
            const id = generateId('doc');
            const now = Date.now();
            docs.push({ id, title: 'æˆ‘çš„å†™ä½œç¬”è®°', content: '<p>è¿™æ˜¯ä¸€ä¸ªçº¯ç²¹ä¸“æ³¨çš„å†™ä½œç¯å¢ƒã€‚</p><p>åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥è‡ªç”±åœ°åˆ›ä½œï¼Œä¸å—å¹²æ‰°ã€‚</p><p>ä½¿ç”¨å·¦ä¾§çš„ç›®å½•ç®¡ç†æ‚¨çš„æ–‡æ¡£ä¸æ–‡ä»¶å¤¹ã€‚</p>', starred: false, createdAt: now, updatedAt: now, folderId: null });
            saveDocs(docs);
            currentDocId = id;
            setCurrentId(id);
        }
        if (!folders.length) {
            const fid = generateId('fld');
            folders.push({ id: fid, name: 'æˆ‘çš„ä½œå“', parentId: null });
            folderOpenState[fid] = true;
            saveFolders(folders);
            saveFolderState(folderOpenState);
        }

        // Tree helpers
        function getChildrenFolders(parentId) { return folders.filter(f => f.parentId === parentId); }
        function getFolderDocs(folderId) { return docs.filter(d => (d.folderId || null) === (folderId || null)); }
        function isOpen(folderId) { return !!folderOpenState[folderId]; }
        function setOpen(folderId, open) { folderOpenState[folderId] = open; saveFolderState(folderOpenState); }

        function renderTree(filter = '') {
            const keyword = filter.trim().toLowerCase();
            treeEl.innerHTML = '';

            // Root drop target
            const rootDrop = createEl('div', 'tree-root-drop');
            rootDrop.textContent = 'æ‹–åŠ¨æ–‡æ¡£åˆ°æ­¤å¤„ç§»åŠ¨åˆ°æ ¹ç›®å½•';
            rootDrop.addEventListener('dragover', (e) => { e.preventDefault(); rootDrop.classList.add('dragover'); });
            rootDrop.addEventListener('dragleave', () => rootDrop.classList.remove('dragover'));
            rootDrop.addEventListener('drop', (e) => { e.preventDefault(); rootDrop.classList.remove('dragover'); moveDocToFolder(draggedDocId, null); });
            treeEl.appendChild(rootDrop);

            // Root docs (no folder)
            const rootDocs = getFolderDocs(null).sort(sortDoc);
            for (const d of rootDocs) {
                if (keyword && !d.title.toLowerCase().includes(keyword)) continue;
                treeEl.appendChild(renderDocNode(d, 0));
            }

            // Recursive folders
            function renderFolder(folder, level) {
                const row = createEl('div', 'folder-node');
                row.dataset.folderId = folder.id;
                if (!isOpen(folder.id)) row.classList.add('collapsed');
                const indent = createEl('div', 'indent'); indent.style.marginLeft = (level * 14) + 'px';
                const caret = createEl('div', 'caret'); caret.textContent = isOpen(folder.id) ? 'â–¾' : 'â–¸';
                caret.addEventListener('click', () => { const open = !isOpen(folder.id); setOpen(folder.id, open); caret.textContent = open ? 'â–¾' : 'â–¸'; children.style.display = open ? '' : 'none'; });
                const icon = createEl('div'); icon.textContent = 'ğŸ“';
                const title = createEl('div', 'folder-title'); title.textContent = folder.name;
                const actions = createEl('div', 'node-actions');
                const addBtn = createEl('button', 'icon-btn'); addBtn.title = 'æ–°å»ºå­æ–‡ä»¶å¤¹'; addBtn.textContent = 'ï¼‹';
                addBtn.addEventListener('click', (e) => { e.stopPropagation(); createFolder(folder.id); });
                const renameBtn = createEl('button', 'icon-btn'); renameBtn.title = 'é‡å‘½å'; renameBtn.textContent = 'âœ';
                renameBtn.addEventListener('click', (e) => { e.stopPropagation(); inlineRenameFolder(folder.id, title); });
                const delBtn = createEl('button', 'icon-btn'); delBtn.title = 'åˆ é™¤æ–‡ä»¶å¤¹'; delBtn.textContent = 'ğŸ—‘ï¸';
                delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteFolder(folder.id); });
                actions.appendChild(addBtn); actions.appendChild(renameBtn); actions.appendChild(delBtn);

                row.appendChild(indent); row.appendChild(caret); row.appendChild(icon); row.appendChild(title); row.appendChild(actions);
                row.addEventListener('dragover', (e) => { e.preventDefault(); row.classList.add('drop-target'); });
                row.addEventListener('dragleave', () => row.classList.remove('drop-target'));
                row.addEventListener('drop', (e) => { e.preventDefault(); row.classList.remove('drop-target'); moveDocToFolder(draggedDocId, folder.id); });

                const children = createEl('div', 'children');
                children.style.display = isOpen(folder.id) ? '' : 'none';

                // docs
                const docsIn = getFolderDocs(folder.id).sort(sortDoc);
                for (const d of docsIn) {
                    if (keyword && !d.title.toLowerCase().includes(keyword)) continue;
                    children.appendChild(renderDocNode(d, level + 1));
                }
                // subfolders
                const sub = getChildrenFolders(folder.id).sort((a,b) => a.name.localeCompare(b.name));
                for (const sf of sub) children.appendChild(renderFolder(sf, level + 1));

                const container = createEl('div');
                container.appendChild(row);
                container.appendChild(children);
                return container;
            }

            const topFolders = getChildrenFolders(null).sort((a,b) => a.name.localeCompare(b.name));
            for (const f of topFolders) treeEl.appendChild(renderFolder(f, 0));
        }

        function renderDocNode(doc, level) {
            const row = createEl('div', 'doc-node');
            row.draggable = true;
            row.dataset.docId = doc.id;
            if (doc.id === currentDocId) row.classList.add('active');
            const indent = createEl('div', 'indent'); indent.style.marginLeft = (level * 14) + 'px';
            const icon = createEl('div'); icon.textContent = 'ğŸ“';
            const title = createEl('div', 'doc-title'); title.textContent = doc.title || 'æ— æ ‡é¢˜';
            const actions = createEl('div', 'node-actions');
            const starBtn = createEl('button', 'icon-btn'); starBtn.innerHTML = doc.starred ? 'â­' : 'â˜†'; starBtn.title = doc.starred ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—';
            starBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleStar(doc.id); });
            const delBtn = createEl('button', 'icon-btn'); delBtn.textContent = 'ğŸ—‘ï¸'; delBtn.title = 'åˆ é™¤æ–‡æ¡£';
            delBtn.addEventListener('click', (e) => { e.stopPropagation(); softDeleteDoc(doc.id); });
            actions.appendChild(starBtn); actions.appendChild(delBtn);

            row.appendChild(indent); row.appendChild(icon); row.appendChild(title); row.appendChild(actions);
            row.addEventListener('click', () => selectDoc(doc.id));
            row.addEventListener('dragstart', () => { draggedDocId = doc.id; });
            row.addEventListener('dragend', () => { draggedDocId = null; });
            return row;
        }

        function sortDoc(a, b) { return (b.starred - a.starred) || (b.updatedAt - a.updatedAt); }

        function selectDoc(id) {
            const doc = docs.find(x => x.id === id);
            if (!doc) return;
            currentDocId = id;
            setCurrentId(id);
            titleInput.value = doc.title || '';
            editor.innerHTML = doc.content || '';
            lastCharCountForProgress = measureCharCount(editor.innerText);
            updateWordStats();
            renderTree($('#searchInput').value);
            markSaved(true);
        }

        function createDoc(initialContent = '<p></p>', folderId = null) {
            const id = generateId('doc');
            const now = Date.now();
            const newDoc = { id, title: 'æ— æ ‡é¢˜æ–‡æ¡£', content: initialContent, starred: false, createdAt: now, updatedAt: now, folderId };
            docs.unshift(newDoc);
            saveDocs(docs);
            selectDoc(id);
            titleInput.focus();
        }

        function moveDocToFolder(docId, folderId) {
            const doc = docs.find(d => d.id === docId);
            if (!doc) return;
            doc.folderId = folderId || null;
            doc.updatedAt = Date.now();
            saveDocs(docs);
            renderTree($('#searchInput').value);
        }

        function softDeleteDoc(id) {
            const idx = docs.findIndex(d => d.id === id);
            if (idx === -1) return;
            const removed = docs.splice(idx, 1)[0];
            saveDocs(docs);
            if (currentDocId === id) {
                if (docs.length) selectDoc(docs[0].id); else { createDoc(); }
            }
            renderTree($('#searchInput').value);
            lastDeleted = { doc: removed };
            showSnack('å·²åˆ é™¤æ–‡æ¡£', 'æ’¤é”€', () => { if (!lastDeleted) return; docs.unshift(lastDeleted.doc); saveDocs(docs); lastDeleted = null; renderTree($('#searchInput').value); });
        }

        function toggleStar(id) {
            const doc = docs.find(d => d.id === id);
            if (!doc) return;
            doc.starred = !doc.starred;
            doc.updatedAt = Date.now();
            saveDocs(docs);
            renderTree($('#searchInput').value);
        }

        function createFolder(parentId = null) {
            const id = generateId('fld');
            const f = { id, name: 'æ–°å»ºæ–‡ä»¶å¤¹', parentId: parentId || null };
            folders.push(f);
            folderOpenState[id] = true;
            saveFolders(folders); saveFolderState(folderOpenState);
            renderTree($('#searchInput').value);
        }

        function inlineRenameFolder(folderId, titleEl) {
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;
            const old = folder.name;
            const input = document.createElement('input');
            input.type = 'text'; input.value = old; input.style.width = '100%';
            titleEl.replaceWith(input);
            input.focus(); input.select();
            const commit = () => { folder.name = input.value.trim() || old; saveFolders(folders); renderTree($('#searchInput').value); };
            input.addEventListener('blur', commit);
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } if (e.key === 'Escape') { folder.name = old; input.blur(); } });
        }

        function deleteFolder(folderId) {
            // move docs in folder to root, and reparent subfolders to its parent
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;
            const parentId = folder.parentId || null;
            for (const d of docs) { if (d.folderId === folderId) d.folderId = parentId; }
            for (const f of folders) { if (f.parentId === folderId) f.parentId = parentId; }
            folders = folders.filter(f => f.id !== folderId);
            saveDocs(docs); saveFolders(folders);
            showSnack('æ–‡ä»¶å¤¹å·²åˆ é™¤ï¼ˆå†…å®¹å·²ä¸Šç§»ï¼‰');
            renderTree($('#searchInput').value);
        }

        // Saving
        function markSaved(saved) {
            isSaving = !saved;
            saveIndicator.textContent = saved ? 'å·²ä¿å­˜' : 'ä¿å­˜ä¸­â€¦';
            saveIndicator.style.color = saved ? 'var(--muted-text)' : 'var(--primary-color)';
        }

        const persist = debounce(function persistNow(){
            const doc = docs.find(d => d.id === currentDocId);
            if (!doc) return;
            doc.title = titleInput.value.trim() || 'æ— æ ‡é¢˜æ–‡æ¡£';
            doc.content = editor.innerHTML;
            doc.updatedAt = Date.now();
            saveDocs(docs);
            markSaved(true);
            renderTree($('#searchInput').value);
        }, 400);

        function saveNow() { markSaved(false); persist(); }

        // Word stats
        function measureCharCount(text) { if (!text) return 0; return text.replace(/\s+/g, '').length; }
        const updateWordStats = throttleRaf(function(){
            const text = editor.innerText || '';
            const chars = measureCharCount(text);
            const paras = (editor.innerHTML.match(/<p[\s>]|<h[1-6][\s>]|<li[\s>]|<blockquote[\s>]/gi) || []).length || (text ? text.split(/\n{2,}/).length : 0);
            charCountEl.textContent = chars;
            paraCountEl.textContent = paras;
            updateDailyProgress(chars);
        });

        // Daily goal
        function updateDailyProgress(currentChars){
            const key = todayKey();
            const map = loadProgressMap();
            const before = lastCharCountForProgress;
            const delta = Math.max(0, currentChars - before);
            if (delta > 0) {
                map[key] = (map[key] || 0) + delta;
                saveProgressMap(map);
                lastCharCountForProgress = currentChars;
            }
            const goal = loadGoal();
            goalNum.textContent = goal;
            const now = (loadProgressMap()[key] || 0);
            goalNow.textContent = now;
            const pct = goal === 0 ? 1 : clamp(now / goal, 0, 1);
            goalProgress.style.width = (pct * 100).toFixed(1) + '%';
        }

        // Formatting
        function exec(cmd, val = null){ document.execCommand(cmd, false, val); editor.focus(); }
        function setBlock(tag){ document.execCommand('formatBlock', false, tag); editor.focus(); }

        // Templates
        const TEMPLATES = {
            person: `<h2>äººç‰©å¡</h2><p><strong>å§“åï¼š</strong></p><p><strong>å¹´é¾„ï¼š</strong></p><p><strong>å¤–è²Œç‰¹å¾ï¼š</strong></p><p><strong>æ€§æ ¼æ ‡ç­¾ï¼š</strong></p><p><strong>èƒŒæ™¯æ•…äº‹ï¼š</strong></p><p><strong>ç›®æ ‡/åŠ¨æœºï¼š</strong></p><p><strong>äººé™…å…³ç³»ï¼š</strong></p>` ,
            scene: `<h2>åœºæ™¯å¡</h2><p><strong>åœ°ç‚¹ï¼š</strong></p><p><strong>æ—¶é—´ï¼š</strong></p><p><strong>å¤©æ°”/æ°›å›´ï¼š</strong></p><p><strong>ç™»åœºäººç‰©ï¼š</strong></p><p><strong>å†²çªç‚¹ï¼š</strong></p><p><strong>ç»†èŠ‚é“å…·ï¼š</strong></p><p><strong>èŠ‚å¥/å¼ åŠ›ï¼š</strong></p>`,
            world: `<h2>ä¸–ç•Œè§‚</h2><p><strong>æ—¶ä»£èƒŒæ™¯ï¼š</strong></p><p><strong>åœ°ç†è®¾å®šï¼š</strong></p><p><strong>ç¤¾ä¼šç»“æ„ï¼š</strong></p><p><strong>ç§‘æŠ€/é­”æ³•ä½“ç³»ï¼š</strong></p><p><strong>å®—æ•™/æ–‡åŒ–ï¼š</strong></p><p><strong>ç¦å¿Œä¸è§„åˆ™ï¼š</strong></p><p><strong>æ ¸å¿ƒçŸ›ç›¾ï¼š</strong></p>`
        };
        function insertTemplate(name){ exec('insertHTML', TEMPLATES[name]); saveNow(); }

        // Export / Import
        function htmlToText(html){ const tmp = document.createElement('div'); tmp.innerHTML = html; const walker = document.createTreeWalker(tmp, NodeFilter.SHOW_TEXT, null); let out = ''; let node; while ((node = walker.nextNode())) { out += node.nodeValue; } out = out.replace(/\n{3,}/g, '\n\n'); return out.trim(); }
        function htmlToMarkdown(html){
            let md = html
                .replace(/<\/?strong>/gi, '**')
                .replace(/<\/?b>/gi, '**')
                .replace(/<\/?em>/gi, '*')
                .replace(/<\/?i>/gi, '*')
                .replace(/<u>(.*?)<\/u>/gi, '$1')
                .replace(/<br\s*\/?>(?=\s*<)/gi, '\n')
                .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
                .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
                .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
                .replace(/<blockquote[^>]*>([\s\S]*?)<\/blockquote>/gi, (m, p1) => p1.split(/\n/).map(l => '> ' + l).join('\n') + '\n\n')
                .replace(/<li[^>]*>([\s\S]*?)<\/li>/gi, '- $1\n')
                .replace(/<ul[^>]*>([\s\S]*?)<\/ul>/gi, '$1\n')
                .replace(/<ol[^>]*>([\s\S]*?)<\/ol>/gi, '$1\n')
                .replace(/<p[^>]*>([\s\S]*?)<\/p>/gi, '$1\n\n')
                .replace(/<br\s*\/?>(?!\n)/gi, '\n')
                .replace(/<[^>]+>/g, '')
                .replace(/\n{3,}/g, '\n\n')
                .trim();
            return md;
        }
        function download(name, content, type){ const blob = new Blob([content], { type }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click(); setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0); }

        // Snackbar
        let snackTimer = null;
        function showSnack(msg, actionText, action) {
            $('#snackMsg').textContent = msg;
            const act = $('#snackAction');
            if (actionText && action) { act.textContent = actionText; act.style.display = 'inline'; act.onclick = () => { hideSnack(); action(); }; } else { act.textContent = ''; act.style.display = 'none'; act.onclick = null; }
            const el = $('#snackbar'); el.classList.add('show');
            clearTimeout(snackTimer);
            snackTimer = setTimeout(hideSnack, 3000);
        }
        function hideSnack(){ $('#snackbar').classList.remove('show'); }

        // Settings Drawer
        function openDrawer() { drawer.classList.add('show'); drawerOverlay.style.display = 'block'; goalInput.value = loadGoal(); selectThemeChip(loadTheme()); selectDensityChip(loadDensity()); }
        function closeDrawer() { drawer.classList.remove('show'); drawerOverlay.style.display = 'none'; }
        function selectThemeChip(theme) { $all('#themeChips .chip').forEach(c => c.classList.toggle('active', c.dataset.theme === theme)); }
        function selectDensityChip(d) { $all('#densityChips .chip').forEach(c => c.classList.toggle('active', c.dataset.density === d)); }

        // Bind toolbar
        function bindToolbar() {
            document.querySelectorAll('.toolbar-btn[data-cmd]').forEach(btn => {
                btn.addEventListener('click', () => { const cmd = btn.getAttribute('data-cmd'); exec(cmd); saveNow(); });
            });
            $('#quoteBtn').addEventListener('click', () => { setBlock('BLOCKQUOTE'); saveNow(); });
            $('#clearFormatBtn').addEventListener('click', () => { exec('removeFormat'); saveNow(); });
            $('#undoBtn').addEventListener('click', () => exec('undo'));
            $('#redoBtn').addEventListener('click', () => exec('redo'));
            $('#blockFormat').addEventListener('change', (e) => { setBlock(e.target.value); saveNow(); });

            $('#tplPerson').addEventListener('click', () => insertTemplate('person'));
            $('#tplScene').addEventListener('click', () => insertTemplate('scene'));
            $('#tplWorld').addEventListener('click', () => insertTemplate('world'));

            $('#exportTxt').addEventListener('click', () => { const doc = docs.find(d => d.id === currentDocId); if (!doc) return; download((doc.title || 'å¯¼å‡º') + '.txt', htmlToText(doc.content || ''), 'text/plain;charset=utf-8'); });
            $('#exportMd').addEventListener('click', () => { const doc = docs.find(d => d.id === currentDocId); if (!doc) return; download((doc.title || 'å¯¼å‡º') + '.md', htmlToMarkdown(doc.content || ''), 'text/markdown;charset=utf-8'); });
        }

        // Global bindings
        function bindGlobal() {
            // Sidebar
            $('#menuToggle').addEventListener('click', () => sidebar.classList.toggle('show'));
            overlay.addEventListener('click', () => sidebar.classList.remove('show'));

            // Theme quick toggle (light/dark)
            $('#themeToggle').addEventListener('click', () => { const cur = loadTheme(); const next = (cur === 'dark') ? 'light' : 'dark'; saveTheme(next); applyTheme(next); showSnack('ä¸»é¢˜ï¼š' + (next === 'dark' ? 'æš—é»‘' : 'æ˜äº®')); });

            // Focus mode
            $('#focusToggle').addEventListener('click', () => { document.body.classList.toggle('focus-mode'); showSnack(document.body.classList.contains('focus-mode') ? 'å·²è¿›å…¥ä¸“æ³¨æ¨¡å¼' : 'å·²é€€å‡ºä¸“æ³¨æ¨¡å¼'); });

            // New doc/folder
            $('#newDocBtn').addEventListener('click', () => createDoc());
            $('#newFolderBtn').addEventListener('click', () => createFolder(null));

            // Search
            $('#searchInput').addEventListener('input', debounce((e) => renderTree(e.target.value), 120));

            // Import
            $('#importBtn').addEventListener('click', () => $('#importFile').click());
            $('#importFile').addEventListener('change', async (e) => { const file = e.target.files && e.target.files[0]; if (!file) return; const text = await file.text(); createDoc('<p>' + text.replace(/[\r\n]+/g, '</p><p>') + '</p>'); e.target.value = ''; showSnack('å·²å¯¼å…¥ï¼š' + file.name); });

            // Title / Editor
            titleInput.addEventListener('input', () => { markSaved(false); persist(); renderTree($('#searchInput').value); });
            editor.addEventListener('input', () => { markSaved(false); updateWordStats(); persist(); });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                const mod = e.ctrlKey || e.metaKey;
                if (mod && e.key.toLowerCase() === 's') { e.preventDefault(); saveNow(); showSnack('å·²ä¿å­˜'); }
                if (mod && e.key.toLowerCase() === 'b') { e.preventDefault(); exec('bold'); saveNow(); }
                if (mod && e.key.toLowerCase() === 'i') { e.preventDefault(); exec('italic'); saveNow(); }
                if (mod && e.key.toLowerCase() === 'u') { e.preventDefault(); exec('underline'); saveNow(); }
                if (mod && e.key.toLowerCase() === '1') { e.preventDefault(); setBlock('H1'); saveNow(); }
                if (mod && e.key.toLowerCase() === '2') { e.preventDefault(); setBlock('H2'); saveNow(); }
                if (mod && e.key.toLowerCase() === '3') { e.preventDefault(); setBlock('H3'); saveNow(); }
                if (mod && e.shiftKey && e.key.toLowerCase() === 'f') { e.preventDefault(); document.body.classList.toggle('focus-mode'); }
                if (mod && e.key.toLowerCase() === 'k') { e.preventDefault(); $('#searchInput').focus(); }
            }, { passive: false });

            // Settings drawer
            $('#settingsBtn').addEventListener('click', openDrawer);
            $('#setGoalBtn').addEventListener('click', openDrawer);
            $('#closeDrawer').addEventListener('click', closeDrawer);
            drawerOverlay.addEventListener('click', closeDrawer);

            // Theme select in drawer
            $all('#themeChips .chip').forEach(chip => chip.addEventListener('click', () => { const theme = chip.dataset.theme; saveTheme(theme); applyTheme(theme); showSnack('ä¸»é¢˜ï¼š' + chip.textContent); }));

            // Density select
            $all('#densityChips .chip').forEach(chip => chip.addEventListener('click', () => { const d = chip.dataset.density; saveDensity(d); applyDensity(d); showSnack('ç•Œé¢å¯†åº¦ï¼š' + (d === 'compact' ? 'ç´§å‡‘' : 'èˆ’é€‚')); }));

            // Goal input (live apply)
            goalInput.addEventListener('change', () => { const n = parseInt(goalInput.value || '0', 10); if (Number.isFinite(n) && n >= 0) { saveGoal(n); updateWordStats(); showSnack('å·²æ›´æ–°ä»Šæ—¥ç›®æ ‡ï¼š' + n); } });
        }

        // Boot
        bindToolbar();
        bindGlobal();
        renderTree();
        selectDoc(currentDocId || docs[0].id);
        updateWordStats();
    </script>
</body>
</html>