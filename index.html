<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Á∫ØÁ∫ØÂÜô‰Ωú ¬∑ Â∞èËØ¥Âàõ‰ΩúÂ∑•‰ΩúÂè∞ÔºàÁßªÂä®Á´ØÔºâ</title>
    <style>
        :root {
            --sidebar-width: 86vw;
            --primary-color: #4a86e8;
            --text-color: #222;
            --muted-text: #666;
            --bg-color: #f7f8fa;
            --panel-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 2px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 6px 18px rgba(0,0,0,0.08);
            --accent: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --link: #2563eb;
            --editor-width: 100%;
            --tree-indent: 18px;
            --hover-bg: rgba(127,127,127,0.06);
            --active-bg: rgba(74,134,232,0.12);
            --mobile-bar-height: 44px;
            --name-bar-height: 40px;
            --mobile-rows: 1;
            --name-rows: 1;
            --caret-color: #4a86e8;
            --name-font-size: 14px;
        }

        [data-theme="dark"] {
            --primary-color: #6ea8fe;
            --text-color: #e5e7eb;
            --muted-text: #9ca3af;
            --bg-color: #0f1116;
            --panel-bg: #161a23;
            --border-color: #262a36;
            --shadow-sm: 0 2px 6px rgba(0,0,0,0.35);
            --shadow-md: 0 6px 18px rgba(0,0,0,0.35);
            --accent: #34d399;
            --danger: #f87171;
            --warning: #f59e0b;
            --link: #93c5fd;
            --hover-bg: rgba(255,255,255,0.05);
            --active-bg: rgba(110,168,254,0.15);
            --caret-color: #6ea8fe;
        }

        [data-theme="sepia"] {
            --primary-color: #8b5e34;
            --text-color: #3e2c1c;
            --muted-text: #7b6a58;
            --bg-color: #f3ead7;
            --panel-bg: #faf3e3;
            --border-color: #e1d7c6;
            --accent: #9c6f3d;
            --warning: #c48f3c;
            --link: #7a4e2b;
            --hover-bg: rgba(139,94,52,0.07);
            --active-bg: rgba(139,94,52,0.12);
            --caret-color: #8b5e34;
        }

        [data-theme="eye"] {
            --primary-color: #3aa675;
            --text-color: #1a2b22;
            --muted-text: #587a6a;
            --bg-color: #e9f5ef;
            --panel-bg: #f6fbf8;
            --border-color: #d7ece2;
            --accent: #2bb673;
            --warning: #cc9a06;
            --link: #2f8f6b;
            --hover-bg: rgba(58,166,117,0.08);
            --active-bg: rgba(58,166,117,0.14);
            --caret-color: #2f8f6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; }
        html, body { height: 100%; }
        body { background-color: var(--bg-color); color: var(--text-color); display: flex; overflow: hidden; }

        /* Sidebar */
        #sidebar { width: var(--sidebar-width); max-width: 100vw; height: 100%; background-color: var(--panel-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transition: transform 0.26s ease; z-index: 40; box-shadow: var(--shadow-sm); position: fixed; left: 0; top: 0; transform: translateX(-100%); overflow: hidden; }
        #sidebar.show { transform: translateX(0); }
        .sidebar-header { padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; }
        .logo { width: 24px; height: 24px; border-radius: 6px; background: linear-gradient(135deg, var(--primary-color), #7cc5ff); box-shadow: var(--shadow-sm); }
        .sidebar-title { font-size: 1rem; font-weight: 700; letter-spacing: 0.4px; color: var(--primary-color); }
        .sidebar-actions { margin-left: auto; display: flex; gap: 6px; }
        .icon-btn { background: none; border: 1px solid var(--border-color); color: var(--muted-text); cursor: pointer; border-radius: 8px; padding: 6px 8px; transition: all 0.15s ease; }
        .icon-btn:hover { background-color: var(--hover-bg); }
        .sidebar-search { padding: 8px 10px; border-bottom: 1px solid var(--border-color); display: flex; gap: 6px; }
        .search-input { flex: 1; border: 1px solid var(--border-color); background: transparent; border-radius: 8px; padding: 8px 10px; color: var(--text-color); font-size: 14px; }
        .search-input:focus { outline: 2px solid rgba(74,134,232,0.25); }
        .menu-section-title { font-size: 12px; color: var(--muted-text); padding: 8px 12px; text-transform: uppercase; letter-spacing: 1.2px; }
        #docList { flex: 1; overflow: auto; }
        .tree { padding: 6px 6px calc(16px + env(safe-area-inset-bottom)); }
        .tree-root-drop { margin: 0 10px 8px 10px; padding: 6px 8px; border-radius: 6px; color: var(--muted-text); border: 1px dashed var(--border-color); font-size: 12px; position: sticky; top: 0; background: var(--panel-bg); z-index: 1; }
        .tree-root-drop.dragover { background: var(--active-bg); }
        .folder-node, .doc-node { position: relative; display: flex; align-items: center; gap: 8px; padding: 8px 8px 8px 10px; border-radius: 8px; margin: 2px 6px; overflow: hidden; }
        .folder-node:hover, .doc-node:hover { background: var(--hover-bg); }
        .doc-node.active { background: var(--active-bg); }
        .indent { width: var(--tree-indent); flex: 0 0 var(--tree-indent); height: 1px; }
        .caret { width: 16px; text-align: center; cursor: pointer; color: var(--muted-text); }
        .folder-title { font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .doc-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .node-actions { display: flex; gap: 4px; }
        .node-actions .icon-btn { padding: 4px 6px; border-radius: 6px; }
        .children { margin-left: calc(var(--tree-indent) + 8px); }
        .drop-target { outline: 2px dashed var(--primary-color); }
        .drop-before::before, .drop-after::after { content: ""; position: absolute; left: 8px; right: 8px; height: 0; border-top: 2px solid var(--primary-color); }
        .drop-before::before { top: -1px; }
        .drop-after::after { bottom: -1px; }
        .sidebar-footer { border-top: 1px solid var(--border-color); padding: 8px 10px; display: flex; gap: 10px; }
        .primary-btn { background: var(--primary-color); color: #fff; border: none; padding: 8px 10px; border-radius: 8px; cursor: pointer; box-shadow: var(--shadow-sm); }
        .primary-btn:hover { filter: brightness(1.05); }

        /* Main */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; }
        .toolbar { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 8px; padding: 8px 10px; background-color: var(--panel-bg); border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 30; }
        .menu-toggle { background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 6px; color: var(--muted-text); }
        .title-input { width: 100%; border: 1px solid transparent; border-radius: 8px; padding: 8px 10px; background: transparent; color: var(--text-color); font-size: 0.95rem; font-weight: 600; }
        .title-input:focus { outline: 2px solid rgba(74,134,232,0.25); }
        #toolsBtn { background: none; border: 1px solid var(--border-color); border-radius: 8px; padding: 6px 8px; color: var(--muted-text); }
        .word-count { padding: 8px 10px; background-color: var(--panel-bg); border-bottom: 1px solid var(--border-color); font-size: 0.9rem; color: var(--muted-text); display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 10px; position: sticky; top: 48px; z-index: 25; }
        .num { font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1, "lnum" 1; min-width: 5ch; text-align: right; display: inline-block; }
        .progress-bar { width: 100%; height: 8px; border-radius: 6px; background: rgba(127,127,127,0.12); overflow: hidden; border: 1px solid var(--border-color); }
        .progress { height: 100%; background: linear-gradient(90deg, var(--accent), #2dd4bf); width: 0%; }
        #editor-wrapper { display: flex; justify-content: center; width: 100%; }
        #editor { width: min(100%, var(--editor-width)); margin: 8px 10px; padding: 14px; font-size: 1rem; line-height: 1.8; background-color: var(--panel-bg); color: var(--text-color); border: none; border-radius: 12px; box-shadow: var(--shadow-md); min-height: 56vh; resize: vertical; caret-color: var(--caret-color); }
        #editor:focus { outline: none; }

        /* Overlays */
        #sidebar-overlay, #drawerOverlay, #toolsOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; z-index: 60; }

        /* Drawers */
        #settingsDrawer, #toolsDrawer { position: fixed; top: 0; right: 0; height: 100%; width: 92vw; max-width: 380px; background: var(--panel-bg); border-left: 1px solid var(--border-color); box-shadow: var(--shadow-md); transform: translateX(100%); transition: transform 0.25s ease; z-index: 70; display: flex; flex-direction: column; }
        #settingsDrawer.show, #toolsDrawer.show { transform: translateX(0); }
        .drawer-header { padding: 12px 14px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; font-weight: 700; }
        .drawer-body { padding: 10px 14px; overflow: auto; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 12px; color: var(--muted-text); }
        .radio-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .chip { border: 1px solid var(--border-color); padding: 6px 10px; border-radius: 999px; cursor: pointer; background: transparent; color: var(--text-color); }
        .chip.active { background: var(--active-bg); border-color: var(--primary-color); }
        .num-input, .text-input, .text-area { width: 100%; border: 1px solid var(--border-color); background: transparent; color: var(--text-color); padding: 8px 10px; border-radius: 8px; }
        .text-area { min-height: 88px; line-height: 1.6; }

        /* Bottom Bars */
        #nameBar { position: fixed; left: 0; right: 0; bottom: calc(var(--mobile-bar-height) + env(safe-area-inset-bottom)); background: var(--panel-bg); border-top: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: none; z-index: 55; }
        #nameBar .row { height: var(--name-bar-height); display: grid; grid-auto-columns: max-content; grid-auto-flow: column; overflow-x: auto; gap: 6px; padding: 6px 8px; }
        #nameBar .n-btn { border: 1px solid var(--border-color); background: transparent; color: var(--text-color); border-radius: 10px; font-size: var(--name-font-size); padding: 4px 10px; white-space: nowrap; }
        #nameBar .n-btn:active { background: var(--hover-bg); }

        #mobileBar { position: fixed; left: 0; right: 0; bottom: 0; background: var(--panel-bg); border-top: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: none; z-index: 55; padding-bottom: env(safe-area-inset-bottom); }
        #mobileBar .row { height: var(--mobile-bar-height); display: grid; grid-auto-columns: 1fr; grid-auto-flow: column; overflow-x: auto; gap: 6px; padding: 6px 8px; }
        #mobileBar .m-btn { border: 1px solid var(--border-color); background: transparent; color: var(--text-color); border-radius: 10px; font-size: 15px; padding: 6px 10px; white-space: nowrap; }
        #mobileBar .m-btn:active { background: var(--hover-bg); }
        .pad-bottom { padding-bottom: calc(16px + var(--mobile-bar-height) * var(--mobile-rows) + env(safe-area-inset-bottom)); }
        .with-name { padding-bottom: calc(16px + var(--mobile-bar-height) * var(--mobile-rows) + var(--name-bar-height) + env(safe-area-inset-bottom)); }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="sidebar-header">
            <div class="logo"></div>
            <div class="sidebar-title">Á∫ØÁ∫ØÂÜô‰Ωú</div>
            <div class="sidebar-actions">
                <button id="themeToggle" class="icon-btn" title="ÂàáÊç¢ÊòéÊöó">üåó</button>
                <button id="settingsBtn" class="icon-btn" title="ËÆæÁΩÆ">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="sidebar-search">
            <input id="searchInput" class="search-input" placeholder="ÊêúÁ¥¢ÊñáÊ°£ (‚åò/Ctrl K)">
            <button id="newDocBtn" class="primary-btn" title="Êñ∞Âª∫ÊñáÊ°£">Ôºã</button>
        </div>
        <div class="menu-section-title">ÁõÆÂΩï</div>
        <div id="docList">
            <div id="tree" class="tree"></div>
        </div>
        <div class="sidebar-footer">
            <button id="newNovelBtn" class="toolbar-btn icon-btn" title="Êñ∞Âª∫Â∞èËØ¥">üìö</button>
            <button id="newFolderBtn" class="toolbar-btn icon-btn" title="Êñ∞Âª∫Êñá‰ª∂Â§π">üìÅÔºã</button>
            <button id="importBtn" class="toolbar-btn icon-btn" title="ÂØºÂÖ• .txt">üì•</button>
            <input id="importFile" type="file" accept=".txt,.md,text/plain" style="display:none">
        </div>
    </aside>

    <div id="main-container">
        <div id="sidebar-overlay"></div>
        <div class="toolbar">
            <button class="menu-toggle" id="menuToggle" title="ÁõÆÂΩï">‚ò∞</button>
            <input type="text" id="titleInput" class="title-input" placeholder="Ê†áÈ¢ò">
            <button id="toolsBtn" title="Â∑•ÂÖ∑" class="icon-btn">‚ãØ</button>
        </div>

        <div class="word-count">
            <div>Â≠óÊï∞Ôºö<span id="charCount" class="num">0</span></div>
            <div class="progress-bar"><div id="goalProgress" class="progress"></div></div>
            <div>ÁõÆÊ†áÔºö<span id="goalNum" class="num">1000</span></div>
        </div>

        <div id="editor-wrapper" class="pad-bottom">
            <textarea id="editor" spellcheck="false" placeholder="ÂºÄÂßãÂàõ‰Ωú‚Ä¶‚Ä¶"></textarea>
        </div>
    </div>

    <!-- Settings Drawer -->
    <div id="drawerOverlay"></div>
    <aside id="settingsDrawer">
        <div class="drawer-header">
            <span>ËÆæÁΩÆ</span>
            <button id="closeDrawer" class="icon-btn">‚úñ</button>
        </div>
        <div class="drawer-body">
            <div class="form-group">
                <label>‰∏ªÈ¢ò</label>
                <div class="radio-row" id="themeChips">
                    <button class="chip" data-theme="light">Êòé‰∫Æ</button>
                    <button class="chip" data-theme="dark">ÊöóÈªë</button>
                    <button class="chip" data-theme="sepia">Âè§È£é</button>
                    <button class="chip" data-theme="eye">Êä§Áúº</button>
                </div>
            </div>
            <div class="form-group">
                <label>ÂΩìÂâçÊñáÊ°£Â≠óÊï∞ÁõÆÊ†á</label>
                <input id="docGoalInput" class="num-input" type="number" min="0" step="100" placeholder="1000">
            </div>
            <div class="form-group">
                <label>‰∫∫Áâ©Ê†èË°åÊï∞Ôºà1-10Ôºâ</label>
                <input id="nameRowsInput" class="num-input" type="number" min="1" max="10" step="1" placeholder="1">
            </div>
            <div class="form-group">
                <label>‰∫∫Áâ©Ê†èÔºàÊØèË°å‰ª•Á©∫Ê†ºÂàÜÈöîÂ§ö‰∏™ÂêçÂ≠óÔºõÂ§öË°åÁî®Êç¢Ë°åÔºâ</label>
                <textarea id="namesMultiInput" class="text-area" placeholder="Â∞èÊòé Â∞èÁ∫¢\nÂº†‰∏â ÊùéÂõõ"></textarea>
            </div>
            <div class="form-group">
                <label>‰∫∫Áâ©Ê†èÂ≠ó‰ΩìÂ§ßÂ∞è</label>
                <div class="radio-row" id="nameFontChips">
                    <button class="chip" data-size="12">Â∞è</button>
                    <button class="chip" data-size="14">‰∏≠</button>
                    <button class="chip" data-size="16">Â§ß</button>
                    <button class="chip" data-size="18">ÁâπÂ§ß</button>
                </div>
            </div>
            <div class="form-group">
                <label>Á¨¶Âè∑Ê†èË°åÊï∞Ôºà1-3Ôºâ</label>
                <input id="symbolRowsInput" class="num-input" type="number" min="1" max="3" step="1" placeholder="1">
            </div>
            <div class="form-group">
                <label>Á¨¶Âè∑Ê†èÔºàÊØèË°å‰∏ÄÁªÑÔºåÁªÑÂÜÖÁî®Á©∫Ê†ºÂàÜÈöîÔºõËæìÂÖ•ÊàêÂØπÁ¨¶Âè∑Â¶Ç ‚Äú‚ÄùÔºå‰ºöÂ∞ÜÂÖâÊ†áÊîæÂú®‰∏≠Èó¥Ôºâ</label>
                <textarea id="symbolsMultiInput" class="text-area" placeholder="Ôºå„ÄÇ„ÄÅ„Äå„Äç\nÔºà Ôºâ ‚Äî ‚Ä¶ ÔºÅ Ôºü\n‚Äú ‚Äù „Ää „Äã"></textarea>
            </div>
            <div class="form-group">
                <label>Ë∑≥Âá∫ÂèåÁ¨¶Âè∑ÔºàÊàêÂØπÔºåÁ©∫Ê†ºÂàÜÈöîÔºåÂ¶Ç () [] {} ‚Äú‚Äù „Äå„Äç „Ää„Äã Ôºâ</label>
                <input id="jumpPairsInput" class="text-input" placeholder="() [] {} ‚Äú‚Äù „Äå„Äç „Ää„Äã ÔºàÔºâ '' &quot;&quot;">
            </div>
            <button id="saveBarPrefs" class="primary-btn">‰øùÂ≠ò</button>
        </div>
    </aside>

    <!-- Tools Drawer -->
    <div id="toolsOverlay"></div>
    <aside id="toolsDrawer">
        <div class="drawer-header">
            <span>Â∑•ÂÖ∑</span>
            <button id="closeTools" class="icon-btn">‚úñ</button>
        </div>
        <div class="drawer-body">
            <div class="form-group">
                <label>Â∏∏Áî®</label>
                <div class="radio-row">
                    <button id="toolNewDoc" class="chip">Êñ∞Âª∫ÊñáÊ°£</button>
                    <button id="toolNewFolder" class="chip">Êñ∞Âª∫Êñá‰ª∂Â§π</button>
                    <button id="toolNewNovel" class="chip">Êñ∞Âª∫Â∞èËØ¥</button>
                </div>
            </div>
            <div class="form-group">
                <label>Ê®°Êùø</label>
                <div class="radio-row">
                    <button id="toolTplPerson" class="chip">‰∫∫Áâ©Âç°</button>
                    <button id="toolTplScene" class="chip">Âú∫ÊôØÂç°</button>
                    <button id="toolTplWorld" class="chip">‰∏ñÁïåËßÇ</button>
                </div>
            </div>
            <div class="form-group">
                <label>ÂØºÂÖ•ÂØºÂá∫</label>
                <div class="radio-row">
                    <button id="toolExportTxt" class="chip">ÂØºÂá∫ TXT</button>
                    <button id="toolExportMd" class="chip">ÂØºÂá∫ MD</button>
                    <button id="toolImport" class="chip">ÂØºÂÖ•ÊñáÊú¨</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Move-To Sheet -->
    <div id="sheetOverlay"></div>
    <aside id="moveSheet">
        <div class="sheet-header">
            <span>ÁßªÂä®Âà∞</span>
            <button id="closeMoveSheet" class="icon-btn">‚úñ</button>
        </div>
        <div id="moveSheetBody" class="sheet-body"></div>
    </aside>

    <!-- Snackbar -->
    <div id="snackbar"><span id="snackMsg"></span><span id="snackAction" class="snack-action"></span></div>

    <!-- Bottom Bars -->
    <nav id="nameBar"></nav>
    <nav id="mobileBar"></nav>

    <script>
        // Utilities & Storage helpers
        function $(sel) { return document.querySelector(sel); }
        function $all(sel) { return Array.from(document.querySelectorAll(sel)); }
        function createEl(tag, cls) { const el = document.createElement(tag); if (cls) el.className = cls; return el; }
        function debounce(fn, wait) { let t; return function(...args){ clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); }; }
        function throttleRaf(fn) { let ticking = false; return function(...args){ if (ticking) return; ticking = true; requestAnimationFrame(() => { fn.apply(this, args); ticking = false; }); }; }
        function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
        function todayKey() { const d = new Date(); return d.toISOString().slice(0,10); }
        function loadJSON(key, def){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch { return def; } }
        function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

        // Storage keys
        const STORAGE_KEYS = {
            DOCS: 'novelDocs',
            FOLDERS: 'novelFolders',
            FOLDER_STATE: 'novelFolderState',
            CURRENT_ID: 'currentDocId',
            THEME: 'theme',
            SYMBOLS: 'customSymbols',
            SYMBOL_ROWS: 'symbolRows',
            JUMP_PAIRS: 'jumpPairs',
            NAMES: 'customNames',
            NAME_ROWS: 'nameRows',
            NAME_FONT: 'nameFontPx'
        };

        // Persisted getters/setters
        function loadDocs() { return loadJSON(STORAGE_KEYS.DOCS, []); }
        function saveDocs(v) { saveJSON(STORAGE_KEYS.DOCS, v); }
        function loadFolders() { return loadJSON(STORAGE_KEYS.FOLDERS, []); }
        function saveFolders(v) { saveJSON(STORAGE_KEYS.FOLDERS, v); }
        function loadFolderState() { return loadJSON(STORAGE_KEYS.FOLDER_STATE, {}); }
        function saveFolderState(v) { saveJSON(STORAGE_KEYS.FOLDER_STATE, v); }
        function getCurrentId() { return localStorage.getItem(STORAGE_KEYS.CURRENT_ID); }
        function setCurrentId(id) { localStorage.setItem(STORAGE_KEYS.CURRENT_ID, id); }
        function loadTheme() { return localStorage.getItem(STORAGE_KEYS.THEME) || 'light'; }
        function saveTheme(theme) { localStorage.setItem(STORAGE_KEYS.THEME, theme); }
        function loadSymbolsRaw() { return loadJSON(STORAGE_KEYS.SYMBOLS, []); }
        function saveSymbolsRaw(arr) { saveJSON(STORAGE_KEYS.SYMBOLS, arr); }
        function loadSymbolRows() { const n = parseInt(localStorage.getItem(STORAGE_KEYS.SYMBOL_ROWS) || '1', 10); return Number.isFinite(n) ? clamp(n,1,3) : 1; }
        function saveSymbolRows(n) { localStorage.setItem(STORAGE_KEYS.SYMBOL_ROWS, String(clamp(n,1,3))); }
        function loadJumpPairs() { return loadJSON(STORAGE_KEYS.JUMP_PAIRS, ["()","[]","{}","‚Äú‚Äù","‚Äò‚Äô","„Äå„Äç","„Ää„Äã","ÔºàÔºâ","''","\"\""]); }
        function saveJumpPairs(arr) { saveJSON(STORAGE_KEYS.JUMP_PAIRS, arr); }
        function loadNamesRaw() { return loadJSON(STORAGE_KEYS.NAMES, []); }
        function saveNamesRaw(arr) { saveJSON(STORAGE_KEYS.NAMES, arr); }
        function loadNameRows() { const n = parseInt(localStorage.getItem(STORAGE_KEYS.NAME_ROWS) || '1', 10); return Number.isFinite(n) ? clamp(n,1,10) : 1; }
        function saveNameRows(n) { localStorage.setItem(STORAGE_KEYS.NAME_ROWS, String(clamp(n,1,10))); }
        function loadNameFont() { const n = parseInt(localStorage.getItem(STORAGE_KEYS.NAME_FONT) || '14', 10); return Number.isFinite(n) ? clamp(n,10,28) : 14; }
        function saveNameFont(n) { localStorage.setItem(STORAGE_KEYS.NAME_FONT, String(n)); }

        // App state
        let docs = loadDocs();
        let folders = loadFolders();
        let folderOpenState = loadFolderState();
        let currentDocId = getCurrentId();
        let draggedDocId = null;
        let draggedFolderId = null;
        let lastDeleted = null;

        // Elements
        const sidebar = $('#sidebar');
        const overlay = $('#sidebar-overlay');
        const mobileBar = $('#mobileBar');
        const nameBar = $('#nameBar');
        const editor = $('#editor');
        const treeEl = $('#tree');
        const titleInput = $('#titleInput');
        const charCountEl = $('#charCount');
        const goalNum = $('#goalNum');
        const goalProgress = $('#goalProgress');
        const drawer = $('#settingsDrawer');
        const drawerOverlay = $('#drawerOverlay');
        const toolsDrawer = $('#toolsDrawer');
        const toolsOverlay = $('#toolsOverlay');
        const docGoalInput = $('#docGoalInput');
        const nameRowsInput = $('#nameRowsInput');
        const namesMultiInput = $('#namesMultiInput');
        const nameFontChips = $('#nameFontChips');
        const symbolRowsInput = $('#symbolRowsInput');
        const symbolsMultiInput = $('#symbolsMultiInput');
        const jumpPairsInput = $('#jumpPairsInput');
        const sheet = $('#moveSheet');
        const sheetOverlay = $('#sheetOverlay');
        const sheetBody = $('#moveSheetBody');

        // Theme
        function applyTheme(theme){ document.documentElement.setAttribute('data-theme', theme); selectThemeChip(theme); }
        applyTheme(loadTheme());

        // Initialize defaults
        if (!docs.length) {
            const id = 'doc_' + Date.now();
            docs.push({ id, title: 'ÊàëÁöÑÂÜô‰ΩúÁ¨îËÆ∞', content: 'ÂºÄÂßãÂàõ‰Ωú‚Ä¶‚Ä¶', starred: false, createdAt: Date.now(), updatedAt: Date.now(), folderId: null, sort: 0, goal: 1000 });
            saveDocs(docs); currentDocId = id; setCurrentId(id);
        }
        if (!folders.length) {
            const fid = 'fld_' + Date.now();
            folders.push({ id: fid, name: 'ÊàëÁöÑ‰ΩúÂìÅ', parentId: null, sort: 0 });
            folderOpenState[fid] = true; saveFolders(folders); saveFolderState(folderOpenState);
        }
        function ensureOrdering(){ const perF = new Map(); for (const f of folders){ const p=f.parentId||null; if(!perF.has(p)) perF.set(p,[]); perF.get(p).push(f);} for (const [p,arr] of perF){ arr.sort((a,b)=>((a.sort??1e9)-(b.sort??1e9))||a.name.localeCompare(b.name)); arr.forEach((f,i)=>{ if(typeof f.sort!== 'number') f.sort=i; }); } const perD=new Map(); for(const d of docs){ const p=d.folderId||null; if(!perD.has(p)) perD.set(p,[]); perD.get(p).push(d);} for(const [p,arr] of perD){ arr.sort((a,b)=>((a.sort??1e9)-(b.sort??1e9))|| (b.updatedAt-a.updatedAt)); arr.forEach((d,i)=>{ if(typeof d.sort!== 'number') d.sort=i; if(typeof d.goal!== 'number') d.goal=1000;}); } saveFolders(folders); saveDocs(docs);} ensureOrdering();

        // Helpers for bars
        function getSymbolBars(){ const raw=loadSymbolsRaw(); if(Array.isArray(raw)&&Array.isArray(raw[0])) return raw; if(Array.isArray(raw)) return [raw]; return [['Ôºå','„ÄÇ','„ÄÅ','„Äå','„Äç','Ôºà','Ôºâ','‚Äî','‚Ä¶','ÔºÅ','Ôºü','Ôºö','Ôºõ','‚Äú','‚Äù']]; }
        function renderSymbolBars(){ mobileBar.innerHTML=''; const rows=loadSymbolRows(); document.documentElement.style.setProperty('--mobile-rows', String(rows)); const bars=getSymbolBars(); for(let i=0;i<rows;i++){ const row=createEl('div','row'); const list=Array.isArray(bars[i])?bars[i]:[]; for(const sym of list){ const b=createEl('button','m-btn'); b.textContent=sym; b.addEventListener('click',()=> insertSymbolToken(sym)); row.appendChild(b);} mobileBar.appendChild(row);} }
        function getNameBars(){ const raw=loadNamesRaw(); if(Array.isArray(raw)&&Array.isArray(raw[0])) return raw; if(Array.isArray(raw)) return [raw]; return [[]]; }
        function renderNameBars(){ nameBar.innerHTML=''; const rows=loadNameRows(); document.documentElement.style.setProperty('--name-rows', String(rows)); document.documentElement.style.setProperty('--name-bar-height', '40px'); document.documentElement.style.setProperty('--name-font-size', loadNameFont()+'px'); const bars=getNameBars(); for(let i=0;i<rows;i++){ const row=createEl('div','row'); const list=Array.isArray(bars[i])?bars[i]:[]; for(const nm of list){ const b=createEl('button','n-btn'); b.textContent=nm; b.style.fontSize=loadNameFont()+'px'; b.addEventListener('click',()=> insertAtCursor(nm)); row.appendChild(b);} nameBar.appendChild(row);} }

        // Render tree (unchanged inputs omitted for brevity)
        function getChildrenFolders(parentId) { return folders.filter(f=>f.parentId===parentId).sort((a,b)=>a.sort-b.sort||a.name.localeCompare(b.name)); }
        function getFolderDocs(folderId) { return docs.filter(d=>(d.folderId||null)===(folderId||null)).sort((a,b)=>a.sort-b.sort||(b.updatedAt-a.updatedAt)); }
        function isOpen(fid){ return !!folderOpenState[fid]; }
        function setOpen(fid,open){ folderOpenState[fid]=open; saveFolderState(folderOpenState); }
        function renderTree(filter=''){ const kw=(filter||'').trim().toLowerCase(); treeEl.innerHTML=''; const rootDrop=createEl('div','tree-root-drop'); rootDrop.textContent='ÊãñÂä®ÊñáÊ°£Âà∞Ê≠§Â§ÑÁßªÂä®Âà∞Ê†πÁõÆÂΩï'; rootDrop.addEventListener('dragover',(e)=>{ if(!draggedDocId)return; e.preventDefault(); rootDrop.classList.add('dragover'); },{passive:false}); rootDrop.addEventListener('dragleave',()=> rootDrop.classList.remove('dragover')); rootDrop.addEventListener('drop',(e)=>{ if(!draggedDocId)return; e.preventDefault(); rootDrop.classList.remove('dragover'); moveDocToFolder(draggedDocId,null); }); treeEl.appendChild(rootDrop); for(const d of getFolderDocs(null)){ if(kw && !d.title.toLowerCase().includes(kw)) continue; treeEl.appendChild(renderDocNode(d,0)); } function renderFolder(f,level){ const row=createEl('div','folder-node'); row.dataset.folderId=f.id; row.draggable=true; const indent=createEl('div','indent'); indent.style.marginLeft=(level*14)+'px'; const caret=createEl('div','caret'); caret.textContent=isOpen(f.id)?'‚ñæ':'‚ñ∏'; caret.addEventListener('click',()=>{ const op=!isOpen(f.id); setOpen(f.id,op); caret.textContent=op?'‚ñæ':'‚ñ∏'; children.style.display=op?'':'none'; }); const icon=createEl('div'); icon.textContent='üìÅ'; const title=createEl('div','folder-title'); title.textContent=f.name; const actions=createEl('div','node-actions'); const addDocBtn=createEl('button','icon-btn'); addDocBtn.textContent='üìùÔºã'; addDocBtn.title='Êñ∞Âª∫ÊñáÊ°£'; addDocBtn.addEventListener('click',(e)=>{ e.stopPropagation(); createDoc('',f.id,'Êñ∞ÊñáÊ°£'); }); const addFolderBtn=createEl('button','icon-btn'); addFolderBtn.textContent='Ôºã'; addFolderBtn.title='Êñ∞Âª∫Â≠êÊñá‰ª∂Â§π'; addFolderBtn.addEventListener('click',(e)=>{ e.stopPropagation(); createFolder(f.id); }); const renameBtn=createEl('button','icon-btn'); renameBtn.textContent='‚úé'; renameBtn.title='ÈáçÂëΩÂêç'; renameBtn.addEventListener('click',(e)=>{ e.stopPropagation(); inlineRenameFolder(f.id,title); }); actions.appendChild(addDocBtn); actions.appendChild(addFolderBtn); actions.appendChild(renameBtn); row.appendChild(indent); row.appendChild(caret); row.appendChild(icon); row.appendChild(title); row.appendChild(actions); row.addEventListener('dragover',(e)=>{ if(draggedDocId){ e.preventDefault(); row.classList.add('drop-target'); return; } if(draggedFolderId && draggedFolderId!==f.id){ const dragged=folders.find(x=>x.id===draggedFolderId); if(!dragged|| (dragged.parentId||null)!==(f.parentId||null)) return; e.preventDefault(); const rect=row.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; row.classList.toggle('drop-before',before); row.classList.toggle('drop-after',!before); }},{passive:false}); row.addEventListener('dragleave',()=>{ row.classList.remove('drop-target','drop-before','drop-after'); }); row.addEventListener('drop',(e)=>{ e.preventDefault(); if(draggedDocId){ moveDocToFolder(draggedDocId,f.id); row.classList.remove('drop-target'); return; } if(draggedFolderId && draggedFolderId!==f.id){ const dragged=folders.find(x=>x.id===draggedFolderId); if(!dragged|| (dragged.parentId||null)!==(f.parentId||null)) return; const rect=row.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; reorderFolders(dragged.parentId||null, draggedFolderId, f.id, before?'before':'after'); } row.classList.remove('drop-before','drop-after'); }); row.addEventListener('dragstart', (e)=>{ draggedFolderId=f.id; e.dataTransfer.effectAllowed='move'; }); row.addEventListener('dragend', ()=>{ draggedFolderId=null; }); const children=createEl('div','children'); children.style.display=isOpen(f.id)?'':'none'; for(const d of getFolderDocs(f.id)){ if(kw && !d.title.toLowerCase().includes(kw)) continue; children.appendChild(renderDocNode(d,level+1)); } for(const sf of getChildrenFolders(f.id)) children.appendChild(renderFolder(sf,level+1)); const wrap=createEl('div'); wrap.appendChild(row); wrap.appendChild(children); return wrap; } for(const f of getChildrenFolders(null)) treeEl.appendChild(renderFolder(f,0)); }
        function renderDocNode(doc, level){ const row=createEl('div','doc-node'); row.draggable=true; row.dataset.docId=doc.id; if(doc.id===currentDocId) row.classList.add('active'); const indent=createEl('div','indent'); indent.style.marginLeft=(level*14)+'px'; const icon=createEl('div'); icon.textContent='üìù'; const title=createEl('div','doc-title'); title.textContent=doc.title||'Êó†Ê†áÈ¢ò'; const actions=createEl('div','node-actions'); const starBtn=createEl('button','icon-btn'); starBtn.innerHTML=doc.starred?'‚≠ê':'‚òÜ'; starBtn.title=doc.starred?'ÂèñÊ∂àÊî∂Ëóè':'Êî∂Ëóè'; starBtn.addEventListener('click',(e)=>{ e.stopPropagation(); toggleStar(doc.id); }); const moveBtn=createEl('button','icon-btn'); moveBtn.textContent='‚Ü™Ô∏è'; moveBtn.title='ÁßªÂä®Âà∞'; moveBtn.addEventListener('click',(e)=>{ e.stopPropagation(); openMoveSheet(doc.id); }); const delBtn=createEl('button','icon-btn'); delBtn.textContent='üóëÔ∏è'; delBtn.title='Âà†Èô§'; delBtn.addEventListener('click',(e)=>{ e.stopPropagation(); softDeleteDoc(doc.id); }); actions.appendChild(starBtn); actions.appendChild(moveBtn); actions.appendChild(delBtn); row.appendChild(indent); row.appendChild(icon); row.appendChild(title); row.appendChild(actions); row.addEventListener('click',()=> selectDoc(doc.id)); row.addEventListener('dragstart',(e)=>{ draggedDocId=doc.id; e.dataTransfer.effectAllowed='move'; }); row.addEventListener('dragend',()=>{ draggedDocId=null; row.classList.remove('drop-before','drop-after'); }); row.addEventListener('dragover',(e)=>{ if(!draggedDocId || draggedDocId===doc.id) return; const dragged=docs.find(d=>d.id===draggedDocId); if(!dragged || (dragged.folderId||null)!==(doc.folderId||null)) return; e.preventDefault(); const rect=row.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; row.classList.toggle('drop-before',before); row.classList.toggle('drop-after',!before); },{passive:false}); row.addEventListener('dragleave',()=> row.classList.remove('drop-before','drop-after')); row.addEventListener('drop',(e)=>{ if(!draggedDocId || draggedDocId===doc.id) return; const dragged=docs.find(d=>d.id===draggedDocId); if(!dragged || (dragged.folderId||null)!==(doc.folderId||null)) return; e.preventDefault(); const rect=row.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; reorderDocs(doc.folderId||null, draggedDocId, doc.id, before?'before':'after'); }); return row; }
        function reorderDocs(parentId, draggedId, targetId, position){ const list=docs.filter(d=>(d.folderId||null)===(parentId||null)).sort((a,b)=>a.sort-b.sort); const idx=new Map(list.map((d,i)=>[d.id,i])); const di=idx.get(draggedId), ti=idx.get(targetId); if(di==null||ti==null) return; list.splice(di,1); list.splice(position==='before'?ti:ti+1,0, docs.find(d=>d.id===draggedId)); list.forEach((d,i)=> d.sort=i); saveDocs(docs); renderTree($('#searchInput').value); }
        function reorderFolders(parentId, draggedId, targetId, position){ const list=folders.filter(f=>(f.parentId||null)===(parentId||null)).sort((a,b)=>a.sort-b.sort); const idx=new Map(list.map((f,i)=>[f.id,i])); const di=idx.get(draggedId), ti=idx.get(targetId); if(di==null||ti==null) return; list.splice(di,1); list.splice(position==='before'?ti:ti+1,0, folders.find(f=>f.id===draggedId)); list.forEach((f,i)=> f.sort=i); saveFolders(folders); renderTree($('#searchInput').value); }

        // CRUD & selection
        function currentDoc(){ return docs.find(x=>x.id===currentDocId); }
        function selectDoc(id){ const doc=docs.find(x=>x.id===id); if(!doc) return; currentDocId=id; setCurrentId(id); titleInput.value=doc.title||''; editor.value=doc.content||''; updateWordStats(); updateGoalUI(); renderTree($('#searchInput').value); editor.focus(); }
        function createDoc(initialContent='', folderId=null, title='Êó†Ê†áÈ¢òÊñáÊ°£'){ const id='doc_'+Math.random().toString(36).slice(2); const now=Date.now(); const sibling=docs.filter(d=>(d.folderId||null)===(folderId||null)).length; const newDoc={ id, title, content: initialContent, starred:false, createdAt:now, updatedAt:now, folderId, sort:sibling, goal:1000 }; docs.push(newDoc); saveDocs(docs); selectDoc(id); }
        function createNovel() {
            const fid = generateId('fld'); const parentId = null;
            const siblingCount = folders.filter(f => (f.parentId || null) === (parentId || null)).length;
            const folder = { id: fid, name: 'Êñ∞Â∞èËØ¥', parentId, sort: siblingCount };
            folders.push(folder); folderOpenState[fid] = true; saveFolders(folders); saveFolderState(folderOpenState);
            createDoc('‰π¶ÂêçÔºö\n‰∏ªÊó®Ôºö\n‰∫∫ËÆæÔºö\n‰∏ñÁïåËßÇÔºö\nÊÉÖËäÇÊèêË¶ÅÔºö\n', fid, 'Â§ßÁ∫≤');
            createDoc('Á¨¨1Á´†\n\n', fid, 'Á¨¨1Á´†');
            showSnack('Â∑≤ÂàõÂª∫Â∞èËØ¥‚ÄúÊñ∞Â∞èËØ¥‚Äù'); renderTree($('#searchInput').value);
        }
        function moveDocToFolder(docId, folderId){ const doc=docs.find(d=>d.id===docId); if(!doc) return; const p=folderId||null; doc.folderId=p; doc.updatedAt=Date.now(); doc.sort=docs.filter(d=>(d.folderId||null)===p).length; saveDocs(docs); renderTree($('#searchInput').value); }
        function softDeleteDoc(id){ const i=docs.findIndex(d=>d.id===id); if(i===-1) return; const rm=docs.splice(i,1)[0]; saveDocs(docs); if(currentDocId===id){ if(docs.length) selectDoc(docs[0].id); else createDoc(); } renderTree($('#searchInput').value); lastDeleted={doc:rm}; }
        function toggleStar(id){ const doc=docs.find(d=>d.id===id); if(!doc) return; doc.starred=!doc.starred; doc.updatedAt=Date.now(); saveDocs(docs); renderTree($('#searchInput').value); }
        function createFolder(parentId=null){ const id='fld_'+Math.random().toString(36).slice(2); const sibling=folders.filter(f=>(f.parentId||null)===(parentId||null)).length; const f={ id, name:'Êñ∞Âª∫Êñá‰ª∂Â§π', parentId:parentId||null, sort:sibling }; folders.push(f); folderOpenState[id]=true; saveFolders(folders); saveFolderState(folderOpenState); renderTree($('#searchInput').value); }
        function inlineRenameFolder(folderId, titleEl){ const f=folders.find(x=>x.id===folderId); if(!f) return; const old=f.name; const input=document.createElement('input'); input.type='text'; input.value=old; input.className='text-input'; titleEl.replaceWith(input); input.focus(); input.select(); const commit=()=>{ f.name=(input.value.trim()||old); saveFolders(folders); renderTree($('#searchInput').value); }; input.addEventListener('blur',commit); input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); input.blur(); } if(e.key==='Escape'){ f.name=old; input.blur(); } }); }

        // Goal bar logic (per-doc)
        function updateGoalUI(){ const doc=currentDoc(); const goal=(doc&&typeof doc.goal==='number')? doc.goal : 1000; goalNum.textContent=goal; const chars=(editor.value||'').replace(/\s+/g,'').length; charCountEl.textContent=chars; const pct=goal<=0?1:Math.max(0, Math.min(1, chars/goal)); goalProgress.style.width=(pct*100).toFixed(1)+'%'; }

        // Saving & stats
        const persist=debounce(function(){ const doc=currentDoc(); if(!doc) return; doc.title=titleInput.value.trim()||'Êó†Ê†áÈ¢òÊñáÊ°£'; doc.content=editor.value; doc.updatedAt=Date.now(); saveDocs(docs); updateGoalUI(); renderTree($('#searchInput').value); }, 180);
        function saveNow(){ persist(); }
        const updateWordStats=throttleRaf(()=>{ updateGoalUI(); });

        // Templates & insertion helpers
        function insertAtCursor(text){ const start=editor.selectionStart, end=editor.selectionEnd, val=editor.value; editor.value=val.slice(0,start)+text+val.slice(end); const caret=start+text.length; editor.selectionStart=editor.selectionEnd=caret; editor.focus(); saveNow(); updateWordStats(); }
        function buildPairs(){ return loadJumpPairs().map(p=>[p[0], p[1]]); }
        function insertPair(left,right){ const start=editor.selectionStart, end=editor.selectionEnd, val=editor.value; const inside=left+right; editor.value=val.slice(0,start)+inside+val.slice(end); editor.selectionStart=editor.selectionEnd=start+1; editor.focus(); saveNow(); updateWordStats(); }
        function insertSymbolToken(tok){ if(typeof tok==='string' && tok.length===2){ const pairs=buildPairs(); for(const [L,R] of pairs){ if(tok===L+R){ insertPair(L,R); return; } } }
            insertAtCursor(tok); }

        // Jump-out anywhere inside pair on Enter
        function isInsidePair(pos, left, right, text){ const l=text.lastIndexOf(left, pos-1); if(l<0) return false; const r=text.indexOf(right, pos); if(r<0) return false; return l < pos && pos <= r; }
        function jumpOutIfInside(e){ if(e.key!=='Enter') return; const pos=editor.selectionStart; if(pos!==editor.selectionEnd) return; const text=editor.value; if(pos<=0 || pos>text.length) return; const pairs=buildPairs(); for(const [L,R] of pairs){ const inside=isInsidePair(pos, L, R, text); if(inside){ const r=text.indexOf(R, pos); if(r>=0){ e.preventDefault(); editor.selectionStart=editor.selectionEnd=r+1; editor.focus(); return; } } } }

        // Snackbar
        let snackTimer=null; function showSnack(msg){ const el=$('#snackbar'); $('#snackMsg').textContent=msg; $('#snackAction').textContent=''; el.classList.add('show'); clearTimeout(snackTimer); snackTimer=setTimeout(()=> el.classList.remove('show'), 1600); }

        // Drawers & settings
        function openDrawer(){ drawer.classList.add('show'); drawerOverlay.style.display='block'; const doc=currentDoc(); docGoalInput.value = doc && typeof doc.goal==='number' ? String(doc.goal) : '1000'; loadBarsIntoSettings(); }
        function closeDrawer(){ drawer.classList.remove('show'); drawerOverlay.style.display='none'; }
        function selectThemeChip(theme){ $all('#themeChips .chip').forEach(c=> c.classList.toggle('active', c.dataset.theme===theme)); }
        function openTools(){ toolsDrawer.classList.add('show'); toolsOverlay.style.display='block'; }
        function closeTools(){ toolsDrawer.classList.remove('show'); toolsOverlay.style.display='none'; }
        function loadBarsIntoSettings(){ nameRowsInput.value=String(loadNameRows()); const nameBars=getNameBars(); const nameLines=[]; for(let i=0;i<loadNameRows();i++){ nameLines.push((nameBars[i]||[]).join(' ')); } namesMultiInput.value=nameLines.join('\n'); const font=loadNameFont(); $all('#nameFontChips .chip').forEach(ch=> ch.classList.toggle('active', parseInt(ch.dataset.size,10)===font)); symbolRowsInput.value=String(loadSymbolRows()); const symBars=getSymbolBars(); const symLines=[]; for(let i=0;i<loadSymbolRows();i++){ symLines.push((symBars[i]||[]).join(' ')); } symbolsMultiInput.value=symLines.join('\n'); jumpPairsInput.value=loadJumpPairs().join(' '); }
        function saveBarsFromSettings(){ let nRows=parseInt(nameRowsInput.value||'1',10); if(!Number.isFinite(nRows)||nRows<1)nRows=1; nRows=Math.min(nRows,10); const nameLines=namesMultiInput.value.split(/\n/); const names=[]; for(let i=0;i<nRows;i++){ const parts=(nameLines[i]||'').trim().split(/\s+/).filter(Boolean); names.push(parts);} saveNamesRaw(names); saveNameRows(nRows); const active=$('#nameFontChips .chip.active'); const size=active?parseInt(active.dataset.size,10):14; saveNameFont(size); document.documentElement.style.setProperty('--name-font-size', size+'px'); let sRows=parseInt(symbolRowsInput.value||'1',10); if(!Number.isFinite(sRows)||sRows<1)sRows=1; sRows=Math.min(sRows,3); const symLines=symbolsMultiInput.value.split(/\n/); const syms=[]; for(let i=0;i<sRows;i++){ const parts=(symLines[i]||'').trim().split(/\s+/).filter(Boolean); syms.push(parts);} saveSymbolsRaw(syms); saveSymbolRows(sRows); const pairsTokens=(jumpPairsInput.value||'').trim().split(/\s+/).filter(Boolean); const pairs=[]; for(const tok of pairsTokens){ if(tok.length>=2) pairs.push(tok.slice(0,2)); } if(!pairs.length) pairs.push(...["()","[]","{}","‚Äú‚Äù","‚Äò‚Äô","„Äå„Äç","„Ää„Äã","ÔºàÔºâ","''","\"\""]); saveJumpPairs(pairs); const doc=currentDoc(); const g=parseInt(docGoalInput.value||'1000',10); if(doc){ doc.goal = Number.isFinite(g)? Math.max(0,g): 1000; saveDocs(docs); updateGoalUI(); } renderNameBars(); renderSymbolBars(); showBarsIfIME(); showSnack('Â∑≤‰øùÂ≠òËÆæÁΩÆ'); }

        // IME visibility heuristics: show bars only when editing
        let imeVisible=false; function showBarsIfIME(){ const rows=loadSymbolRows(); const nrows=loadNameRows(); if(imeVisible){ nameBar.style.display = nrows>0? 'block':'none'; mobileBar.style.display = rows>0? 'block':'none'; $('#editor-wrapper').classList.toggle('with-name', nrows>0); $('#editor-wrapper').classList.add('pad-bottom'); } else { nameBar.style.display='none'; mobileBar.style.display='none'; $('#editor-wrapper').classList.remove('with-name'); $('#editor-wrapper').classList.remove('pad-bottom'); } }

        // Bindings
        function bindGlobal(){
            // Sidebar & theme
            $('#menuToggle').addEventListener('click', ()=>{ sidebar.classList.toggle('show'); overlay.style.display=sidebar.classList.contains('show')?'block':'none'; });
            overlay.addEventListener('click', ()=>{ sidebar.classList.remove('show'); overlay.style.display='none'; });
            $('#themeToggle').addEventListener('click', ()=>{ const cur=loadTheme(); const next= (cur==='dark')?'light': (cur==='light')?'sepia': (cur==='sepia')?'eye':'dark'; saveTheme(next); applyTheme(next); showSnack('‰∏ªÈ¢òÂ∑≤ÂàáÊç¢'); });

            // Tools
            $('#toolsBtn').addEventListener('click', openTools); $('#closeTools').addEventListener('click', closeTools); toolsOverlay.addEventListener('click', closeTools);
            $('#toolNewDoc').addEventListener('click', ()=>{ createDoc(); closeTools(); });
            $('#toolNewFolder').addEventListener('click', ()=>{ createFolder(null); closeTools(); });
            $('#toolNewNovel').addEventListener('click', ()=>{ createNovel(); closeTools(); });
            $('#toolTplPerson').addEventListener('click', ()=>{ insertTemplate('person'); closeTools(); });
            $('#toolTplScene').addEventListener('click', ()=>{ insertTemplate('scene'); closeTools(); });
            $('#toolTplWorld').addEventListener('click', ()=>{ insertTemplate('world'); closeTools(); });
            $('#toolExportTxt').addEventListener('click', ()=>{ const doc=currentDoc(); if(!doc) return; const blob=new Blob([doc.content||''],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(doc.title||'ÂØºÂá∫')+'.txt'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0); });
            $('#toolExportMd').addEventListener('click', ()=>{ const doc=currentDoc(); if(!doc) return; const blob=new Blob([doc.content||''],{type:'text/markdown;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(doc.title||'ÂØºÂá∫')+'.md'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0); });
            $('#toolImport').addEventListener('click', ()=>{ $('#importFile').click(); closeTools(); });

            // Settings
            $('#settingsBtn').addEventListener('click', openDrawer); $('#closeDrawer').addEventListener('click', closeDrawer); drawerOverlay.addEventListener('click', closeDrawer);
            $all('#themeChips .chip').forEach(ch=> ch.addEventListener('click', ()=>{ const theme=ch.dataset.theme; saveTheme(theme); applyTheme(theme); showSnack('‰∏ªÈ¢òÔºö'+ch.textContent); }));
            $all('#nameFontChips .chip').forEach(ch=> ch.addEventListener('click', ()=>{ $all('#nameFontChips .chip').forEach(x=>x.classList.remove('active')); ch.classList.add('active'); }));
            $('#saveBarPrefs').addEventListener('click', saveBarsFromSettings);

            // Footer & import
            $('#newDocBtn').addEventListener('click', ()=> createDoc());
            $('#newFolderBtn').addEventListener('click', ()=> createFolder(null));
            $('#newNovelBtn').addEventListener('click', ()=> createNovel());
            $('#importBtn').addEventListener('click', ()=> $('#importFile').click());
            $('#importFile').addEventListener('change', async (e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const text=await f.text(); createDoc(text,null,f.name.replace(/\.[^.]+$/, '')); e.target.value=''; });

            // Search
            $('#searchInput').addEventListener('input', debounce((e)=> renderTree(e.target.value), 120));

            // Editor
            titleInput.addEventListener('input', ()=>{ persist(); renderTree($('#searchInput').value); });
            editor.addEventListener('input', ()=>{ updateWordStats(); persist(); });
            editor.addEventListener('keydown', jumpOutIfInside);
            editor.addEventListener('focus', ()=>{ imeVisible=true; showBarsIfIME(); });
            editor.addEventListener('blur', ()=>{ imeVisible=false; showBarsIfIME(); });
            if(window.visualViewport){ window.visualViewport.addEventListener('resize', ()=>{ const vv=window.visualViewport; imeVisible = (vv&& (window.innerHeight - vv.height) > 120); showBarsIfIME(); }); }

            // Shortcuts
            document.addEventListener('keydown', (e)=>{ const mod=e.ctrlKey||e.metaKey; if(mod && e.key.toLowerCase()==='s'){ e.preventDefault(); saveNow(); } if(mod && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#searchInput').focus(); } }, {passive:false});
        }

        // Boot
        bindGlobal(); renderTree(); selectDoc(currentDocId || docs[0].id); renderNameBars(); renderSymbolBars(); showBarsIfIME();
    </script>
</body>
</html>