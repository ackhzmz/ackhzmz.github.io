<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>纯纯写作 · 小说创作工作台（移动端）</title>
    <style>
        :root {
            --toolbar-height: 48px;
            --stats-height: 44px;
            --sidebar-width: 86vw;
            --primary-color: #4a86e8;
            --text-color: #222;
            --muted-text: #666;
            --bg-color: #f7f8fa;
            --panel-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 2px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 6px 18px rgba(0,0,0,0.08);
            --accent: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --link: #2563eb;
            --editor-width: 100%;
            --tree-indent: 18px;
            --hover-bg: rgba(127,127,127,0.06);
            --active-bg: rgba(74,134,232,0.12);
            --mobile-bar-height: 44px;
            --name-bar-height: 40px;
            --mobile-rows: 1;
            --name-rows: 1;
            --caret-color: #4a86e8;
            --name-font-size: 14px;
            --symbol-font-size: 15px;
        }

        [data-theme="dark"] {
            --primary-color: #6ea8fe;
            --text-color: #e5e7eb;
            --muted-text: #9ca3af;
            --bg-color: #0f1116;
            --panel-bg: #161a23;
            --border-color: #262a36;
            --shadow-sm: 0 2px 6px rgba(0,0,0,0.35);
            --shadow-md: 0 6px 18px rgba(0,0,0,0.35);
            --accent: #34d399;
            --danger: #f87171;
            --warning: #f59e0b;
            --link: #93c5fd;
            --hover-bg: rgba(255,255,255,0.05);
            --active-bg: rgba(110,168,254,0.15);
            --caret-color: #6ea8fe;
        }

        [data-theme="sepia"] {
            --primary-color: #8b5e34;
            --text-color: #3e2c1c;
            --muted-text: #7b6a58;
            --bg-color: #f3ead7;
            --panel-bg: #faf3e3;
            --border-color: #e1d7c6;
            --accent: #9c6f3d;
            --warning: #c48f3c;
            --link: #7a4e2b;
            --hover-bg: rgba(139,94,52,0.07);
            --active-bg: rgba(139,94,52,0.12);
            --caret-color: #8b5e34;
        }

        [data-theme="eye"] {
            --primary-color: #3aa675;
            --text-color: #1a2b22;
            --muted-text: #587a6a;
            --bg-color: #e9f5ef;
            --panel-bg: #f6fbf8;
            --border-color: #d7ece2;
            --accent: #2bb673;
            --warning: #cc9a06;
            --link: #2f8f6b;
            --hover-bg: rgba(58,166,117,0.08);
            --active-bg: rgba(58,166,117,0.14);
            --caret-color: #2f8f6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; }
        html, body { height: 100%; }
        body { background-color: var(--bg-color); color: var(--text-color); display: flex; overflow: hidden; }

        /* Sidebar */
        #sidebar { width: var(--sidebar-width); max-width: 100vw; height: 100%; background-color: var(--panel-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transition: transform 0.26s ease; z-index: 40; box-shadow: var(--shadow-sm); position: fixed; left: 0; top: 0; transform: translateX(-100%); overflow: hidden; }
        #sidebar.show { transform: translateX(0); }
        .sidebar-header { padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; }
        .logo { width: 24px; height: 24px; border-radius: 6px; background: linear-gradient(135deg, var(--primary-color), #7cc5ff); box-shadow: var(--shadow-sm); }
        /* Flatten logo (keep shadow only) */
        .logo { background: var(--primary-color); }
        .sidebar-title { font-size: 1rem; font-weight: 700; letter-spacing: 0.4px; color: var(--primary-color); }
        .sidebar-actions { margin-left: auto; display: flex; gap: 6px; }
        .icon-btn { background: none; border: 1px solid var(--border-color); color: var(--muted-text); cursor: pointer; border-radius: 8px; padding: 6px 8px; transition: all 0.15s ease; }
        .icon-btn:hover { background-color: var(--hover-bg); }
        .sidebar-search { padding: 8px 10px; border-bottom: 1px solid var(--border-color); display: flex; gap: 6px; }
        .search-input { flex: 1; border: 1px solid var(--border-color); background: transparent; border-radius: 8px; padding: 8px 10px; color: var(--text-color); font-size: 14px; }
        .search-input:focus { outline: 2px solid rgba(74,134,232,0.25); }
        .menu-section-title { font-size: 12px; color: var(--muted-text); padding: 8px 12px; text-transform: uppercase; letter-spacing: 1.2px; }
        #docList { flex: 1; overflow: auto; }
        .tree { padding: 6px 6px calc(16px + env(safe-area-inset-bottom)); overflow-x: auto; }
        .tree-root-drop { margin: 0 10px 8px 10px; padding: 6px 8px; border-radius: 6px; color: var(--muted-text); border: 1px dashed var(--border-color); font-size: 12px; position: sticky; top: 0; background: var(--panel-bg); z-index: 1; }
        .tree-root-drop.dragover { background: var(--active-bg); }
        .folder-node, .doc-node { position: relative; display: flex; align-items: center; gap: 10px; padding: 10px 10px 10px 12px; border-radius: 10px; margin: 2px 4px; overflow: hidden; box-shadow: none; background: transparent; }
        .folder-node:hover, .doc-node:hover { background: var(--hover-bg); }
        .doc-node.active { background: var(--active-bg); }
        .indent { width: var(--tree-indent); flex: 0 0 var(--tree-indent); height: 1px; }
        .caret { width: 16px; text-align: center; cursor: pointer; color: var(--muted-text); }
        .icon-folder { width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center; border-radius: 6px; background: transparent; color: #d97706; border: none; }
        .icon-doc { width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center; border-radius: 6px; background: transparent; color: var(--primary-color); border: none; }
        .folder-title { font-weight: 700; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .doc-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }
        .node-actions { display: flex; gap: 4px; }
        .node-actions .icon-btn { padding: 4px 6px; border-radius: 6px; }
        .children { margin-left: calc(var(--tree-indent) + 8px); }
        .drop-target { outline: 2px dashed var(--primary-color); }
        .drop-before::before, .drop-after::after { content: ""; position: absolute; left: 8px; right: 8px; height: 0; border-top: 2px solid var(--primary-color); }
        .drop-before::before { top: -1px; }
        .drop-after::after { bottom: -1px; }
        .sidebar-footer { border-top: 1px solid var(--border-color); padding: 8px 10px; display: flex; gap: 10px; }
        .primary-btn { background: var(--primary-color); color: #fff; border: none; padding: 8px 10px; border-radius: 8px; cursor: pointer; box-shadow: var(--shadow-sm); }
        .primary-btn:hover { filter: brightness(1.05); }

        /* Main */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; }
        .toolbar { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 8px; padding: 8px 10px; min-height: var(--toolbar-height); background-color: var(--panel-bg); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 10px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 30; }
        .menu-toggle { background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 6px; color: var(--muted-text); }
        .title-input { width: 100%; border: 1px solid transparent; border-radius: 8px; padding: 8px 10px; background: transparent; color: var(--text-color); font-size: 0.95rem; font-weight: 600; }
        .title-input:focus { outline: 2px solid rgba(74,134,232,0.25); }
        #toolsBtn { background: none; border: 1px solid var(--border-color); border-radius: 8px; padding: 6px 8px; color: var(--muted-text); }
        .word-count { padding: 8px 10px; background-color: var(--panel-bg); border-bottom: 1px solid var(--border-color); font-size: 0.9rem; color: var(--muted-text); display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 10px; position: sticky; top: var(--toolbar-height); min-height: var(--stats-height); box-shadow: 0 2px 10px rgba(0,0,0,0.06); z-index: 25; }
        .num { font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1, "lnum" 1; min-width: 5ch; text-align: right; display: inline-block; }
        .progress-bar { width: 100%; height: 8px; border-radius: 6px; background: rgba(127,127,127,0.12); overflow: hidden; border: 1px solid var(--border-color); }
        .progress { height: 100%; background: linear-gradient(90deg, var(--accent), #2dd4bf); width: 0%; }
        #editor-wrapper { position: relative; width: 100%; height: calc(100svh - var(--toolbar-height) - var(--stats-height)); background: var(--panel-bg); overflow: hidden; }
        #hl { position: absolute; inset: 0; margin: 0; padding: 16px; font-size: 1rem; line-height: 1.9; white-space: pre-wrap; word-wrap: break-word; color: var(--text-color); pointer-events: none; }
        #hl .hl-pair { color: var(--pair-color); }
        #hl .hl-name { font-weight: 600; }
        #editor { position: absolute; inset: 0; width: 100%; height: 100%; margin: 0; padding: 16px; font-size: 1rem; line-height: 1.9; background: transparent; color: transparent; border: none; border-radius: 0; box-shadow: none; resize: none; caret-color: var(--caret-color); overflow: auto; }
        #editor:focus { outline: none; }

        /* Overlays */
        #sidebar-overlay { position: fixed; top: 0; bottom: 0; left: var(--sidebar-width); right: 0; background: rgba(0,0,0,0.35); display: none; z-index: 50; }
        /* overlays removed (non-modal) */

        /* Move-To Sheet */
        /* move sheet removed */
        .sheet-row { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 8px; margin: 4px 8px; cursor: pointer; }
        .sheet-row:hover { background: var(--hover-bg); }
        .sheet-indent { width: 14px; }

        /* Drawers */
        /* Inline panels inside sidebar (non-modal) */
        #settingsDrawer, #toolsDrawer { position: static; height: auto; width: auto; max-width: none; background: var(--panel-bg); border-left: none; border-top: 1px solid var(--border-color); box-shadow: none; transform: none; transition: none; z-index: auto; display: none; flex-direction: column; }
        #settingsDrawer.show, #toolsDrawer.show { display: flex; }
        .drawer-header { padding: 12px 14px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; font-weight: 700; }
        .drawer-body { padding: 10px 14px; overflow: auto; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 12px; color: var(--muted-text); }
        .radio-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .chip { border: 1px solid var(--border-color); padding: 6px 10px; border-radius: 999px; cursor: pointer; background: transparent; color: var(--text-color); }
        .chip.active { background: var(--active-bg); border-color: var(--primary-color); }
        .num-input, .text-input, .text-area { width: 100%; border: 1px solid var(--border-color); background: transparent; color: var(--text-color); padding: 8px 10px; border-radius: 8px; }
        .text-area { min-height: 88px; line-height: 1.6; }
        /* Multi-level list look */
        .children { border-left: 1px dashed var(--border-color); margin-left: calc(var(--tree-indent)); padding-left: 6px; }
        .folder-node::before, .doc-node::before { content: ""; position: absolute; left: calc(var(--tree-indent) - 6px); width: 10px; top: 50%; border-top: 1px dashed var(--border-color); }

        /* Bottom Bars */
        #nameBar { position: fixed; left: 0; right: 0; bottom: calc(var(--mobile-bar-height) + env(safe-area-inset-bottom)); background: var(--panel-bg); border-top: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: none; z-index: 55; }
        #nameBar .row { height: var(--name-bar-height); display: grid; grid-auto-columns: max-content; grid-auto-flow: column; overflow-x: auto; gap: 6px; padding: 6px 8px; }
        #nameBar .n-btn { border: 1px solid var(--border-color); background: transparent; color: var(--text-color); border-radius: 10px; font-size: var(--name-font-size); padding: 4px 10px; white-space: nowrap; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        #nameBar .n-btn:active { background: var(--hover-bg); }

        #mobileBar { position: fixed; left: 0; right: 0; bottom: 0; background: var(--panel-bg); border-top: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: none; z-index: 55; padding-bottom: env(safe-area-inset-bottom); }
        #mobileBar .row { height: var(--mobile-bar-height); display: grid; grid-auto-columns: 1fr; grid-auto-flow: column; overflow-x: auto; gap: 6px; padding: 6px 8px; }
        #mobileBar .m-btn { border: 1px solid var(--border-color); background: transparent; color: var(--text-color); border-radius: 10px; font-size: var(--symbol-font-size); padding: 6px 10px; white-space: nowrap; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        #mobileBar .m-btn:active { background: var(--hover-bg); }
         .pad-bottom { padding-bottom: calc(16px + var(--mobile-bar-height) * var(--mobile-rows) + env(safe-area-inset-bottom)); }
         .with-name { padding-bottom: calc(16px + var(--mobile-bar-height) * var(--mobile-rows) + var(--name-bar-height) * var(--name-rows) + env(safe-area-inset-bottom)); }
         
         /* Focus mode */
         body.focus-mode #sidebar { display: none; }
 
         /* Snackbar: bottom center, above bars, no overlap with top */
         #snackbar { position: fixed; left: 50%; transform: translateX(-50%) translateY(12px); bottom: calc(12px + env(safe-area-inset-bottom)); background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 10px; box-shadow: var(--shadow-sm); opacity: 0; pointer-events: none; transition: opacity .18s ease; z-index: 80; display: flex; gap: 8px; align-items: center; }
         #snackbar.show { opacity: 1; }

        /* Remove bottom bars (deprecated) */
        #nameBar, #mobileBar { display: none !important; }

        /* Drag handle for touch-friendly DnD */
        .drag-handle { cursor: grab; padding: 4px; color: var(--muted-text); user-select: none; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="sidebar-header">
            <div class="logo"></div>
            <div class="sidebar-title">纯纯写作</div>
            <div class="sidebar-actions">
                <button id="themeToggle" class="icon-btn" title="切换明暗">🌗</button>
                <button id="settingsBtn" class="icon-btn" title="设置">⚙️</button>
            </div>
        </div>
        <div class="sidebar-search">
            <input id="searchInput" class="search-input" placeholder="搜索文档 (⌘/Ctrl K)">
            <button id="newDocBtn" class="primary-btn" title="新建文档">＋</button>
        </div>
        <div class="menu-section-title">目录</div>
        <div id="docList">
            <div id="tree" class="tree"></div>
        </div>
        <div class="sidebar-footer">
            <button id="newNovelBtn" class="toolbar-btn icon-btn" title="新建小说">📚</button>
            <button id="newFolderBtn" class="toolbar-btn icon-btn" title="新建文件夹">📁＋</button>
            <button id="importBtn" class="toolbar-btn icon-btn" title="导入 .txt">📥</button>
            <input id="importFile" type="file" accept=".txt,.md,text/plain" style="display:none">
        </div>
    </aside>

    <div id="main-container">
        <div id="sidebar-overlay"></div>
        <div class="toolbar">
            <button class="menu-toggle" id="menuToggle" title="目录">☰</button>
            <input type="text" id="titleInput" class="title-input" placeholder="标题">
            <button id="toolsBtn" title="工具" class="icon-btn">⋯</button>
        </div>

        <div class="word-count">
            <div>字数：<span id="charCount" class="num">0</span></div>
            <div class="progress-bar"><div id="goalProgress" class="progress"></div></div>
            <div>目标：<span id="goalNum" class="num">1000</span></div>
        </div>

        <div id="editor-wrapper">
            <pre id="hl"></pre>
            <textarea id="editor" spellcheck="false" placeholder="开始创作……"></textarea>
        </div>
    </div>

    <!-- Settings Panel (inline, non-modal) -->
    <aside id="settingsDrawer" class="show">
        <div class="drawer-header">
            <span>设置</span>
            <div></div>
        </div>
        <div class="drawer-body">
            <div class="form-group">
                <label>主题</label>
                <div class="radio-row" id="themeChips">
                    <button class="chip" data-theme="light">明亮</button>
                    <button class="chip" data-theme="dark">暗黑</button>
                    <button class="chip" data-theme="sepia">古风</button>
                    <button class="chip" data-theme="eye">护眼</button>
                </div>
            </div>
            <div class="form-group">
                <label>当前文档字数目标</label>
                <input id="docGoalInput" class="num-input" type="number" min="0" step="100" placeholder="1000">
            </div>
            <div class="form-group">
                <label>跳出双符号（成对，空格分隔，如 () [] {} “” 「」 《》 ）</label>
                <input id="jumpPairsInput" class="text-input" placeholder="() [] {} “” 「」 《》 （） '' &quot;&quot;">
            </div>
            <div class="form-group">
                <label>双符内内容颜色（支持 #HEX 或标准颜色名）</label>
                <input id="pairColorInput" class="text-input" type="text" placeholder="#777777 或 orange" value="#f59e0b">
            </div>
            <div class="form-group">
                <label>人名颜色（按阵营；每行：阵营名 #色值: 名1 名2 ...）</label>
                <textarea id="factionInput" class="text-area" placeholder="正派 #22c55e: 小明 小红\n反派 #ef4444: 张三 李四"></textarea>
            </div>
            <button id="saveSettings" class="primary-btn">保存</button>
        </div>
    </aside>

    <!-- Tools Panel (inline, non-modal) -->
    <aside id="toolsDrawer" class="show">
        <div class="drawer-header">
            <span>工具</span>
            <div></div>
        </div>
        <div class="drawer-body">
            <div class="form-group">
                <label>常用</label>
                <div class="radio-row">
                    <button id="toolNewDoc" class="chip">新建文档</button>
                    <button id="toolNewFolder" class="chip">新建文件夹</button>
                    <button id="toolNewNovel" class="chip">新建小说</button>
                </div>
            </div>
            <div class="form-group">
                <label>模板</label>
                <div class="radio-row">
                    <button id="toolTplPerson" class="chip">人物卡</button>
                    <button id="toolTplScene" class="chip">场景卡</button>
                    <button id="toolTplWorld" class="chip">世界观</button>
                </div>
            </div>
            <div class="form-group">
                <label>导入导出</label>
                <div class="radio-row">
                    <button id="toolExportTxt" class="chip">导出 TXT</button>
                    <button id="toolExportMd" class="chip">导出 MD</button>
                    <button id="toolImport" class="chip">导入文本</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Move-To Sheet -->
    

    <!-- Snackbar -->
    <div id="snackbar"><span id="snackMsg"></span><span id="snackAction" class="snack-action"></span></div>

    <!-- Bottom Bars removed -->

    <script>
        // Utilities & Storage helpers
        function $(sel) { return document.querySelector(sel); }
        function $all(sel) { return Array.from(document.querySelectorAll(sel)); }
        function createEl(tag, cls) { const el = document.createElement(tag); if (cls) el.className = cls; return el; }
        function debounce(fn, wait) { let t; return function(...args){ clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); }; }
        function throttleRaf(fn) { let ticking = false; return function(...args){ if (ticking) return; ticking = true; requestAnimationFrame(() => { fn.apply(this, args); ticking = false; }); }; }
        function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
        function todayKey() { const d = new Date(); return d.toISOString().slice(0,10); }
        function loadJSON(key, def){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch { return def; } }
        function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

        // Storage keys
        const STORAGE_KEYS = {
            DOCS: 'novelDocs',
            FOLDERS: 'novelFolders',
            FOLDER_STATE: 'novelFolderState',
            CURRENT_ID: 'currentDocId',
            THEME: 'theme',
            JUMP_PAIRS: 'jumpPairs',
            PAIR_COLOR: 'pairColor',
            FACTIONS: 'nameFactions'
        };

        // Persisted getters/setters
        function loadDocs() { return loadJSON(STORAGE_KEYS.DOCS, []); }
        function saveDocs(v) { saveJSON(STORAGE_KEYS.DOCS, v); }
        function loadFolders() { return loadJSON(STORAGE_KEYS.FOLDERS, []); }
        function saveFolders(v) { saveJSON(STORAGE_KEYS.FOLDERS, v); }
        function loadFolderState() { return loadJSON(STORAGE_KEYS.FOLDER_STATE, {}); }
        function saveFolderState(v) { saveJSON(STORAGE_KEYS.FOLDER_STATE, v); }
        function getCurrentId() { return localStorage.getItem(STORAGE_KEYS.CURRENT_ID); }
        function setCurrentId(id) { localStorage.setItem(STORAGE_KEYS.CURRENT_ID, id); }
        function loadTheme() { return localStorage.getItem(STORAGE_KEYS.THEME) || 'light'; }
        function saveTheme(theme) { localStorage.setItem(STORAGE_KEYS.THEME, theme); }
        function loadJumpPairs() { return loadJSON(STORAGE_KEYS.JUMP_PAIRS, ["()","[]","{}","“”","‘’","「」","《》","（）","''","\"\""]); }
        function saveJumpPairs(arr) { saveJSON(STORAGE_KEYS.JUMP_PAIRS, arr); }
        function loadPairColor(){ return localStorage.getItem(STORAGE_KEYS.PAIR_COLOR) || '#f59e0b'; }
        function savePairColor(v){ localStorage.setItem(STORAGE_KEYS.PAIR_COLOR, v); }
        function loadFactions(){ return loadJSON(STORAGE_KEYS.FACTIONS, []); }
        function saveFactions(v){ saveJSON(STORAGE_KEYS.FACTIONS, v); }

        // App state
        let docs = loadDocs();
        let folders = loadFolders();
        let folderOpenState = loadFolderState();
        let currentDocId = getCurrentId();
        let draggedDocId = null;
        let draggedFolderId = null;
        let lastDeleted = null;

        // Elements
        const sidebar = $('#sidebar');
        const overlay = $('#sidebar-overlay');
        const mobileBar = $('#mobileBar');
        const nameBar = $('#nameBar');
        const editor = $('#editor');
        const treeEl = $('#tree');
        const titleInput = $('#titleInput');
        const charCountEl = $('#charCount');
        const goalNum = $('#goalNum');
        const goalProgress = $('#goalProgress');
        const drawer = $('#settingsDrawer');
        const drawerOverlay = $('#drawerOverlay');
        const toolsDrawer = $('#toolsDrawer');
        const docGoalInput = $('#docGoalInput');
        const jumpPairsInput = $('#jumpPairsInput');
        const pairColorInput = $('#pairColorInput');
        const factionInput = $('#factionInput');


        // Theme
        function applyTheme(theme){ document.documentElement.setAttribute('data-theme', theme); selectThemeChip(theme); }
        applyTheme(loadTheme());

        // Initialize defaults
        if (!docs.length) {
            const id = 'doc_' + Date.now();
            docs.push({ id, title: '我的写作笔记', content: '开始创作……', starred: false, createdAt: Date.now(), updatedAt: Date.now(), folderId: null, sort: 0, goal: 1000 });
            saveDocs(docs); currentDocId = id; setCurrentId(id);
        }
        if (!folders.length) {
            const fid = 'fld_' + Date.now();
            folders.push({ id: fid, name: '我的作品', parentId: null, sort: 0 });
            folderOpenState[fid] = true; saveFolders(folders); saveFolderState(folderOpenState);
        }
        function ensureOrdering(){ const perF = new Map(); for (const f of folders){ const p=f.parentId||null; if(!perF.has(p)) perF.set(p,[]); perF.get(p).push(f);} for (const [p,arr] of perF){ arr.sort((a,b)=>((a.sort??1e9)-(b.sort??1e9))||a.name.localeCompare(b.name)); arr.forEach((f,i)=>{ if(typeof f.sort!== 'number') f.sort=i; }); } const perD=new Map(); for(const d of docs){ const p=d.folderId||null; if(!perD.has(p)) perD.set(p,[]); perD.get(p).push(d);} for(const [p,arr] of perD){ arr.sort((a,b)=>((a.sort??1e9)-(b.sort??1e9))|| (b.updatedAt-a.updatedAt)); arr.forEach((d,i)=>{ if(typeof d.sort!== 'number') d.sort=i; if(typeof d.goal!== 'number') d.goal=1000;}); } saveFolders(folders); saveDocs(docs);} ensureOrdering();

        // Helpers for bars
        function getSymbolBars(){ return []; }
        function renderSymbolBars(){ /* removed */ }
        function getNameBars(){ return []; }
        function renderNameBars(){ /* removed */ }

        // Render tree (unchanged inputs omitted for brevity)
        function getChildrenFolders(parentId) { return folders.filter(f=>f.parentId===parentId).sort((a,b)=>a.sort-b.sort||a.name.localeCompare(b.name)); }
        function getFolderDocs(folderId) { return docs.filter(d=>(d.folderId||null)===(folderId||null)).sort((a,b)=>a.sort-b.sort||(b.updatedAt-a.updatedAt)); }
        function isOpen(fid){ return !!folderOpenState[fid]; }
        function setOpen(fid,open){ folderOpenState[fid]=open; saveFolderState(folderOpenState); }
        function renderTree(filter=''){ const kw=(filter||'').trim().toLowerCase(); treeEl.innerHTML=''; const rootDrop=createEl('div','tree-root-drop'); rootDrop.textContent='拖动文档到此处移动到根目录'; rootDrop.addEventListener('dragover',(e)=>{ if(!draggedDocId)return; e.preventDefault(); rootDrop.classList.add('dragover'); },{passive:false}); rootDrop.addEventListener('dragleave',()=> rootDrop.classList.remove('dragover')); rootDrop.addEventListener('drop',(e)=>{ if(!draggedDocId)return; e.preventDefault(); rootDrop.classList.remove('dragover'); moveDocToFolder(draggedDocId,null); }); treeEl.appendChild(rootDrop); for(const d of getFolderDocs(null)){ if(kw && !d.title.toLowerCase().includes(kw)) continue; treeEl.appendChild(renderDocNode(d,0)); } function renderFolder(f,level){ const row=createEl('div','folder-node'); row.dataset.folderId=f.id; const indent=createEl('div','indent'); indent.style.marginLeft=(level*14)+'px'; const caret=createEl('div','caret'); caret.textContent=isOpen(f.id)?'▾':'▸'; caret.addEventListener('click',()=>{ const op=!isOpen(f.id); setOpen(f.id,op); caret.textContent=op?'▾':'▸'; children.style.display=op?'':'none'; }); const handle=createEl('div','drag-handle'); handle.textContent='≡'; handle.title='拖动排序'; handle.draggable=true; handle.addEventListener('dragstart', (e)=>{ draggedFolderId=f.id; e.dataTransfer.effectAllowed='move'; }); handle.addEventListener('dragend', ()=>{ draggedFolderId=null; }); const icon=createEl('div','icon-folder'); const title=createEl('div','folder-title'); title.textContent=f.name; const actions=createEl('div','node-actions'); const addDocBtn=createEl('button','icon-btn'); addDocBtn.textContent='📝＋'; addDocBtn.title='新建文档'; addDocBtn.addEventListener('click',(e)=>{ e.stopPropagation(); createDoc('',f.id,'新文档'); }); const addFolderBtn=createEl('button','icon-btn'); addFolderBtn.textContent='＋'; addFolderBtn.title='新建子文件夹'; addFolderBtn.addEventListener('click',(e)=>{ e.stopPropagation(); createFolder(f.id); }); const renameBtn=createEl('button','icon-btn'); renameBtn.textContent='✎'; renameBtn.title='重命名'; renameBtn.addEventListener('click',(e)=>{ e.stopPropagation(); inlineRenameFolder(f.id,title); }); actions.appendChild(addDocBtn); actions.appendChild(addFolderBtn); actions.appendChild(renameBtn); row.appendChild(indent); row.appendChild(caret); row.appendChild(handle); row.appendChild(icon); row.appendChild(title); row.appendChild(actions); row.addEventListener('dragover',(e)=>{ if(draggedDocId){ e.preventDefault(); row.classList.add('drop-target'); return; } if(draggedFolderId && draggedFolderId!==f.id){ const dragged=folders.find(x=>x.id===draggedFolderId); if(!dragged|| (dragged.parentId||null)!==(f.parentId||null)) return; e.preventDefault(); const rect=row.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; row.classList.toggle('drop-before',before); row.classList.toggle('drop-after',!before); }},{passive:false}); row.addEventListener('dragleave',()=>{ row.classList.remove('drop-target','drop-before','drop-after'); }); row.addEventListener('drop',(e)=>{ e.preventDefault(); if(draggedDocId){ moveDocToFolder(draggedDocId,f.id); row.classList.remove('drop-target'); return; } if(draggedFolderId && draggedFolderId!==f.id){ const dragged=folders.find(x=>x.id===draggedFolderId); if(!dragged|| (dragged.parentId||null)!==(f.parentId||null)) return; const rect=row.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; reorderFolders(dragged.parentId||null, draggedFolderId, f.id, before?'before':'after'); } row.classList.remove('drop-before','drop-after'); }); const children=createEl('div','children'); children.style.display=isOpen(f.id)?'':'none'; for(const d of getFolderDocs(f.id)){ if(kw && !d.title.toLowerCase().includes(kw)) continue; children.appendChild(renderDocNode(d,level+1)); } for(const sf of getChildrenFolders(f.id)) children.appendChild(renderFolder(sf,level+1)); const wrap=createEl('div'); wrap.appendChild(row); wrap.appendChild(children); return wrap; } for(const f of getChildrenFolders(null)) treeEl.appendChild(renderFolder(f,0)); }
        function renderDocNode(doc, level){ const row=createEl('div','doc-node'); row.dataset.docId=doc.id; if(doc.id===currentDocId) row.classList.add('active'); const indent=createEl('div','indent'); indent.style.marginLeft=(level*14)+'px'; const handle=createEl('div','drag-handle'); handle.textContent='≡'; handle.title='拖动排序'; handle.draggable=true; handle.addEventListener('dragstart',(e)=>{ draggedDocId=doc.id; e.dataTransfer.effectAllowed='move'; }); handle.addEventListener('dragend',()=>{ draggedDocId=null; row.classList.remove('drop-before','drop-after'); }); row.draggable=true; row.addEventListener('dragstart',(e)=>{ if(e.target!==handle && !e.target.classList.contains('drag-handle')){ // allow row-drag fallback
                draggedDocId=doc.id; e.dataTransfer.effectAllowed='move'; } }); row.addEventListener('dragend',()=>{ draggedDocId=null; }); const icon=createEl('div','icon-doc'); const title=createEl('div','doc-title'); title.textContent=doc.title||'无标题'; const actions=createEl('div','node-actions'); const starBtn=createEl('button','icon-btn'); starBtn.innerHTML=doc.starred?'⭐':'☆'; starBtn.title=doc.starred?'取消收藏':'收藏'; starBtn.addEventListener('click',(e)=>{ e.stopPropagation(); toggleStar(doc.id); });  const delBtn=createEl('button','icon-btn'); delBtn.textContent='🗑️'; delBtn.title='删除'; delBtn.addEventListener('click',(e)=>{ e.stopPropagation(); softDeleteDoc(doc.id); }); actions.appendChild(starBtn); actions.appendChild(delBtn); row.appendChild(indent); row.appendChild(handle); row.appendChild(icon); row.appendChild(title); row.appendChild(actions); row.addEventListener('click',()=> selectDoc(doc.id)); row.addEventListener('dragover',(e)=>{ if(!draggedDocId || draggedDocId===doc.id) return; const dragged=docs.find(d=>d.id===draggedDocId); if(!dragged || (dragged.folderId||null)!==(doc.folderId||null)) return; e.preventDefault(); const rect=row.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; row.classList.toggle('drop-before',before); row.classList.toggle('drop-after',!before); },{passive:false}); row.addEventListener('dragleave',()=> row.classList.remove('drop-before','drop-after')); row.addEventListener('drop',(e)=>{ if(!draggedDocId || draggedDocId===doc.id) return; const dragged=docs.find(d=>d.id===draggedDocId); if(!dragged || (dragged.folderId||null)!==(doc.folderId||null)) return; e.preventDefault(); const rect=row.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; reorderDocs(doc.folderId||null, draggedDocId, doc.id, before?'before':'after'); }); return row; }
        function reorderDocs(parentId, draggedId, targetId, position){ const list=docs.filter(d=>(d.folderId||null)===(parentId||null)).sort((a,b)=>a.sort-b.sort); const idx=new Map(list.map((d,i)=>[d.id,i])); const di=idx.get(draggedId), ti=idx.get(targetId); if(di==null||ti==null) return; list.splice(di,1); list.splice(position==='before'?ti:ti+1,0, docs.find(d=>d.id===draggedId)); list.forEach((d,i)=> d.sort=i); saveDocs(docs); renderTree($('#searchInput').value); }
        function reorderFolders(parentId, draggedId, targetId, position){ const list=folders.filter(f=>(f.parentId||null)===(parentId||null)).sort((a,b)=>a.sort-b.sort); const idx=new Map(list.map((f,i)=>[f.id,i])); const di=idx.get(draggedId), ti=idx.get(targetId); if(di==null||ti==null) return; list.splice(di,1); list.splice(position==='before'?ti:ti+1,0, folders.find(f=>f.id===draggedId)); list.forEach((f,i)=> f.sort=i); saveFolders(folders); renderTree($('#searchInput').value); }

        // CRUD & selection
        function currentDoc(){ return docs.find(x=>x.id===currentDocId); }
        function selectDoc(id){ const doc=docs.find(x=>x.id===id); if(!doc) return; currentDocId=id; setCurrentId(id); titleInput.value=doc.title||''; editor.value=doc.content||''; updateWordStats(); updateGoalUI(); renderTree($('#searchInput').value); applyDynamicColors(); updateHighlight(); syncHighlightScroll(); editor.focus(); }
        function detectNextChapterTitle(folderId){ const list=docs.filter(d=>(d.folderId||null)===(folderId||null)).sort((a,b)=>a.sort-b.sort); let maxNum=0; const re=/^第(\d+)章(\s?)/; for(const d of list){ const m=(d.title||'').match(re); if(m){ const n=parseInt(m[1],10); if(Number.isFinite(n)) maxNum=Math.max(maxNum,n); } } const next=maxNum+1; return `第${next}章 `; }
        function createDoc(initialContent='', folderId=null, title){ const id='doc_'+Math.random().toString(36).slice(2); const now=Date.now(); const sibling=docs.filter(d=>(d.folderId||null)===(folderId||null)).length; const defaultTitle = title!=null? title : detectNextChapterTitle(folderId); const newDoc={ id, title: defaultTitle, content: initialContent, starred:false, createdAt:now, updatedAt:now, folderId, sort:sibling, goal:1000 }; docs.push(newDoc); saveDocs(docs); selectDoc(id); }
        function createNovel() {
            const fid = generateId('fld'); const parentId = null;
            const siblingCount = folders.filter(f => (f.parentId || null) === (parentId || null)).length;
            const folder = { id: fid, name: '新小说', parentId, sort: siblingCount };
            folders.push(folder); folderOpenState[fid] = true; saveFolders(folders); saveFolderState(folderOpenState);
            createDoc('书名：\n主旨：\n人设：\n世界观：\n情节提要：\n', fid, '大纲');
            createDoc('第1章\n\n', fid, '第1章');
            showSnack('已创建小说“新小说”'); renderTree($('#searchInput').value);
        }
        function moveDocToFolder(docId, folderId){ const doc=docs.find(d=>d.id===docId); if(!doc) return; const p=folderId||null; doc.folderId=p; doc.updatedAt=Date.now(); doc.sort=docs.filter(d=>(d.folderId||null)===p).length; saveDocs(docs); renderTree($('#searchInput').value); }
        function softDeleteDoc(id){ const i=docs.findIndex(d=>d.id===id); if(i===-1) return; const rm=docs.splice(i,1)[0]; saveDocs(docs); if(currentDocId===id){ if(docs.length) selectDoc(docs[0].id); else createDoc(); } renderTree($('#searchInput').value); lastDeleted={doc:rm}; }
        function toggleStar(id){ const doc=docs.find(d=>d.id===id); if(!doc) return; doc.starred=!doc.starred; doc.updatedAt=Date.now(); saveDocs(docs); renderTree($('#searchInput').value); }
        function createFolder(parentId=null){ const id='fld_'+Math.random().toString(36).slice(2); const sibling=folders.filter(f=>(f.parentId||null)===(parentId||null)).length; const f={ id, name:'新建文件夹', parentId:parentId||null, sort:sibling }; folders.push(f); folderOpenState[id]=true; saveFolders(folders); saveFolderState(folderOpenState); renderTree($('#searchInput').value); }
        function inlineRenameFolder(folderId, titleEl){ const f=folders.find(x=>x.id===folderId); if(!f) return; const old=f.name; const input=document.createElement('input'); input.type='text'; input.value=old; input.className='text-input'; titleEl.replaceWith(input); input.focus(); input.select(); const commit=()=>{ f.name=(input.value.trim()||old); saveFolders(folders); renderTree($('#searchInput').value); }; input.addEventListener('blur',commit); input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); input.blur(); } if(e.key==='Escape'){ f.name=old; input.blur(); } }); }

        // Goal bar logic (per-doc)
        function updateGoalUI(){ const doc=currentDoc(); const goal=(doc&&typeof doc.goal==='number')? doc.goal : 1000; goalNum.textContent=goal; const chars=(editor.value||'').replace(/\s+/g,'').length; charCountEl.textContent=chars; const pct=goal<=0?1:Math.max(0, Math.min(1, chars/goal)); goalProgress.style.width=(pct*100).toFixed(1)+'%'; }

        // Simple inline preview coloring using background highlights via overlay (textarea has no rich text; we simulate via CSS custom highlight using selection):
        // Implement minimal live hint by setting caret color and skipping heavy rendering to keep performance on mobile.
        function applyDynamicColors(){ document.documentElement.style.setProperty('--pair-color', loadPairColor()); updateHighlight(); }

        // Saving & stats
        const persist=debounce(function(){ const doc=currentDoc(); if(!doc) return; doc.title=titleInput.value.trim()||'无标题文档'; doc.content=editor.value; doc.updatedAt=Date.now(); saveDocs(docs); updateGoalUI(); renderTree($('#searchInput').value); }, 180);
        function saveNow(){ persist(); }
        const updateWordStats=throttleRaf(()=>{ updateGoalUI(); });

        // Templates & insertion helpers
        function insertAtCursor(text){ const start=editor.selectionStart, end=editor.selectionEnd, val=editor.value; editor.value=val.slice(0,start)+text+val.slice(end); const caret=start+text.length; editor.selectionStart=editor.selectionEnd=caret; setTimeout(()=> editor.focus({ preventScroll: true }), 0); saveNow(); updateWordStats(); }
        function buildPairs(){ return loadJumpPairs().map(p=>[p[0], p[1]]); }
        function insertPair(left,right){ const start=editor.selectionStart, end=editor.selectionEnd, val=editor.value; const inside=left+right; editor.value=val.slice(0,start)+inside+val.slice(end); editor.selectionStart=editor.selectionEnd=start+1; setTimeout(()=> editor.focus({ preventScroll: true }), 0); saveNow(); updateWordStats(); }
        function insertSymbolToken(tok){ if(typeof tok==='string' && tok.length===2){ const pairs=buildPairs(); for(const [L,R] of pairs){ if(tok===L+R){ insertPair(L,R); return; } } }
            insertAtCursor(tok); }

        // Highlight overlay
        const hl = document.getElementById('hl');
        function escapeChar(c){ if(c==='&') return '&amp;'; if(c==='<') return '&lt;'; if(c==='>') return '&gt;'; return c; }
        function updateHighlight(){ const text = editor.value || ''; const length = text.length; const opens = new Map(); const closes = new Map(); function addRange(s,e,openTag){ if(s<0||e<=s||e>length) return; if(!opens.has(s)) opens.set(s,[]); if(!closes.has(e)) closes.set(e,[]); opens.get(s).push(openTag); closes.get(e).push('</span>'); }
            // Pair content ranges
            const pairs = buildPairs();
            for(const [L,R] of pairs){ let idx=0; while(true){ const start = text.indexOf(L, idx); if(start===-1) break; const end = text.indexOf(R, start+L.length); if(end===-1) break; addRange(start+L.length, end, '<span class="hl-pair">'); idx = end + R.length; } }
            // Name ranges from factions
            const factions = loadFactions();
            for(const f of factions){ if(!f||!Array.isArray(f.names)) continue; const col = f.color || '#10b981'; for(const nm of f.names){ if(!nm) continue; const re = new RegExp(nm.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g'); let m; while((m=re.exec(text))){ const s=m.index, e=s+nm.length; addRange(s,e, `<span class=\"hl-name\" style=\"color:${col}\">`); if(m.index===re.lastIndex) re.lastIndex++; } } }
            // Build html
            let out=''; for(let i=0;i<length;i++){ const ctags = closes.get(i); if(ctags){ // close in reverse for nesting
                    for(let k=ctags.length-1;k>=0;k--) out+=ctags[k]; }
                const otags = opens.get(i); if(otags){ for(const t of otags) out+=t; }
                out += escapeChar(text[i]); }
            const endTags = closes.get(length); if(endTags){ for(let k=endTags.length-1;k>=0;k--) out+=endTags[k]; }
            hl.innerHTML = out; }
        function syncHighlightScroll(){ const st = editor.scrollTop; const sl = editor.scrollLeft; hl.style.transform = `translate(${-sl}px, ${-st}px)`; }
        editor.addEventListener('input', ()=>{ updateHighlight(); updateWordStats(); persist(); });
        editor.addEventListener('scroll', syncHighlightScroll);

        // Jump-out anywhere inside pair on Enter
        function isInsidePair(pos, left, right, text){ const l=text.lastIndexOf(left, pos-1); if(l<0) return false; const r=text.indexOf(right, pos); if(r<0) return false; return l < pos && pos <= r; }
        function jumpOutIfInside(e){ if(e.key!=='Enter') return; const pos=editor.selectionStart; if(pos!==editor.selectionEnd) return; const text=editor.value; if(pos<=0 || pos>text.length) return; const pairs=buildPairs(); for(const [L,R] of pairs){ const inside=isInsidePair(pos, L, R, text); if(inside){ const r=text.indexOf(R, pos); if(r>=0){ e.preventDefault(); editor.selectionStart=editor.selectionEnd=r+1; editor.focus(); return; } } } }

        // Snackbar
        let snackTimer=null; function showSnack(msg){ const el=$('#snackbar'); $('#snackMsg').textContent=msg; $('#snackAction').textContent=''; el.classList.add('show'); clearTimeout(snackTimer); snackTimer=setTimeout(()=> el.classList.remove('show'), 1600); }

        // Drawers & settings
        function openDrawer(){ drawer.classList.add('show'); const doc=currentDoc(); docGoalInput.value = doc && typeof doc.goal==='number' ? String(doc.goal) : '1000'; loadBarsIntoSettings(); }
        function closeDrawer(){ drawer.classList.remove('show'); }
        function selectThemeChip(theme){ $all('#themeChips .chip').forEach(c=> c.classList.toggle('active', c.dataset.theme===theme)); }
        function openTools(){ toolsDrawer.classList.add('show'); }
        function closeTools(){ toolsDrawer.classList.remove('show'); }
        function loadBarsIntoSettings(){ const pairColor=loadPairColor(); pairColorInput.value=pairColor; jumpPairsInput.value=loadJumpPairs().join(' '); const factions=loadFactions(); const lines=factions.map(f=>`${f.group} ${f.color}: ${f.names.join(' ')}`); factionInput.value=lines.join('\n'); }
        function saveSettings(){ const pairsTokens=(jumpPairsInput.value||'').trim().split(/\s+/).filter(Boolean); const pairs=[]; for(const tok of pairsTokens){ if(tok.length>=2) pairs.push(tok.slice(0,2)); } if(!pairs.length) pairs.push(...["()","[]","{}","“”","‘’","「」","《》","（）","''","\"\""]); saveJumpPairs(pairs);
            let color=(pairColorInput.value||'#f59e0b').trim(); if(!color) color='#f59e0b'; savePairColor(color);
            const lines=(factionInput.value||'').split(/\n/).filter(Boolean); const fac=[]; for(const ln of lines){ const m=ln.match(/^\s*([^#:]+)\s+((?:#[0-9a-fA-F]{3,8})|[a-zA-Z]+)\s*:\s*(.+)$/); if(m){ const group=m[1].trim(); const col=m[2].trim(); const names=m[3].trim().split(/\s+/).filter(Boolean); fac.push({group,color:col,names}); } }
            saveFactions(fac); showSnack('已保存设置'); }

        // IME visibility heuristics removed (bottom bars deprecated)
        let imeVisible=false; function showBarsIfIME(){ /* no-op */ }

        // Bindings
        function bindGlobal(){
            // Sidebar & theme
            $('#menuToggle').addEventListener('click', ()=>{ sidebar.classList.toggle('show'); overlay.style.display=sidebar.classList.contains('show')?'block':'none'; });
            overlay.addEventListener('click', ()=>{ sidebar.classList.remove('show'); overlay.style.display='none'; });
            $('#themeToggle').addEventListener('click', ()=>{ const cur=loadTheme(); const next= (cur==='dark')?'light': (cur==='light')?'sepia': (cur==='sepia')?'eye':'dark'; saveTheme(next); applyTheme(next); applyDynamicColors(); updateHighlight(); });

            // Tools
            $('#toolsBtn').addEventListener('click', ()=>{ toolsDrawer.classList.toggle('show'); });
            $('#toolNewDoc').addEventListener('click', ()=>{ createDoc(); closeTools(); });
            $('#toolNewFolder').addEventListener('click', ()=>{ createFolder(null); closeTools(); });
            $('#toolNewNovel').addEventListener('click', ()=>{ createNovel(); closeTools(); });
            $('#toolTplPerson').addEventListener('click', ()=>{ insertTemplate('person'); closeTools(); });
            $('#toolTplScene').addEventListener('click', ()=>{ insertTemplate('scene'); closeTools(); });
            $('#toolTplWorld').addEventListener('click', ()=>{ insertTemplate('world'); closeTools(); });
            $('#toolExportTxt').addEventListener('click', ()=>{ const doc=currentDoc(); if(!doc) return; const blob=new Blob([doc.content||''],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(doc.title||'导出')+'.txt'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0); });
            $('#toolExportMd').addEventListener('click', ()=>{ const doc=currentDoc(); if(!doc) return; const blob=new Blob([doc.content||''],{type:'text/markdown;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(doc.title||'导出')+'.md'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0); });
            $('#toolImport').addEventListener('click', ()=>{ $('#importFile').click(); closeTools(); });

            // Settings
            $('#settingsBtn').addEventListener('click', openDrawer); $('#closeDrawer').addEventListener('click', closeDrawer); drawerOverlay.addEventListener('click', closeDrawer);
            $all('#themeChips .chip').forEach(ch=> ch.addEventListener('click', ()=>{ const theme=ch.dataset.theme; saveTheme(theme); applyTheme(theme); showSnack('主题：'+ch.textContent); }));
            $('#saveSettings').addEventListener('click', ()=>{ saveSettings(); applyDynamicColors(); updateHighlight(); });

            // Footer & import
            $('#newDocBtn').addEventListener('click', ()=> createDoc());
            $('#newFolderBtn').addEventListener('click', ()=> createFolder(null));
            $('#newNovelBtn').addEventListener('click', ()=> createNovel());
            $('#importBtn').addEventListener('click', ()=> $('#importFile').click());
            $('#importFile').addEventListener('change', async (e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const text=await f.text(); createDoc(text,null,f.name.replace(/\.[^.]+$/, '')); e.target.value=''; });

            // Search
            $('#searchInput').addEventListener('input', debounce((e)=> renderTree(e.target.value), 120));

            // Editor
            titleInput.addEventListener('input', ()=>{ persist(); renderTree($('#searchInput').value); });
            editor.addEventListener('keydown', jumpOutIfInside);
            editor.addEventListener('focus', ()=>{ imeVisible=true; showBarsIfIME(); });
            editor.addEventListener('blur', ()=>{ imeVisible=false; showBarsIfIME(); });
            if(window.visualViewport){ window.visualViewport.addEventListener('resize', ()=>{ const vv=window.visualViewport; // keep bars removed; prevent layout shift by relying on 100svh
            }); }
            window.addEventListener('resize', throttleRaf(()=>{ /* no-op for bars */ }));

            // Shortcuts
            document.addEventListener('keydown', (e)=>{ const mod=e.ctrlKey||e.metaKey; if(mod && e.key.toLowerCase()==='s'){ e.preventDefault(); saveNow(); } if(mod && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#searchInput').focus(); } }, {passive:false});
        }

        // Boot
        bindGlobal(); renderTree(); selectDoc(currentDocId || docs[0].id); updateHighlight(); syncHighlightScroll();
    </script>
</body>
</html>