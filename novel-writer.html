<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°è¯´å†™ä½œåº”ç”¨ - æœ¬åœ°ç‰ˆ</title>
  <style>
    :root {
      --bg: #ffffff;
      --bg-elev: #f6f7f9;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #3b82f6;
      --primary-600: #2563eb;
      --border: #e5e7eb;
      --danger: #ef4444;
      --ok: #16a34a;
      --shadow: 0 1px 2px rgba(0,0,0,0.05), 0 4px 16px rgba(0,0,0,0.06);
      --editor-font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --editor-size: 16px;
      --editor-line-height: 1.7;
      --editor-max-width: 860px;
      --editor-paragraph-gap: 10px;
    }
    .dark {
      --bg: #0b0f14;
      --bg-elev: #121821;
      --text: #e5e7eb;
      --muted: #93a4b7;
      --primary: #60a5fa;
      --primary-600: #93c5fd;
      --border: #1f2a37;
      --danger: #f87171;
      --ok: #34d399;
      --shadow: 0 1px 2px rgba(255,255,255,0.04), 0 4px 16px rgba(255,255,255,0.03);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }

    .app {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-elev);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .brand {
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .spacer { flex: 1; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      height: 30px;
      padding: 0 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text);
      cursor: pointer;
    }
    .btn:hover { background: var(--bg-elev); }
    .btn.primary { background: var(--primary); border-color: var(--primary); color: white; }
    .btn.primary:hover { background: var(--primary-600); }
    .btn.danger { border-color: transparent; background: rgba(239, 68, 68, 0.12); color: var(--danger); }
    .btn.ghost { border-color: transparent; }
    .btn.icon { width: 30px; justify-content: center; padding: 0; }

    .layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      min-height: 0;
      height: calc(100vh - 50px);
    }

    aside {
      border-right: 1px solid var(--border);
      min-height: 0;
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }

    .aside-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
    }

    .search-input {
      width: 100%;
      height: 30px;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0 10px;
      background: transparent;
      color: var(--text);
    }

    .chapters {
      list-style: none;
      margin: 0;
      padding: 8px;
      overflow-y: auto;
      flex: 1;
    }

    .chapter-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid transparent;
      border-radius: 8px;
      cursor: grab;
      user-select: none;
    }
    .chapter-item:hover { background: var(--bg-elev); }
    .chapter-item.active { background: rgba(59, 130, 246, 0.12); border-color: var(--primary); }
    .chapter-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chapter-actions { display: none; gap: 6px; }
    .chapter-item:hover .chapter-actions { display: inline-flex; }
    .drag-hint { color: var(--muted); font-size: 12px; }

    main {
      min-width: 0;
      min-height: 0;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      position: relative;
    }

    .novel-title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .novel-title {
      font-size: 18px;
      font-weight: 600;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text);
      width: 420px;
      max-width: 60vw;
    }

    .chapter-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-elev);
    }

    .editor {
      padding: 10px 0 0 0;
      min-height: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    .editor-inner {
      width: 100%;
      max-width: var(--editor-max-width);
      padding: 0 20px 16px 20px;
    }

    .chapter-name-input {
      width: 100%;
      font-size: 24px;
      font-weight: 700;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text);
    }

    .content {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px 20px;
      min-height: calc(100% - 80px);
      max-height: calc(100% - 80px);
      overflow: auto;
      line-height: var(--editor-line-height);
      outline: none;
      background: var(--bg-elev);
      font-family: var(--editor-font);
      font-size: var(--editor-size);
      white-space: pre-wrap;
    }
    .content p { margin: 0 0 var(--editor-paragraph-gap) 0; }

    .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 14px;
      border-top: 1px solid var(--border);
      background: var(--bg-elev);
      font-size: 12px;
      color: var(--muted);
      position: sticky;
      bottom: 0;
      z-index: 10;
    }

    .counts { display: flex; gap: 14px; align-items: center; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ok); display: inline-block; }

    .hidden { display: none; }

    /* Drawers & overlays */
    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: min(460px, 90vw);
      background: var(--bg);
      border-left: 1px solid var(--border);
      box-shadow: var(--shadow);
      transform: translateX(100%);
      transition: transform 0.2s ease;
      z-index: 40;
      display: flex;
      flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }
    .drawer header { position: sticky; top: 0; z-index: 1; }
    .drawer-body { padding: 12px; overflow: auto; }

    .toast-wrap {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 50;
      display: grid;
      gap: 8px;
    }
    .toast {
      background: var(--bg-elev);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: var(--shadow);
      font-size: 12px;
    }

    .inline-banner {
      position: sticky;
      top: 0;
      z-index: 15;
      background: rgba(59,130,246,0.1);
      border-bottom: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      display: none;
      align-items: center;
      gap: 12px;
    }
    .inline-banner.show { display: flex; }

    /* Find/replace panel */
    .find-panel {
      position: absolute;
      right: 12px;
      top: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 8px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 25;
    }
    .find-panel input { height: 28px; border: 1px solid var(--border); border-radius: 6px; padding: 0 8px; background: transparent; color: var(--text); }

    /* Immersive/focus/typewriter */
    .immersive aside, .immersive .novel-title-row, .immersive .chapter-toolbar, .immersive .footer { display: none; }
    .immersive .layout { grid-template-columns: 1fr; }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      aside { display: none; }
    }
  </style>
</head>
<body>
  <div id="app" class="app">
    <header>
      <div class="brand">ğŸ“– å°è¯´å†™ä½œåº”ç”¨</div>
      <div class="spacer"></div>
      <button class="btn" id="btn-import" title="å¯¼å…¥JSON">å¯¼å…¥</button>
      <button class="btn" id="btn-export-txt" title="å¯¼å‡ºä¸ºTXT">å¯¼å‡ºTXT</button>
      <button class="btn" id="btn-export-json" title="å¯¼å‡ºä¸ºJSON">å¯¼å‡ºJSON</button>
      <button class="btn" id="btn-find" title="æŸ¥æ‰¾/æ›¿æ¢ (Ctrl+F)">æŸ¥æ‰¾</button>
      <button class="btn" id="btn-history" title="ç‰ˆæœ¬å†å²">å†å²</button>
      <button class="btn" id="btn-trash" title="å›æ”¶ç«™">å›æ”¶ç«™</button>
      <button class="btn" id="btn-prefs" title="åå¥½è®¾ç½®">åå¥½</button>
      <button class="btn" id="btn-theme">åˆ‡æ¢ä¸»é¢˜</button>
      <button class="btn" id="btn-help" title="å¿«æ·é”®">?</button>
    </header>

    <div class="layout">
      <aside>
        <div class="aside-header">
          <input id="chapter-search" class="search-input" placeholder="æœç´¢ç« èŠ‚..." />
          <button id="btn-new-chapter" class="btn primary">æ–°ç« èŠ‚</button>
        </div>
        <ul id="chapter-list" class="chapters" aria-label="ç« èŠ‚åˆ—è¡¨"></ul>
        <div class="drag-hint" style="padding: 6px 12px;">æç¤ºï¼šå¯æ‹–æ‹½ç« èŠ‚è°ƒæ•´é¡ºåº</div>
      </aside>

      <main>
        <div class="inline-banner" id="banner">
          <span id="banner-text">å·²ç§»åŠ¨åˆ°å›æ”¶ç«™</span>
          <button class="btn" id="banner-action">æ’¤é”€</button>
        </div>
        <div class="novel-title-row">
          <input id="novel-title" class="novel-title" placeholder="ä½œå“æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" />
          <div id="save-indicator" class="drag-hint">å·²ä¿å­˜</div>
          <div class="spacer"></div>
          <div class="drag-hint" id="goal-progress"></div>
        </div>

        <div class="chapter-toolbar">
          <button id="btn-rename" class="btn">é‡å‘½å</button>
          <button id="btn-duplicate" class="btn">å¤åˆ¶ç« èŠ‚</button>
          <button id="btn-merge-prev" class="btn">ä¸ä¸Šåˆå¹¶</button>
          <button id="btn-merge-next" class="btn">ä¸ä¸‹åˆå¹¶</button>
          <button id="btn-split" class="btn">åœ¨å…‰æ ‡å¤„åˆ†ç« </button>
          <button id="btn-delete" class="btn danger">ç§»è‡³å›æ”¶ç«™</button>
          <div class="spacer"></div>
          <div id="active-chapter-name" class="drag-hint"></div>
        </div>

        <div class="editor">
          <div class="editor-inner">
            <input id="chapter-name" class="chapter-name-input" placeholder="ç« èŠ‚å" />
            <div id="content" class="content" contenteditable="true" spellcheck="false" placeholder="å¼€å§‹å†™ä½œå§..."></div>
          </div>
        </div>

        <div class="footer">
          <div class="counts">
            <span>æœ¬ç« å­—æ•°ï¼š<strong id="chapter-words">0</strong></span>
            <span>æ€»å­—æ•°ï¼š<strong id="total-words">0</strong></span>
            <span>æœ¬ç« å­—ç¬¦ï¼š<strong id="chapter-chars">0</strong></span>
            <span>é¢„è®¡é˜…è¯»ï¼š<strong id="reading-mins">0</strong> åˆ†é’Ÿ</span>
            <span>ä»Šæ—¥è¿›åº¦ï¼š<strong id="today-words">0</strong></span>
          </div>
          <div>
            <span class="status-dot" title="è‡ªåŠ¨ä¿å­˜çŠ¶æ€"></span>
            <span id="status-text">ç©ºé—²</span>
          </div>
        </div>
      </main>
    </div>
  </div>

  <input id="file-input" type="file" accept="application/json" class="hidden" />

  <!-- Drawers -->
  <section class="drawer" id="drawer-prefs" aria-label="åå¥½è®¾ç½®">
    <header class="aside-header">
      <div class="brand">åå¥½è®¾ç½®</div>
      <div class="spacer"></div>
      <button class="btn" data-close-drawer="drawer-prefs">å…³é—­</button>
    </header>
    <div class="drawer-body">
      <div style="display:grid;gap:12px;">
        <label>å­—ä½“
          <select id="pref-font" class="search-input">
            <option value="sans">æ— è¡¬çº¿</option>
            <option value="serif">è¡¬çº¿</option>
            <option value="mono">ç­‰å®½</option>
          </select>
        </label>
        <label>å­—å·
          <input id="pref-size" type="range" min="14" max="22" value="16" />
        </label>
        <label>è¡Œé«˜
          <input id="pref-line" type="range" min="1.4" max="2.2" step="0.05" value="1.7" />
        </label>
        <label>ç¼–è¾‘å™¨æœ€å¤§å®½åº¦
          <input id="pref-width" type="range" min="600" max="1200" step="10" value="860" />
        </label>
        <label>ç›®æ ‡å­—æ•°
          <input id="pref-goal" type="number" min="0" step="100" placeholder="å¦‚ 2000" class="search-input" />
        </label>
        <label style="display:flex;align-items:center;gap:8px;">
          <input id="pref-immersive" type="checkbox" /> æ²‰æµ¸æ¨¡å¼
        </label>
        <label style="display:flex;align-items:center;gap:8px;">
          <input id="pref-typewriter" type="checkbox" /> æ‰“å­—æœºæ¨¡å¼ï¼ˆä¿æŒå…‰æ ‡å±…ä¸­ï¼‰
        </label>
      </div>
    </div>
  </section>

  <section class="drawer" id="drawer-history" aria-label="ç‰ˆæœ¬å†å²">
    <header class="aside-header">
      <div class="brand">ç‰ˆæœ¬å†å²</div>
      <div class="spacer"></div>
      <button class="btn" id="btn-snapshot">ä¿å­˜å¿«ç…§</button>
      <button class="btn" data-close-drawer="drawer-history">å…³é—­</button>
    </header>
    <div class="drawer-body">
      <div id="history-list" style="display:grid;gap:8px;"></div>
    </div>
  </section>

  <section class="drawer" id="drawer-trash" aria-label="å›æ”¶ç«™">
    <header class="aside-header">
      <div class="brand">å›æ”¶ç«™</div>
      <div class="spacer"></div>
      <button class="btn" id="btn-empty-trash" class="danger">æ¸…ç©º</button>
      <button class="btn" data-close-drawer="drawer-trash">å…³é—­</button>
    </header>
    <div class="drawer-body">
      <div id="trash-list" style="display:grid;gap:8px;"></div>
    </div>
  </section>

  <!-- Find/replace panel -->
  <div class="find-panel" id="find-panel">
    <input id="find-input" placeholder="æŸ¥æ‰¾..." />
    <input id="replace-input" placeholder="æ›¿æ¢ä¸º..." />
    <button class="btn" id="btn-find-prev">ä¸Šä¸€ä¸ª</button>
    <button class="btn" id="btn-find-next">ä¸‹ä¸€ä¸ª</button>
    <button class="btn" id="btn-replace-one">æ›¿æ¢</button>
    <button class="btn" id="btn-replace-all">å…¨éƒ¨æ›¿æ¢</button>
    <button class="btn" id="btn-find-close">å…³é—­</button>
  </div>

  <!-- Toasts -->
  <div class="toast-wrap" id="toast-wrap"></div>

  <!-- Help overlay -->
  <section class="drawer" id="drawer-help" aria-label="å¿«æ·é”®">
    <header class="aside-header">
      <div class="brand">å¿«æ·é”®</div>
      <div class="spacer"></div>
      <button class="btn" data-close-drawer="drawer-help">å…³é—­</button>
    </header>
    <div class="drawer-body">
      <ul>
        <li>Ctrl+Sï¼šä¿å­˜</li>
        <li>Ctrl+Nï¼šæ–°å»ºç« èŠ‚</li>
        <li>Alt+â†‘/â†“ï¼šåˆ‡æ¢ç« èŠ‚</li>
        <li>Ctrl+Fï¼šæŸ¥æ‰¾/æ›¿æ¢</li>
        <li>Ctrl+/ï¼šæ˜¾ç¤ºå¿«æ·é”®</li>
      </ul>
    </div>
  </section>

  <script>
    (function() {
      const STORAGE_KEY = 'novelWriterStateV2';
      const THEME_KEY = 'novelWriterTheme';

      /**
       * @typedef {{ id:string, title:string, content:string, createdAt:number, updatedAt:number, history:Array<{id:string, ts:number, title:string, content:string}>, lastSnapshotTs?:number }} Chapter
       * @typedef {{ novelTitle:string, chapters:Chapter[], activeId:string|null, trash:Chapter[], preferences:any, today:any }} State
       */
      /** @type {State} */
      let state = null;
      let isSaving = false;
      let saveTimer = null;
      let filterKeyword = '';
      let dragFromIndex = null;
      let findState = { index: -1 };
      let pendingUndo = null;

      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));

      const el = {
        chapterList: $('#chapter-list'),
        chapterSearch: $('#chapter-search'),
        newChapter: $('#btn-new-chapter'),
        rename: $('#btn-rename'),
        duplicate: $('#btn-duplicate'),
        mergePrev: $('#btn-merge-prev'),
        mergeNext: $('#btn-merge-next'),
        split: $('#btn-split'),
        del: $('#btn-delete'),
        content: $('#content'),
        chapterName: $('#chapter-name'),
        novelTitle: $('#novel-title'),
        saveIndicator: $('#save-indicator'),
        chapterWords: $('#chapter-words'),
        totalWords: $('#total-words'),
        chapterChars: $('#chapter-chars'),
        readingMins: $('#reading-mins'),
        todayWords: $('#today-words'),
        statusText: $('#status-text'),
        btnImport: $('#btn-import'),
        btnExportTxt: $('#btn-export-txt'),
        btnExportJson: $('#btn-export-json'),
        btnTheme: $('#btn-theme'),
        fileInput: $('#file-input'),
        activeChapterName: $('#active-chapter-name'),
        findPanel: $('#find-panel'),
        findInput: $('#find-input'),
        replaceInput: $('#replace-input'),
        btnFind: $('#btn-find'),
        btnFindPrev: $('#btn-find-prev'),
        btnFindNext: $('#btn-find-next'),
        btnReplaceOne: $('#btn-replace-one'),
        btnReplaceAll: $('#btn-replace-all'),
        btnFindClose: $('#btn-find-close'),
        drawerPrefs: $('#drawer-prefs'),
        drawerHistory: $('#drawer-history'),
        drawerTrash: $('#drawer-trash'),
        drawerHelp: $('#drawer-help'),
        btnPrefs: $('#btn-prefs'),
        btnHistory: $('#btn-history'),
        btnTrash: $('#btn-trash'),
        btnHelp: $('#btn-help'),
        toastWrap: $('#toast-wrap'),
        banner: $('#banner'),
        bannerText: $('#banner-text'),
        bannerAction: $('#banner-action'),
        historyList: $('#history-list'),
        trashList: $('#trash-list'),
        btnEmptyTrash: $('#btn-empty-trash'),
        btnSnapshot: $('#btn-snapshot'),
        goalProgress: $('#goal-progress'),
        // preferences controls
        prefFont: $('#pref-font'),
        prefSize: $('#pref-size'),
        prefLine: $('#pref-line'),
        prefWidth: $('#pref-width'),
        prefGoal: $('#pref-goal'),
        prefImmersive: $('#pref-immersive'),
        prefTypewriter: $('#pref-typewriter'),
      };

      function initTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const dark = saved ? saved === 'dark' : prefersDark;
        document.documentElement.classList.toggle('dark', dark);
      }

      function toggleTheme() {
        const dark = !document.documentElement.classList.contains('dark');
        document.documentElement.classList.toggle('dark', dark);
        localStorage.setItem(THEME_KEY, dark ? 'dark' : 'light');
        showToast(dark ? 'å·²åˆ‡æ¢åˆ°æ·±è‰²ä¸»é¢˜' : 'å·²åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜');
      }

      function generateId(prefix = 'c') {
        return prefix + '_' + Math.random().toString(36).slice(2, 10);
      }

      function defaultState() {
        const firstId = generateId();
        const now = Date.now();
        return {
          novelTitle: '',
          chapters: [
            { id: firstId, title: 'ç¬¬ä¸€ç« ', content: '', createdAt: now, updatedAt: now, history: [] },
          ],
          activeId: firstId,
          trash: [],
          preferences: {
            font: 'sans', size: 16, line: 1.7, width: 860, immersive: false, typewriter: false, goal: 0,
          },
          today: { date: dateKey(now), wordsAdded: 0 },
        };
      }

      function dateKey(ts) { const d = new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

      function migrateV1ToV2(v1) {
        const now = Date.now();
        const chapters = (v1.chapters || []).map(ch => ({ id: ch.id || generateId(), title: ch.title || 'æœªå‘½åç« èŠ‚', content: String(ch.content||''), createdAt: now, updatedAt: now, history: [] }));
        return {
          novelTitle: String(v1.novelTitle||''),
          chapters: chapters.length ? chapters : defaultState().chapters,
          activeId: v1.activeId || (chapters[0] && chapters[0].id),
          trash: [],
          preferences: { font: 'sans', size: 16, line: 1.7, width: 860, immersive: false, typewriter: false, goal: 0 },
          today: { date: dateKey(now), wordsAdded: 0 },
        };
      }

      function loadState() {
        try {
          const rawV2 = localStorage.getItem('novelWriterStateV2');
          if (rawV2) return JSON.parse(rawV2);
          const rawV1 = localStorage.getItem('novelWriterStateV1');
          if (rawV1) return migrateV1ToV2(JSON.parse(rawV1));
          return defaultState();
        } catch (e) {
          console.warn('è§£æå­˜æ¡£å¤±è´¥ï¼Œå·²é‡ç½®', e);
          return defaultState();
        }
      }

      function setStatus(text) { el.statusText.textContent = text; }

      function showToast(text) {
        const d = document.createElement('div');
        d.className = 'toast';
        d.textContent = text;
        el.toastWrap.appendChild(d);
        setTimeout(() => { d.remove(); }, 2000);
      }

      function showBanner(text, actionText, onAction) {
        el.bannerText.textContent = text;
        el.banner.classList.add('show');
        const handler = () => { onAction && onAction(); hideBanner(); };
        el.bannerAction.textContent = actionText || 'ç¡®å®š';
        el.bannerAction.onclick = handler;
        // Auto hide after 6s
        setTimeout(() => hideBanner(), 6000);
      }
      function hideBanner() { el.banner.classList.remove('show'); el.bannerAction.onclick = null; }

      function scheduleSave(reason) {
        if (saveTimer) clearTimeout(saveTimer);
        setStatus('æ­£åœ¨ä¿å­˜â€¦');
        isSaving = true;
        saveTimer = setTimeout(() => {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            el.saveIndicator.textContent = 'å·²ä¿å­˜';
            setStatus('å·²ä¿å­˜');
          } catch (e) {
            console.error('ä¿å­˜å¤±è´¥', e);
            el.saveIndicator.textContent = 'ä¿å­˜å¤±è´¥';
            setStatus('ä¿å­˜å¤±è´¥');
          } finally {
            isSaving = false;
          }
        }, 300);
      }

      function computeWordCount(text) {
        const onlySpaces = (text || '').replace(/\s+/g, '');
        const chineseChars = (onlySpaces.match(/[\u4e00-\u9fa5]/g) || []).length;
        const nonChinese = onlySpaces.replace(/[\u4e00-\u9fa5]/g, ' ').trim();
        const words = nonChinese ? nonChinese.split(/\s+/).length : 0;
        return chineseChars + words;
      }

      function computeStats() {
        const active = getActiveChapter();
        const chapterText = el.content.textContent || '';
        const chapterWords = computeWordCount(chapterText);
        const chapterChars = chapterText.length;
        const totalWords = state.chapters.reduce((sum, ch) => sum + computeWordCount(ch.content), 0);
        const readingMins = Math.max(1, Math.round(totalWords / 500));

        el.chapterWords.textContent = chapterWords;
        el.chapterChars.textContent = chapterChars;
        el.totalWords.textContent = totalWords;
        el.readingMins.textContent = readingMins;
        el.activeChapterName.textContent = active ? `å½“å‰ï¼š${active.title}` : '';

        const todayKey = dateKey(Date.now());
        if (state.today.date !== todayKey) state.today = { date: todayKey, wordsAdded: 0 };
        el.todayWords.textContent = state.today.wordsAdded;

        const g = state.preferences.goal || 0;
        if (g > 0) {
          const pct = Math.min(100, Math.round(state.today.wordsAdded / g * 100));
          el.goalProgress.textContent = `ä»Šæ—¥ç›®æ ‡ ${state.today.wordsAdded}/${g}ï¼ˆ${pct}%ï¼‰`;
        } else {
          el.goalProgress.textContent = '';
        }
      }

      function getActiveChapter() { return state.chapters.find(c => c.id === state.activeId) || null; }

      function setActiveChapter(id) {
        state.activeId = id;
        renderSidebar();
        renderEditor();
        scheduleSave('switch-chapter');
      }

      function renderSidebar() {
        const ul = el.chapterList;
        ul.innerHTML = '';
        const list = state.chapters
          .map((c, idx) => ({...c, idx}))
          .filter(item => !filterKeyword || item.title.toLowerCase().includes(filterKeyword));

        for (const item of list) {
          const li = document.createElement('li');
          li.className = 'chapter-item' + (item.id === state.activeId ? ' active' : '');
          li.draggable = true;
          li.dataset.id = item.id;
          li.dataset.index = String(item.idx);

          const dot = document.createElement('span');
          dot.textContent = 'â‹®â‹®';
          dot.style.opacity = '0.6';
          dot.style.cursor = 'grab';

          const title = document.createElement('div');
          title.className = 'chapter-title';
          title.textContent = item.title || 'æœªå‘½åç« èŠ‚';

          const actions = document.createElement('div');
          actions.className = 'chapter-actions';
          const btnDup = document.createElement('button'); btnDup.className = 'btn ghost'; btnDup.textContent = 'å¤åˆ¶'; btnDup.onclick = (e)=>{e.stopPropagation();duplicateChapter(item.id)};
          const btnDel = document.createElement('button'); btnDel.className = 'btn ghost'; btnDel.textContent = 'åˆ é™¤'; btnDel.onclick = (e)=>{e.stopPropagation();moveToTrash(item.id)};
          actions.append(btnDup, btnDel);

          li.appendChild(dot);
          li.appendChild(title);
          li.appendChild(actions);

          li.addEventListener('click', () => setActiveChapter(item.id));

          li.addEventListener('dragstart', (e) => {
            dragFromIndex = Number(li.dataset.index);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', li.dataset.id);
          });
          li.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            li.style.background = 'rgba(59, 130, 246, 0.16)';
          });
          li.addEventListener('dragleave', () => {
            li.style.background = item.id === state.activeId ? 'rgba(59, 130, 246, 0.12)' : '';
          });
          li.addEventListener('drop', (e) => {
            e.preventDefault();
            li.style.background = item.id === state.activeId ? 'rgba(59, 130, 246, 0.12)' : '';
            const from = dragFromIndex;
            const to = Number(li.dataset.index);
            if (from === null || isNaN(from) || isNaN(to) || from === to) return;
            const arr = state.chapters;
            const [moved] = arr.splice(from, 1);
            arr.splice(to, 0, moved);
            renderSidebar();
            scheduleSave('reorder');
          });

          ul.appendChild(li);
        }
      }

      function renderEditor() {
        const ch = getActiveChapter();
        if (!ch) return;
        el.chapterName.value = ch.title || '';
        el.content.innerHTML = '';
        el.content.textContent = ch.content || '';
        computeStats();
        applyPrefsToVars();
      }

      function addChapter() {
        const id = generateId();
        const idx = state.chapters.length + 1;
        const title = `ç¬¬${idx}ç« `;
        const now = Date.now();
        state.chapters.push({ id, title, content: '', createdAt: now, updatedAt: now, history: [] });
        state.activeId = id;
        renderSidebar();
        renderEditor();
        scheduleSave('add-chapter');
        showToast('å·²åˆ›å»ºæ–°ç« èŠ‚');
      }

      function duplicateChapter(id = null) {
        const srcId = id || state.activeId; const src = state.chapters.find(c=>c.id===srcId); if(!src) return;
        const now = Date.now();
        const dup = { id: generateId(), title: src.title + 'ï¼ˆå‰¯æœ¬ï¼‰', content: src.content, createdAt: now, updatedAt: now, history: [] };
        const idx = state.chapters.findIndex(c=>c.id===srcId);
        state.chapters.splice(idx+1, 0, dup);
        state.activeId = dup.id;
        renderSidebar(); renderEditor(); scheduleSave('duplicate');
        showToast('å·²å¤åˆ¶ç« èŠ‚');
      }

      function renameChapterInline() {
        const active = getActiveChapter(); if (!active) return;
        active.title = el.chapterName.value.trim() || 'æœªå‘½åç« èŠ‚';
        active.updatedAt = Date.now();
        renderSidebar();
        scheduleSave('rename-inline');
      }

      function mergeWithPrev() {
        const idx = state.chapters.findIndex(c=>c.id===state.activeId); if (idx<=0) { showToast('æ— æ³•ä¸ä¸Šä¸€ç« åˆå¹¶'); return; }
        const prev = state.chapters[idx-1]; const cur = state.chapters[idx];
        prev.content = (prev.content + (prev.content?"\n\n":"") + cur.content).trim();
        prev.updatedAt = Date.now();
        state.chapters.splice(idx,1);
        state.activeId = prev.id;
        renderSidebar(); renderEditor(); scheduleSave('merge-prev');
        showToast('å·²ä¸ä¸Šä¸€ç« åˆå¹¶');
      }

      function mergeWithNext() {
        const idx = state.chapters.findIndex(c=>c.id===state.activeId); if (idx<0||idx>=state.chapters.length-1) { showToast('æ— æ³•ä¸ä¸‹ä¸€ç« åˆå¹¶'); return; }
        const cur = state.chapters[idx]; const next = state.chapters[idx+1];
        cur.content = (cur.content + (cur.content?"\n\n":"") + next.content).trim();
        cur.updatedAt = Date.now();
        state.chapters.splice(idx+1,1);
        renderSidebar(); renderEditor(); scheduleSave('merge-next');
        showToast('å·²ä¸ä¸‹ä¸€ç« åˆå¹¶');
      }

      function getCaretIndexInContent() {
        const sel = window.getSelection(); if (!sel || sel.rangeCount===0) return 0;
        const range = sel.getRangeAt(0);
        // Compute index by iterating text nodes
        let index = 0; let found = false;
        function walk(node) {
          if (found) return;
          if (node === range.startContainer) { index += range.startOffset; found = true; return; }
          if (node.nodeType === Node.TEXT_NODE) { index += node.nodeValue.length; }
          else { for (const child of node.childNodes) walk(child); }
        }
        walk(el.content);
        return index;
      }

      function splitAtCursor() {
        const ch = getActiveChapter(); if(!ch) return;
        const idx = getCaretIndexInContent();
        const text = el.content.textContent || '';
        if (idx<=0 || idx>=text.length) { showToast('å°†å…‰æ ‡æ”¾åœ¨éœ€è¦åˆ†ç« çš„ä½ç½®'); return; }
        const left = text.slice(0, idx).trimEnd();
        const right = text.slice(idx).trimStart();
        ch.content = left; ch.updatedAt = Date.now();
        const now = Date.now();
        const newCh = { id: generateId(), title: ch.title + 'ï¼ˆä¸‹ï¼‰', content: right, createdAt: now, updatedAt: now, history: [] };
        const i = state.chapters.findIndex(c=>c.id===ch.id);
        state.chapters.splice(i+1,0,newCh);
        state.activeId = newCh.id;
        renderSidebar(); renderEditor(); scheduleSave('split');
        showToast('å·²åˆ†ç« ');
      }

      function moveToTrash(id = null) {
        const cid = id || state.activeId; const idx = state.chapters.findIndex(c=>c.id===cid); if (idx<0) return;
        const removed = state.chapters.splice(idx,1)[0];
        state.trash.unshift({ ...removed });
        // choose next active
        const next = state.chapters[Math.max(0, idx-1)] || state.chapters[0] || null;
        state.activeId = next ? next.id : null;
        renderSidebar(); renderEditor(); scheduleSave('trash');
        pendingUndo = () => {
          // restore from trash front
          const tIdx = state.trash.findIndex(t=>t.id===removed.id);
          if (tIdx>=0) {
            const restored = state.trash.splice(tIdx,1)[0];
            state.chapters.splice(Math.min(idx, state.chapters.length), 0, restored);
            state.activeId = restored.id;
            renderSidebar(); renderEditor(); scheduleSave('undo-trash');
            showToast('å·²æ’¤é”€åˆ é™¤');
          }
        };
        showBanner(`å·²å°†â€œ${removed.title}â€ç§»è‡³å›æ”¶ç«™`, 'æ’¤é”€', () => pendingUndo && pendingUndo());
      }

      function restoreFromTrash(id) {
        const i = state.trash.findIndex(t=>t.id===id); if(i<0) return;
        const restored = state.trash.splice(i,1)[0];
        state.chapters.push(restored); state.activeId = restored.id;
        renderSidebar(); renderEditor(); scheduleSave('restore');
        showToast('å·²ä»å›æ”¶ç«™æ¢å¤');
      }

      function emptyTrash() {
        state.trash = [];
        renderTrash(); scheduleSave('empty-trash');
        showToast('å›æ”¶ç«™å·²æ¸…ç©º');
      }

      function renderTrash() {
        el.trashList.innerHTML = '';
        if (state.trash.length===0) { el.trashList.textContent = 'å›æ”¶ç«™ä¸ºç©º'; return; }
        for (const ch of state.trash) {
          const row = document.createElement('div');
          row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px';
          const t = document.createElement('div'); t.style.flex='1'; t.textContent = ch.title;
          const b1 = document.createElement('button'); b1.className='btn'; b1.textContent='æ¢å¤'; b1.onclick=()=>restoreFromTrash(ch.id);
          const b2 = document.createElement('button'); b2.className='btn danger'; b2.textContent='å½»åº•åˆ é™¤'; b2.onclick=()=>{ state.trash = state.trash.filter(x=>x.id!==ch.id); renderTrash(); scheduleSave('purge-one'); showToast('å·²åˆ é™¤'); };
          row.append(t,b1,b2); el.trashList.appendChild(row);
        }
      }

      function snapshotNow() {
        const ch = getActiveChapter(); if(!ch) return;
        const snap = { id: generateId('h'), ts: Date.now(), title: ch.title, content: ch.content };
        ch.history.unshift(snap);
        ch.lastSnapshotTs = Date.now();
        scheduleSave('snapshot');
        renderHistory();
        showToast('å·²ä¿å­˜å¿«ç…§');
      }

      function renderHistory() {
        const ch = getActiveChapter(); if(!ch) { el.historyList.textContent='æ— ç« èŠ‚'; return; }
        el.historyList.innerHTML = '';
        if (!ch.history.length) { el.historyList.textContent = 'æš‚æ— å†å²å¿«ç…§'; return; }
        for (const h of ch.history) {
          const row = document.createElement('div');
          row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='8px'; row.style.alignItems='center';
          const ts = new Date(h.ts).toLocaleString();
          const t = document.createElement('div'); t.textContent = `${ts} - ${h.title}`;
          const view = document.createElement('button'); view.className='btn'; view.textContent='æŸ¥çœ‹'; view.onclick=()=>{ el.content.textContent = h.content; ch.content = h.content; renderEditor(); showToast('å·²åŠ è½½å¿«ç…§å†…å®¹ï¼ˆæœªä¿å­˜ï¼‰'); };
          const restore = document.createElement('button'); restore.className='btn primary'; restore.textContent='æ¢å¤'; restore.onclick=()=>{ ch.title = h.title; ch.content = h.content; el.chapterName.value = ch.title; renderEditor(); scheduleSave('restore-snap'); showToast('å·²æ¢å¤åˆ°è¯¥å¿«ç…§'); };
          row.append(t, view, restore); el.historyList.appendChild(row);
        }
      }

      function exportJSON() {
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const title = state.novelTitle ? state.novelTitle : 'novel';
        a.href = url;
        a.download = `${title}.novel.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('å·²å¯¼å‡º JSON');
      }

      function exportTXT() {
        const title = state.novelTitle ? `ã€Š${state.novelTitle}ã€‹\n\n` : '';
        const content = state.chapters.map((c, i) => {
          const header = `ç¬¬${i+1}ç«  ${c.title || ''}`.trim();
          return `${header}\n\n${c.content || ''}`;
        }).join('\n\n\n');
        const blob = new Blob([title + content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (state.novelTitle ? state.novelTitle : 'novel') + '.txt';
        a.click();
        URL.revokeObjectURL(url);
        showToast('å·²å¯¼å‡º TXT');
      }

      function importJSONFile(file) {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(String(reader.result || ''));
            if (!obj || !Array.isArray(obj.chapters)) throw new Error('æ ¼å¼ä¸æ­£ç¡®');
            if (obj.chapters.length === 0) throw new Error('æ²¡æœ‰ç« èŠ‚');
            state = {
              novelTitle: String(obj.novelTitle || ''),
              chapters: obj.chapters.map(ch => ({
                id: String(ch.id || generateId()),
                title: String(ch.title || 'æœªå‘½åç« èŠ‚'),
                content: String(ch.content || ''),
                createdAt: Number(ch.createdAt || Date.now()),
                updatedAt: Number(ch.updatedAt || Date.now()),
                history: Array.isArray(ch.history) ? ch.history : [],
              })),
              activeId: String(obj.activeId || obj.chapters[0].id || obj.chapters[0].title || generateId()),
              trash: Array.isArray(obj.trash) ? obj.trash : [],
              preferences: Object.assign({ font:'sans', size:16, line:1.7, width:860, immersive:false, typewriter:false, goal:0 }, obj.preferences || {}),
              today: obj.today && obj.today.date ? obj.today : { date: dateKey(Date.now()), wordsAdded: 0 },
            };
            renderSidebar();
            renderEditor();
            scheduleSave('import');
            showToast('å¯¼å…¥æˆåŠŸ');
          } catch (e) {
            showToast('å¯¼å…¥å¤±è´¥');
          }
        };
        reader.readAsText(file, 'utf-8');
      }

      function onContentChanged() {
        const active = getActiveChapter(); if (!active) return;
        const beforeLen = active.content.length;
        active.content = el.content.textContent || '';
        active.updatedAt = Date.now();
        const delta = active.content.length - beforeLen;
        if (delta > 0) {
          const todayKey = dateKey(Date.now());
          if (state.today.date !== todayKey) state.today = { date: todayKey, wordsAdded: 0 };
          state.today.wordsAdded += computeWordCount(active.content.slice(Math.max(0, active.content.length - delta)));
        }
        computeStats();
        scheduleSave('edit');
        if (state.preferences.typewriter) centerCaret();
      }

      function centerCaret() {
        const sel = window.getSelection(); if (!sel || sel.rangeCount===0) return;
        const range = sel.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        const containerRect = el.content.getBoundingClientRect();
        if (!rect || !rect.height) return;
        const offset = (rect.top + rect.bottom) / 2 - (containerRect.top + containerRect.bottom) / 2;
        el.content.scrollTop += offset;
      }

      function onChapterNameChanged() { renameChapterInline(); }

      function onNovelTitleChanged() { state.novelTitle = el.novelTitle.value; scheduleSave('title'); }

      function openDrawer(d) { d.classList.add('open'); }
      function closeDrawer(d) { d.classList.remove('open'); }

      function applyPrefsToVars() {
        const p = state.preferences;
        document.documentElement.style.setProperty('--editor-size', p.size + 'px');
        document.documentElement.style.setProperty('--editor-line-height', String(p.line));
        document.documentElement.style.setProperty('--editor-max-width', p.width + 'px');
        if (p.font==='serif') document.documentElement.style.setProperty('--editor-font', 'ui-serif, Georgia, Cambria, "Times New Roman", Times, serif');
        else if (p.font==='mono') document.documentElement.style.setProperty('--editor-font', 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace');
        else document.documentElement.style.setProperty('--editor-font', 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial');
        document.body.classList.toggle('immersive', !!p.immersive);
      }

      function syncPrefsUI() {
        const p = state.preferences;
        el.prefFont.value = p.font;
        el.prefSize.value = p.size;
        el.prefLine.value = p.line;
        el.prefWidth.value = p.width;
        el.prefGoal.value = p.goal || '';
        el.prefImmersive.checked = !!p.immersive;
        el.prefTypewriter.checked = !!p.typewriter;
      }

      function setupEvents() {
        el.newChapter.addEventListener('click', addChapter);
        el.rename.addEventListener('click', () => el.chapterName.focus());
        el.duplicate.addEventListener('click', () => duplicateChapter());
        el.mergePrev.addEventListener('click', mergeWithPrev);
        el.mergeNext.addEventListener('click', mergeWithNext);
        el.split.addEventListener('click', splitAtCursor);
        el.del.addEventListener('click', () => moveToTrash());

        el.btnExportJson.addEventListener('click', exportJSON);
        el.btnExportTxt.addEventListener('click', exportTXT);
        el.btnImport.addEventListener('click', () => el.fileInput.click());
        el.fileInput.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (file) importJSONFile(file);
          e.target.value = '';
        });

        el.chapterSearch.addEventListener('input', () => {
          filterKeyword = el.chapterSearch.value.trim().toLowerCase();
          renderSidebar();
        });

        el.content.addEventListener('input', onContentChanged);
        el.chapterName.addEventListener('input', onChapterNameChanged);
        el.novelTitle.addEventListener('input', onNovelTitleChanged);

        el.btnTheme.addEventListener('click', toggleTheme);

        // Drawers
        el.btnPrefs.addEventListener('click', () => { syncPrefsUI(); openDrawer(el.drawerPrefs); });
        el.btnHistory.addEventListener('click', () => { renderHistory(); openDrawer(el.drawerHistory); });
        el.btnTrash.addEventListener('click', () => { renderTrash(); openDrawer(el.drawerTrash); });
        el.btnHelp.addEventListener('click', () => openDrawer(el.drawerHelp));
        $$('[data-close-drawer]').forEach(b=> b.addEventListener('click', (e)=>{ const id = e.currentTarget.getAttribute('data-close-drawer'); const d = document.getElementById(id); if(d) closeDrawer(d); }));

        el.btnEmptyTrash.addEventListener('click', emptyTrash);
        el.btnSnapshot.addEventListener('click', snapshotNow);

        // Find/replace
        function toggleFind(show) { el.findPanel.style.display = show ? 'flex' : 'none'; if (show) el.findInput.focus(); }
        el.btnFind.addEventListener('click', () => toggleFind(el.findPanel.style.display!== 'flex'));
        el.btnFindClose.addEventListener('click', () => toggleFind(false));
        el.btnFindNext.addEventListener('click', () => findNext());
        el.btnFindPrev.addEventListener('click', () => findPrev());
        el.btnReplaceOne.addEventListener('click', () => replaceOne());
        el.btnReplaceAll.addEventListener('click', () => replaceAll());

        // Prefs change
        el.prefFont.addEventListener('change', () => { state.preferences.font = el.prefFont.value; applyPrefsToVars(); scheduleSave('pref-font'); });
        el.prefSize.addEventListener('input', () => { state.preferences.size = Number(el.prefSize.value); applyPrefsToVars(); scheduleSave('pref-size'); });
        el.prefLine.addEventListener('input', () => { state.preferences.line = Number(el.prefLine.value); applyPrefsToVars(); scheduleSave('pref-line'); });
        el.prefWidth.addEventListener('input', () => { state.preferences.width = Number(el.prefWidth.value); applyPrefsToVars(); scheduleSave('pref-width'); });
        el.prefGoal.addEventListener('input', () => { state.preferences.goal = Number(el.prefGoal.value||0); computeStats(); scheduleSave('pref-goal'); });
        el.prefImmersive.addEventListener('change', () => { state.preferences.immersive = el.prefImmersive.checked; applyPrefsToVars(); scheduleSave('pref-immersive'); });
        el.prefTypewriter.addEventListener('change', () => { state.preferences.typewriter = el.prefTypewriter.checked; scheduleSave('pref-typewriter'); });

        document.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); scheduleSave('shortcut'); showToast('å·²ä¿å­˜'); }
          if ((e.altKey || e.metaKey) && e.key === 'ArrowDown') { e.preventDefault(); const idx = state.chapters.findIndex(c => c.id === state.activeId); const next = state.chapters[idx + 1]; if (next) setActiveChapter(next.id); }
          if ((e.altKey || e.metaKey) && e.key === 'ArrowUp') { e.preventDefault(); const idx = state.chapters.findIndex(c => c.id === state.activeId); const prev = state.chapters[idx - 1]; if (prev) setActiveChapter(prev.id); }
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') { e.preventDefault(); addChapter(); }
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') { e.preventDefault(); el.findPanel.style.display==='flex' ? el.findInput.focus() : (el.findPanel.style.display='flex', el.findInput.focus()); }
          if ((e.ctrlKey || e.metaKey) && e.key === '/') { e.preventDefault(); openDrawer(el.drawerHelp); }
        });

        window.addEventListener('beforeunload', () => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch {} });
      }

      function findNext() { findCore(1); }
      function findPrev() { findCore(-1); }
      function findCore(dir) {
        const text = el.content.textContent || '';
        const q = el.findInput.value || '';
        if (!q) return;
        const idx = (findState.index < 0 ? -dir : findState.index) + dir;
        const nextIndex = searchIndex(text, q, idx, dir);
        if (nextIndex >= 0) { selectRangeInContent(nextIndex, q.length); findState.index = nextIndex; showToast(`å·²å®šä½ (${nextIndex+1})`); }
        else { showToast('æ²¡æœ‰æ›´å¤šç»“æœ'); }
      }
      function searchIndex(text, q, from, dir) {
        if (dir > 0) return text.toLowerCase().indexOf(q.toLowerCase(), Math.max(0, from));
        // backwards
        const sub = text.toLowerCase().slice(0, Math.max(0, from));
        return sub.lastIndexOf(q.toLowerCase());
      }
      function selectRangeInContent(start, length) {
        const range = document.createRange();
        let pos = 0; let foundStart = null; let foundNode = null;
        function walk(node) {
          if (foundNode) return;
          if (node.nodeType === Node.TEXT_NODE) {
            const len = node.nodeValue.length;
            if (pos + len >= start && foundStart === null) {
              foundStart = { node, offset: start - pos };
            }
            if (foundStart && pos + len >= start + length) {
              foundNode = { node, offset: start + length - pos };
            }
            pos += len;
          } else {
            for (const child of node.childNodes) walk(child);
          }
        }
        walk(el.content);
        if (foundStart && foundNode) {
          range.setStart(foundStart.node, foundStart.offset);
          range.setEnd(foundNode.node, foundNode.offset);
          const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
          el.content.focus();
        }
      }
      function replaceOne() {
        const q = el.findInput.value || ''; if (!q) return;
        const r = el.replaceInput.value || '';
        const text = el.content.textContent || '';
        const start = findState.index >= 0 ? findState.index : text.toLowerCase().indexOf(q.toLowerCase());
        if (start < 0) { showToast('æœªæ‰¾åˆ°'); return; }
        const before = text.slice(0, start);
        const after = text.slice(start + q.length);
        el.content.textContent = before + r + after;
        onContentChanged();
        findState.index = start + r.length; // next search from here
        selectRangeInContent(findState.index, 0);
      }
      function replaceAll() {
        const q = el.findInput.value || ''; if (!q) return;
        const r = el.replaceInput.value || '';
        const text = el.content.textContent || '';
        const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        const replaced = text.replace(re, r);
        el.content.textContent = replaced;
        onContentChanged();
        showToast('å·²å…¨éƒ¨æ›¿æ¢');
        findState.index = -1;
      }

      function boot() {
        initTheme();
        state = loadState();
        renderSidebar();
        renderEditor();
        setupEvents();
        applyPrefsToVars();
        setStatus('å·²å°±ç»ª');
      }

      boot();
    })();
  </script>
</body>
</html>