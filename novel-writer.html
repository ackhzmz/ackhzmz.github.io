<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>小说写作应用 - 本地版</title>
  <style>
    :root {
      --bg: #ffffff;
      --bg-elev: #f6f7f9;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #3b82f6;
      --primary-600: #2563eb;
      --border: #e5e7eb;
      --danger: #ef4444;
      --ok: #16a34a;
      --shadow: 0 1px 2px rgba(0,0,0,0.05), 0 4px 16px rgba(0,0,0,0.06);
    }
    .dark {
      --bg: #0b0f14;
      --bg-elev: #121821;
      --text: #e5e7eb;
      --muted: #93a4b7;
      --primary: #60a5fa;
      --primary-600: #93c5fd;
      --border: #1f2a37;
      --danger: #f87171;
      --ok: #34d399;
      --shadow: 0 1px 2px rgba(255,255,255,0.04), 0 4px 16px rgba(255,255,255,0.03);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }

    .app {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-elev);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .brand {
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .spacer { flex: 1; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      height: 32px;
      padding: 0 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text);
      cursor: pointer;
    }
    .btn:hover { background: var(--bg-elev); }
    .btn.primary { background: var(--primary); border-color: var(--primary); color: white; }
    .btn.primary:hover { background: var(--primary-600); }
    .btn.danger { border-color: transparent; background: rgba(239, 68, 68, 0.12); color: var(--danger); }
    .btn.ghost { border-color: transparent; }

    .layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      min-height: 0;
      height: calc(100vh - 58px);
    }

    aside {
      border-right: 1px solid var(--border);
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .aside-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
    }

    .search-input {
      width: 100%;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0 10px;
      background: transparent;
      color: var(--text);
    }

    .chapters {
      list-style: none;
      margin: 0;
      padding: 8px;
      overflow-y: auto;
      flex: 1;
    }

    .chapter-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 10px;
      border: 1px solid transparent;
      border-radius: 8px;
      cursor: grab;
      user-select: none;
    }
    .chapter-item:hover { background: var(--bg-elev); }
    .chapter-item.active { background: rgba(59, 130, 246, 0.12); border-color: var(--primary); }
    .chapter-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .drag-hint { color: var(--muted); font-size: 12px; }

    main {
      min-width: 0;
      min-height: 0;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
    }

    .novel-title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    .novel-title {
      font-size: 18px;
      font-weight: 600;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text);
      width: 420px;
      max-width: 60vw;
    }

    .chapter-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
    }

    .editor {
      padding: 10px 16px 16px 16px;
      min-height: 0;
      overflow: hidden;
    }

    .chapter-name-input {
      width: 100%;
      font-size: 22px;
      font-weight: 700;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text);
    }

    .content {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      min-height: calc(100% - 80px);
      max-height: calc(100% - 80px);
      overflow: auto;
      line-height: 1.7;
      outline: none;
      background: var(--bg-elev);
    }

    .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 14px;
      border-top: 1px solid var(--border);
      background: var(--bg-elev);
      font-size: 12px;
      color: var(--muted);
    }

    .counts { display: flex; gap: 14px; align-items: center; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ok); display: inline-block; }

    .hidden { display: none; }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      aside { display: none; }
    }
  </style>
</head>
<body>
  <div id="app" class="app">
    <header>
      <div class="brand">📖 小说写作应用</div>
      <div class="spacer"></div>
      <button class="btn" id="btn-import">导入JSON</button>
      <button class="btn" id="btn-export-txt">导出TXT</button>
      <button class="btn" id="btn-export-json">导出JSON</button>
      <button class="btn" id="btn-theme">切换主题</button>
    </header>

    <div class="layout">
      <aside>
        <div class="aside-header">
          <input id="chapter-search" class="search-input" placeholder="搜索章节..." />
          <button id="btn-new-chapter" class="btn primary">新章节</button>
        </div>
        <ul id="chapter-list" class="chapters" aria-label="章节列表"></ul>
        <div class="drag-hint" style="padding: 6px 12px;">提示：可拖拽章节调整顺序</div>
      </aside>

      <main>
        <div class="novel-title-row">
          <input id="novel-title" class="novel-title" placeholder="作品标题（可选）" />
          <div id="save-indicator" class="drag-hint">已保存</div>
        </div>

        <div class="chapter-toolbar">
          <button id="btn-rename" class="btn">重命名章节</button>
          <button id="btn-delete" class="btn danger">删除章节</button>
          <div class="spacer"></div>
          <div id="active-chapter-name" class="drag-hint"></div>
        </div>

        <div class="editor">
          <input id="chapter-name" class="chapter-name-input" placeholder="章节名" />
          <div id="content" class="content" contenteditable="true" spellcheck="false" placeholder="开始写作吧..."></div>
        </div>

        <div class="footer">
          <div class="counts">
            <span>本章字数：<strong id="chapter-words">0</strong></span>
            <span>总字数：<strong id="total-words">0</strong></span>
            <span>本章字符：<strong id="chapter-chars">0</strong></span>
            <span>预计阅读：<strong id="reading-mins">0</strong> 分钟</span>
          </div>
          <div>
            <span class="status-dot" title="自动保存状态"></span>
            <span id="status-text">空闲</span>
          </div>
        </div>
      </main>
    </div>
  </div>

  <input id="file-input" type="file" accept="application/json" class="hidden" />

  <script>
    (function() {
      const STORAGE_KEY = 'novelWriterStateV1';
      const THEME_KEY = 'novelWriterTheme';

      /** @type {{ novelTitle: string, chapters: Array<{id:string,title:string,content:string}>, activeId: string|null }} */
      let state = null;
      let isSaving = false;
      let saveTimer = null;
      let filterKeyword = '';
      let dragFromIndex = null;

      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));

      const el = {
        chapterList: $('#chapter-list'),
        chapterSearch: $('#chapter-search'),
        newChapter: $('#btn-new-chapter'),
        rename: $('#btn-rename'),
        del: $('#btn-delete'),
        content: $('#content'),
        chapterName: $('#chapter-name'),
        novelTitle: $('#novel-title'),
        saveIndicator: $('#save-indicator'),
        chapterWords: $('#chapter-words'),
        totalWords: $('#total-words'),
        chapterChars: $('#chapter-chars'),
        readingMins: $('#reading-mins'),
        statusText: $('#status-text'),
        btnImport: $('#btn-import'),
        btnExportTxt: $('#btn-export-txt'),
        btnExportJson: $('#btn-export-json'),
        btnTheme: $('#btn-theme'),
        fileInput: $('#file-input'),
        activeChapterName: $('#active-chapter-name'),
      };

      function initTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const dark = saved ? saved === 'dark' : prefersDark;
        document.documentElement.classList.toggle('dark', dark);
      }

      function toggleTheme() {
        const dark = !document.documentElement.classList.contains('dark');
        document.documentElement.classList.toggle('dark', dark);
        localStorage.setItem(THEME_KEY, dark ? 'dark' : 'light');
      }

      function generateId() {
        return 'c_' + Math.random().toString(36).slice(2, 10);
      }

      function defaultState() {
        const firstId = generateId();
        return {
          novelTitle: '',
          chapters: [
            { id: firstId, title: '第一章', content: '' },
          ],
          activeId: firstId,
        };
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return defaultState();
          const parsed = JSON.parse(raw);
          if (!parsed.chapters || !Array.isArray(parsed.chapters) || parsed.chapters.length === 0) {
            return defaultState();
          }
          return parsed;
        } catch (e) {
          console.warn('解析存档失败，已重置', e);
          return defaultState();
        }
      }

      function setStatus(text) {
        el.statusText.textContent = text;
      }

      function scheduleSave(reason) {
        if (saveTimer) clearTimeout(saveTimer);
        setStatus('正在保存…');
        isSaving = true;
        saveTimer = setTimeout(() => {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            el.saveIndicator.textContent = '已保存';
            setStatus('已保存');
          } catch (e) {
            console.error('保存失败', e);
            el.saveIndicator.textContent = '保存失败';
            setStatus('保存失败');
          } finally {
            isSaving = false;
          }
        }, 300);
      }

      function computeWordCount(text) {
        // 中文按字符计数，英文按单词分隔
        const onlySpaces = (text || '').replace(/\s+/g, '');
        const chineseChars = (onlySpaces.match(/[\u4e00-\u9fa5]/g) || []).length;
        const nonChinese = onlySpaces.replace(/[\u4e00-\u9fa5]/g, ' ').trim();
        const words = nonChinese ? nonChinese.split(/\s+/).length : 0;
        return chineseChars + words;
      }

      function computeStats() {
        const active = getActiveChapter();
        const chapterText = el.content.textContent || '';
        const chapterWords = computeWordCount(chapterText);
        const chapterChars = chapterText.length;
        const totalWords = state.chapters.reduce((sum, ch) => sum + computeWordCount(ch.content), 0);
        const readingMins = Math.max(1, Math.round(totalWords / 500)); // 粗略估计：500字/分钟

        el.chapterWords.textContent = chapterWords;
        el.chapterChars.textContent = chapterChars;
        el.totalWords.textContent = totalWords;
        el.readingMins.textContent = readingMins;
        el.activeChapterName.textContent = active ? `当前：${active.title}` : '';
      }

      function getActiveChapter() {
        return state.chapters.find(c => c.id === state.activeId) || null;
      }

      function setActiveChapter(id) {
        state.activeId = id;
        renderSidebar();
        renderEditor();
        scheduleSave('switch-chapter');
      }

      function renderSidebar() {
        const ul = el.chapterList;
        ul.innerHTML = '';
        const list = state.chapters
          .map((c, idx) => ({...c, idx}))
          .filter(item => !filterKeyword || item.title.toLowerCase().includes(filterKeyword));

        for (const item of list) {
          const li = document.createElement('li');
          li.className = 'chapter-item' + (item.id === state.activeId ? ' active' : '');
          li.draggable = true;
          li.dataset.id = item.id;
          li.dataset.index = String(item.idx);

          const dot = document.createElement('span');
          dot.textContent = '⋮⋮';
          dot.style.opacity = '0.6';
          dot.style.cursor = 'grab';

          const title = document.createElement('div');
          title.className = 'chapter-title';
          title.textContent = item.title || '未命名章节';

          li.appendChild(dot);
          li.appendChild(title);

          li.addEventListener('click', () => setActiveChapter(item.id));

          li.addEventListener('dragstart', (e) => {
            dragFromIndex = Number(li.dataset.index);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', li.dataset.id);
          });
          li.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            li.style.background = 'rgba(59, 130, 246, 0.16)';
          });
          li.addEventListener('dragleave', () => {
            li.style.background = item.id === state.activeId ? 'rgba(59, 130, 246, 0.12)' : '';
          });
          li.addEventListener('drop', (e) => {
            e.preventDefault();
            li.style.background = item.id === state.activeId ? 'rgba(59, 130, 246, 0.12)' : '';
            const from = dragFromIndex;
            const to = Number(li.dataset.index);
            if (from === null || isNaN(from) || isNaN(to) || from === to) return;
            const arr = state.chapters;
            const [moved] = arr.splice(from, 1);
            arr.splice(to, 0, moved);
            renderSidebar();
            scheduleSave('reorder');
          });

          ul.appendChild(li);
        }
      }

      function renderEditor() {
        const ch = getActiveChapter();
        if (!ch) return;
        el.chapterName.value = ch.title || '';
        el.content.innerHTML = '';
        // 保留换行
        el.content.textContent = ch.content || '';
        computeStats();
      }

      function addChapter() {
        const id = generateId();
        const idx = state.chapters.length + 1;
        const title = `第${idx}章`;
        state.chapters.push({ id, title, content: '' });
        state.activeId = id;
        renderSidebar();
        renderEditor();
        scheduleSave('add-chapter');
      }

      function renameChapter() {
        const active = getActiveChapter();
        if (!active) return;
        const name = prompt('输入新的章节名：', active.title || '');
        if (name === null) return;
        active.title = name.trim() || '未命名章节';
        el.chapterName.value = active.title;
        renderSidebar();
        scheduleSave('rename');
      }

      function deleteChapter() {
        const active = getActiveChapter();
        if (!active) return;
        if (state.chapters.length <= 1) {
          alert('至少保留一个章节。');
          return;
        }
        if (!confirm(`确认删除章节：“${active.title}”？`)) return;
        const idx = state.chapters.findIndex(c => c.id === active.id);
        state.chapters.splice(idx, 1);
        const next = state.chapters[Math.max(0, idx - 1)] || state.chapters[0];
        state.activeId = next.id;
        renderSidebar();
        renderEditor();
        scheduleSave('delete');
      }

      function exportJSON() {
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const title = state.novelTitle ? state.novelTitle : 'novel';
        a.href = url;
        a.download = `${title}.novel.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function exportTXT() {
        const title = state.novelTitle ? `《${state.novelTitle}》\n\n` : '';
        const content = state.chapters.map((c, i) => {
          const header = `第${i+1}章 ${c.title || ''}`.trim();
          return `${header}\n\n${c.content || ''}`;
        }).join('\n\n\n');
        const blob = new Blob([title + content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (state.novelTitle ? state.novelTitle : 'novel') + '.txt';
        a.click();
        URL.revokeObjectURL(url);
      }

      function importJSONFile(file) {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(String(reader.result || ''));
            if (!obj || !Array.isArray(obj.chapters)) throw new Error('格式不正确');
            if (obj.chapters.length === 0) throw new Error('没有章节');
            state = {
              novelTitle: String(obj.novelTitle || ''),
              chapters: obj.chapters.map(ch => ({
                id: String(ch.id || generateId()),
                title: String(ch.title || '未命名章节'),
                content: String(ch.content || ''),
              })),
              activeId: String(obj.activeId || obj.chapters[0].id || obj.chapters[0].title || generateId()),
            };
            renderSidebar();
            renderEditor();
            scheduleSave('import');
            alert('导入成功');
          } catch (e) {
            alert('导入失败：' + e.message);
          }
        };
        reader.readAsText(file, 'utf-8');
      }

      function onContentChanged() {
        const active = getActiveChapter();
        if (!active) return;
        active.content = el.content.textContent || '';
        computeStats();
        scheduleSave('edit');
      }

      function onChapterNameChanged() {
        const active = getActiveChapter();
        if (!active) return;
        active.title = el.chapterName.value;
        renderSidebar();
        computeStats();
        scheduleSave('rename-inline');
      }

      function onNovelTitleChanged() {
        state.novelTitle = el.novelTitle.value;
        scheduleSave('title');
      }

      function setupEvents() {
        el.newChapter.addEventListener('click', addChapter);
        el.rename.addEventListener('click', renameChapter);
        el.del.addEventListener('click', deleteChapter);

        el.btnExportJson.addEventListener('click', exportJSON);
        el.btnExportTxt.addEventListener('click', exportTXT);
        el.btnImport.addEventListener('click', () => el.fileInput.click());
        el.fileInput.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (file) importJSONFile(file);
          e.target.value = '';
        });

        el.chapterSearch.addEventListener('input', () => {
          filterKeyword = el.chapterSearch.value.trim().toLowerCase();
          renderSidebar();
        });

        el.content.addEventListener('input', onContentChanged);
        el.chapterName.addEventListener('input', onChapterNameChanged);
        el.novelTitle.addEventListener('input', onNovelTitleChanged);

        el.btnTheme.addEventListener('click', toggleTheme);

        document.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
            e.preventDefault();
            scheduleSave('shortcut');
          }
          if ((e.altKey || e.metaKey) && e.key === 'ArrowDown') {
            e.preventDefault();
            const idx = state.chapters.findIndex(c => c.id === state.activeId);
            const next = state.chapters[idx + 1];
            if (next) setActiveChapter(next.id);
          }
          if ((e.altKey || e.metaKey) && e.key === 'ArrowUp') {
            e.preventDefault();
            const idx = state.chapters.findIndex(c => c.id === state.activeId);
            const prev = state.chapters[idx - 1];
            if (prev) setActiveChapter(prev.id);
          }
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') {
            e.preventDefault();
            addChapter();
          }
        });

        window.addEventListener('beforeunload', () => {
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch {}
        });
      }

      function boot() {
        initTheme();
        state = loadState();
        renderSidebar();
        renderEditor();
        setupEvents();
        setStatus('已就绪');
      }

      boot();
    })();
  </script>
</body>
</html>